<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student List | IntellEvalPro</title>
  
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/nclogo.png') }}">
  <link rel="shortcut icon" type="image/png" href="{{ url_for('static', filename='images/nclogo.png') }}">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='images/nclogo.png') }}">
  
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  
  <!-- SweetAlert2 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.12/dist/sweetalert2.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.12/dist/sweetalert2.all.min.js"></script>
  
  <script>
    tailwind.config = {
      theme: {
        fontFamily: {
          'sans': ['Inter', 'system-ui', 'sans-serif'],
        },
        extend: {
          colors: {
            primary: {
              50: '#e6f0ff',
              100: '#b3d1ff',
              200: '#80b3ff',
              300: '#4d94ff', 
              400: '#1a75ff',
              500: '#0059cc', // Primary color
              600: '#004db3',
              700: '#004099',
              800: '#003380',
              900: '#002766',
            }
          }
        }
      }
    }
  </script>
  
  <style>
    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }
    
    /* Active nav link */
    .nav-link.active {
      position: relative;
    }
    
    .nav-link.active::after {
      content: '';
      position: absolute;
      left: 0;
      width: 4px;
      height: 100%;
      background-color: #0059cc;
      border-radius: 0 2px 2px 0;
    }
    
    /* Ensure Font Awesome icons render properly */
    .fas, .far, .fab {
      font-family: "Font Awesome 6 Free", "Font Awesome 6 Pro", "Font Awesome 6 Brands", sans-serif !important;
      font-weight: 900;
      -webkit-font-smoothing: antialiased;
      display: inline-block;
    }
    
    /* Custom select arrow hide */
    select {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
    }
    
    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }
    
    /* Smooth transitions for filter animations */
    .filter-tag-enter {
      opacity: 0;
      transform: scale(0.8);
    }
    
    .filter-tag-enter-active {
      opacity: 1;
      transform: scale(1);
      transition: opacity 0.2s ease, transform 0.2s ease;
    }
    
    /* SweetAlert2 custom styling for form inputs */
    .swal2-input, .swal2-select {
      margin: 0 !important;
      padding: 0.5rem 0.75rem !important;
      font-size: 0.875rem !important;
      border: 1px solid #d1d5db !important;
      border-radius: 0.5rem !important;
    }
    
    .swal2-textarea {
      margin: 0 !important;
      padding: 0.5rem 0.75rem !important;
      font-size: 0.875rem !important;
      border: 1px solid #d1d5db !important;
      border-radius: 0.5rem !important;
    }
    
    .swal2-input:focus, .swal2-select:focus, .swal2-textarea:focus {
      border-color: #0059cc !important;
      box-shadow: 0 0 0 3px rgba(0, 89, 204, 0.1) !important;
    }
    
    .swal2-html-container-custom {
      overflow-y: auto;
      max-height: 600px;
    }
    
    /* Responsive modal width constraints */
    .swal2-popup {
      max-width: 700px !important;
      width: 90% !important;
    }
    
    @media (max-width: 640px) {
      .swal2-popup {
        width: 95% !important;
        margin: 1rem;
      }
      
      .swal2-title {
        font-size: 1.25rem !important;
      }
      
      /* Ensure buttons stack on very small screens */
      .swal2-actions {
        flex-wrap: wrap;
        gap: 0.5rem;
      }
      
      .swal2-styled {
        min-width: 120px !important;
      }
    }
    
    /* Mobile table improvements */
    @media (max-width: 768px) {
      /* Reduce table padding on mobile */
      table th,
      table td {
        padding-left: 0.75rem !important;
        padding-right: 0.75rem !important;
      }
      
      /* Make badges smaller on mobile */
      .student-row span {
        font-size: 0.7rem !important;
        padding: 0.25rem 0.5rem !important;
      }
    }
    
    /* Custom scrollbar for evaluation list in modal */
    #evaluations-list {
      scrollbar-width: thin;
      scrollbar-color: #cbd5e0 #f7fafc;
    }
    
    #evaluations-list::-webkit-scrollbar {
      width: 8px;
    }
    
    #evaluations-list::-webkit-scrollbar-track {
      background: #f7fafc;
      border-radius: 4px;
    }
    
    #evaluations-list::-webkit-scrollbar-thumb {
      background: #cbd5e0;
      border-radius: 4px;
    }
    
    #evaluations-list::-webkit-scrollbar-thumb:hover {
      background: #a0aec0;
    }
    
    /* Smooth checkbox transitions */
    .subject-checkbox {
      transition: all 0.15s ease;
    }
    
    .subject-checkbox:checked {
      background-color: #0059cc;
      border-color: #0059cc;
    }
  </style>
</head>
<body class="bg-gray-50 font-sans overflow-x-hidden">
  <!-- Loading overlay -->
  <div id="loader-overlay" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-white bg-opacity-90 backdrop-blur-sm transition-opacity duration-300">
    <img src="{{ url_for('static', filename='images/nclogo.png') }}" alt="Logo" class="w-32 h-auto mb-6 animate-bounce">
    <div class="flex items-center space-x-2">
      <div class="w-3 h-3 rounded-full bg-primary-500 animate-pulse"></div>
      <div class="w-3 h-3 rounded-full bg-primary-500 animate-pulse" style="animation-delay: 0.2s"></div>
      <div class="w-3 h-3 rounded-full bg-primary-500 animate-pulse" style="animation-delay: 0.4s"></div>
    </div>
  </div>

  <div class="flex h-screen bg-gray-50">
    <!-- Sidebar (will be loaded dynamically) -->
    <div id="admin-sidebar"></div>
    
    <!-- Main content -->
    <div class="lg:ml-64 flex flex-col flex-1 min-h-screen">
      <!-- Top Navigation (will be loaded dynamically) -->
      <div id="admin-header"></div>

      <!-- Main content area -->
      <main id="main-content" class="flex-1 overflow-auto p-4 md:p-6 bg-gray-50">
    <!-- Page header -->
    <div class="mb-6">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
        <div>
          <h1 class="text-xl sm:text-2xl font-bold text-gray-800">Student List</h1>
          <p class="text-sm sm:text-base text-gray-500 mt-1">View students and their information</p>
        </div>
        <div class="sm:mt-0">
          <button type="button" id="add-student-btn" class="w-full sm:w-auto inline-flex items-center justify-center px-4 py-2.5 bg-primary-600 hover:bg-primary-700 text-white text-sm font-medium rounded-lg shadow-sm transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 min-h-[44px]">
            <i class="fas fa-plus mr-2"></i>
            Add Student
          </button>
        </div>
      </div>
    </div>

    <!-- Filters were moved below the statistics cards for better mobile layout -->

    <!-- Student Statistics Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
      <div class="bg-white rounded-lg shadow-sm p-4 hover:shadow-md transition-all">
        <div class="flex items-center">
          <div class="flex-shrink-0 h-12 w-12 rounded-full bg-blue-100 flex items-center justify-center text-blue-600">
            <i class="fas fa-user-graduate text-xl"></i>
          </div>
          <div class="ml-4">
            <h2 id="total-students" class="text-xl font-bold text-gray-800">--</h2>
            <p class="text-sm text-gray-500">Total Students</p>
          </div>
        </div>
      </div>
      <div class="bg-white rounded-lg shadow-sm p-4 hover:shadow-md transition-all">
        <div class="flex items-center">
          <div class="flex-shrink-0 h-12 w-12 rounded-full bg-green-100 flex items-center justify-center text-green-600">
            <i class="fas fa-check-circle text-xl"></i>
          </div>
          <div class="ml-4">
            <h2 id="active-students" class="text-xl font-bold text-gray-800">--</h2>
            <p class="text-sm text-gray-500">Active Students</p>
          </div>
        </div>
      </div>
      <div class="bg-white rounded-lg shadow-sm p-4 hover:shadow-md transition-all">
        <div class="flex items-center">
          <div class="flex-shrink-0 h-12 w-12 rounded-full bg-yellow-100 flex items-center justify-center text-yellow-600">
            <i class="fas fa-graduation-cap text-xl"></i>
          </div>
          <div class="ml-4">
            <h2 id="total-programs" class="text-xl font-bold text-gray-800">--</h2>
            <p class="text-sm text-gray-500">Department</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Modern Filters and search section -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-6">
      <!-- Filter Header -->
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center space-x-2">
          <div class="w-2 h-2 bg-primary-500 rounded-full"></div>
          <h3 class="text-lg font-semibold text-gray-800">Filter Students</h3>
        </div>
        <span id="results-count" class="text-sm text-gray-500 bg-gray-50 px-3 py-1 rounded-full">-- results</span>
      </div>
      
      <!-- Search and Filters Grid -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-12 gap-4">
        <!-- Search Input -->
        <div class="md:col-span-2 lg:col-span-4">
          <label for="search-student" class="block text-sm font-medium text-gray-700 mb-2">Search Students</label>
          <div class="relative group">
            <div class="absolute inset-y-0 left-0 flex items-center pl-4 pointer-events-none">
              <i class="fas fa-search text-gray-400 group-focus-within:text-primary-500 transition-colors duration-200" aria-hidden="true"></i>
            </div>
            <input type="text" id="search-student" placeholder="Search by name or student number..." 
                   class="block w-full pl-11 pr-4 py-3 text-sm border border-gray-200 rounded-xl bg-gray-50 text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent focus:bg-white transition-all duration-200" 
                   autocomplete="off">
          </div>
        </div>
        
        <!-- Program Filter -->
        <div class="md:col-span-2 lg:col-span-3">
          <label for="program-filter" class="block text-sm font-medium text-gray-700 mb-2">Department</label>
          <div class="relative">
            <select id="program-filter" class="block w-full px-4 py-3 text-sm border border-gray-200 rounded-xl bg-gray-50 text-gray-900 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent focus:bg-white transition-all duration-200 appearance-none cursor-pointer">
              <option value="">All Departments</option>
              <!-- Program options will be loaded dynamically -->
            </select>
            <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
              <i class="fas fa-chevron-down text-gray-400 text-xs"></i>
            </div>
          </div>
        </div>
        
        <!-- Year Level Filter -->
        <div class="lg:col-span-2">
          <label for="year-filter" class="block text-sm font-medium text-gray-700 mb-2">Year Level</label>
          <div class="relative">
            <select id="year-filter" class="block w-full px-4 py-3 text-sm border border-gray-200 rounded-xl bg-gray-50 text-gray-900 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent focus:bg-white transition-all duration-200 appearance-none cursor-pointer">
              <option value="">All Years</option>
              <option value="1st Year">1st Year</option>
              <option value="2nd Year">2nd Year</option>
              <option value="3rd Year">3rd Year</option>
              <option value="4th Year">4th Year</option>

            </select>
            <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
              <i class="fas fa-chevron-down text-gray-400 text-xs"></i>
            </div>
          </div>
        </div>
        
        <!-- Status Filter -->
        <div class="lg:col-span-2">
          <label for="status-filter" class="block text-sm font-medium text-gray-700 mb-2">Status</label>
          <div class="relative">
            <select id="status-filter" class="block w-full px-4 py-3 text-sm border border-gray-200 rounded-xl bg-gray-50 text-gray-900 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent focus:bg-white transition-all duration-200 appearance-none cursor-pointer">
              <option value="">All Status</option>
              <option value="enrolled">Enrolled</option>
              <option value="unenrolled">UnEnrolled</option>
            </select>
            <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
              <i class="fas fa-chevron-down text-gray-400 text-xs"></i>
            </div>
          </div>
        </div>
        
        <!-- Reset Button -->
        <div class="lg:col-span-1">
          <label class="block text-sm font-medium text-transparent mb-2 hidden md:block">Reset</label>
          <button type="button" id="reset-filters" class="w-full inline-flex items-center justify-center px-4 py-3 text-sm font-medium text-gray-600 bg-gray-100 border border-gray-200 rounded-xl hover:bg-gray-200 hover:text-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:bg-gray-200 transition-all duration-200 group min-h-[44px]">
            <i class="fas fa-sync-alt group-hover:rotate-180 transition-transform duration-300 mr-2 md:mr-0"></i>
            <span class="md:hidden">Reset Filters</span>
          </button>
        </div>
      </div>
      
      <!-- Active Filters Display -->
      <div id="active-filters" class="mt-4 pt-4 border-t border-gray-100 hidden">
        <div class="flex items-center space-x-2">
          <span class="text-sm font-medium text-gray-600">Active filters:</span>
          <div id="filter-tags" class="flex flex-wrap gap-2"></div>
        </div>
      </div>
    </div>

    <!-- Student table -->
    <div class="bg-white rounded-lg shadow-sm overflow-hidden mb-6">
      <div class="overflow-x-auto -mx-4 sm:mx-0">
        <div class="inline-block min-w-full align-middle">
          <table id="student-table" class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th scope="col" class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">
                  Student
                </th>
                <th scope="col" class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap hidden md:table-cell">
                  Student No.
                </th>
                <th scope="col" class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap hidden lg:table-cell">
                  Departmennt
                </th>
                <th scope="col" class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap hidden xl:table-cell">
                  Year Level
                </th>
                <th scope="col" class="px-3 sm:px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">
                  Actions
                </th>
              </tr>
            </thead>
            <tbody id="student-table-body" class="bg-white divide-y divide-gray-200">
              <!-- Student data will be loaded dynamically -->
              <tr id="loading-row">
                <td colspan="5" class="px-3 sm:px-6 py-8 text-center">
                <div class="flex justify-center items-center">
                  <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary-500"></div>
                  <span class="ml-3 text-gray-500">Loading students...</span>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
        </div>
      </div>
      
      <!-- Pagination -->
      <div class="bg-white px-4 py-3 border-t border-gray-200 sm:px-6">
        <div class="flex flex-col sm:flex-row items-center justify-between gap-3">
          <div class="flex-1 flex justify-between sm:hidden w-full">
            <a href="#" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 min-h-[44px]">
              Previous
            </a>
            <a href="#" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 min-h-[44px]">
              Next
            </a>
          </div>
          <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
            <div>
              <p id="pagination-info" class="text-sm text-gray-700">
                Showing <span class="font-medium">1</span> to <span class="font-medium">5</span> of <span class="font-medium">128</span> results
              </p>
            </div>
            <div>
              <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                <a href="#" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                  <span class="sr-only">Previous</span>
                  <i class="fas fa-chevron-left"></i>
                </a>
                <a href="#" aria-current="page" class="z-10 bg-primary-50 border-primary-500 text-primary-600 relative inline-flex items-center px-4 py-2 border text-sm font-medium">
                  1
                </a>
                <a href="#" class="bg-white border-gray-300 text-gray-500 hover:bg-gray-50 relative inline-flex items-center px-4 py-2 border text-sm font-medium">
                  2
                </a>
                <a href="#" class="bg-white border-gray-300 text-gray-500 hover:bg-gray-50 hidden md:inline-flex relative items-center px-4 py-2 border text-sm font-medium">
                  3
                </a>
                <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700">
                  ...
                </span>
                <a href="#" class="bg-white border-gray-300 text-gray-500 hover:bg-gray-50 hidden md:inline-flex relative items-center px-4 py-2 border text-sm font-medium">
                  12
                </a>
                <a href="#" class="bg-white border-gray-300 text-gray-500 hover:bg-gray-50 relative inline-flex items-center px-4 py-2 border text-sm font-medium">
                  13
                </a>
                <a href="#" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                  <span class="sr-only">Next</span>
                  <i class="fas fa-chevron-right"></i>
                </a>
              </nav>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
  </div>
  </div>

  <!-- Page-specific JavaScript -->
  <script>
    const loginUrl = "{{ url_for('auth.login') }}";
    let studentData = [];
    let filteredData = [];
    let currentPage = 1;
    const itemsPerPage = 10;
    
    document.addEventListener('DOMContentLoaded', function() {
      loadStudentData();
      setupEventListeners();
    });
    
    // Load student data from API
    async function loadStudentData() {
      try {
        console.log('Loading student data...');
        const response = await fetch('/api/students');
        console.log('Response status:', response.status);
        
        if (!response.ok) {
          if (response.status === 401) {
            showError(`Authentication required. Please <a href="${loginUrl}" class="text-blue-600 hover:text-blue-800">log in as an administrator</a> to view student data.`);
            return;
          }
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        console.log('API Response:', result);
        
        if (result.success) {
          studentData = result.data;
          filteredData = [...studentData];
          
          // Update statistics
          updateStatistics(result.stats);
          
          // Populate program filter
          populateProgramFilter();
          
          // Render student table
          renderStudentTable();
          
          // Update pagination info
          updatePaginationInfo();
          
          console.log('Student data loaded successfully:', studentData.length + ' students');
        } else {
          showError('Failed to load student data: ' + (result.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Error loading student data:', error);
        showError('Error loading student data: ' + error.message);
      }
    }
    
    // Update statistics cards
    function updateStatistics(stats) {
      const totalStudentsEl = document.getElementById('total-students');
      const activeStudentsEl = document.getElementById('active-students');
      const totalProgramsEl = document.getElementById('total-programs');
      
      if (totalStudentsEl) totalStudentsEl.textContent = stats.total_students || 0;
      if (activeStudentsEl) activeStudentsEl.textContent = stats.active_students || 0;
      if (totalProgramsEl) totalProgramsEl.textContent = stats.total_programs || 0;
    }
    
    // Populate program filter with unique programs
    function populateProgramFilter() {
      const programSelect = document.getElementById('program-filter');
      const programs = [...new Set(studentData.map(s => s.program).filter(p => p))];
      
      // Clear existing options except "All Programs"
      programSelect.innerHTML = '<option value="">All Department</option>';
      
      programs.sort().forEach(program => {
        const option = document.createElement('option');
        option.value = program;
        option.textContent = program;
        programSelect.appendChild(option);
      });
    }
    
    // Render student table
    function renderStudentTable() {
      const tableBody = document.getElementById('student-table-body');
      
      if (filteredData.length === 0) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="5" class="px-6 py-8 text-center text-gray-500">
              No students found matching your criteria.
            </td>
          </tr>
        `;
        return;
      }
      
      // Calculate pagination
      const totalPages = Math.ceil(filteredData.length / itemsPerPage);
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const paginatedData = filteredData.slice(startIndex, endIndex);
      
      const rows = paginatedData.map(student => createStudentRow(student)).join('');
      tableBody.innerHTML = rows;
      
      // Update pagination controls
      renderPagination();
    }
    
    // Create a single student row
    function createStudentRow(student) {
      const initials = getInitials(student.first_name, student.last_name);
      const fullName = `${student.first_name} ${student.last_name}`;
      const avatarColor = getAvatarColor(student.id);
      const statusBadge = getStatusBadge(student.status);
      const programBadge = getProgramBadge(student.program);
      
      return `
        <tr class="hover:bg-gray-50 student-row" data-student-id="${student.id}">
          <td class="px-3 sm:px-6 py-4">
            <div class="flex items-center">
              <div class="flex-shrink-0 h-10 w-10 ${avatarColor} rounded-full flex items-center justify-center text-xs font-semibold">
                ${initials}
              </div>
              <div class="ml-3 sm:ml-4 min-w-0 flex-1">
                <div class="text-sm font-medium text-gray-900 truncate">${fullName}</div>
                <div class="text-xs sm:text-sm text-gray-500 truncate md:hidden">${student.student_number}</div>
                <div class="text-xs text-gray-400 truncate hidden md:block">${student.email || 'No email'}</div>
              </div>
            </div>
          </td>
          <td class="px-3 sm:px-6 py-4 whitespace-nowrap text-sm text-gray-500 hidden md:table-cell">
            ${student.student_number}
          </td>
          <td class="px-3 sm:px-6 py-4 whitespace-nowrap hidden lg:table-cell">
            ${programBadge}
          </td>
          <td class="px-3 sm:px-6 py-4 whitespace-nowrap hidden xl:table-cell">
            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-indigo-100 text-indigo-800">
              ${student.year_level || 'N/A'}
            </span>
          </td>
          <td class="px-3 sm:px-6 py-4 whitespace-nowrap text-right">
            <div class="flex justify-end gap-1">
              <button type="button" class="text-blue-600 hover:text-blue-900 view-student-btn p-2 hover:bg-blue-50 rounded-lg transition-colors min-w-[44px] min-h-[44px] flex items-center justify-center" 
                      data-student-id="${student.id}" title="View Details" aria-label="View student details">
                <i class="fas fa-eye text-sm"></i>
              </button>
              <button type="button" class="text-green-600 hover:text-green-900 edit-student-btn p-2 hover:bg-green-50 rounded-lg transition-colors min-w-[44px] min-h-[44px] flex items-center justify-center" 
                      data-student-id="${student.id}" title="Edit Student" aria-label="Edit student">
                <i class="fas fa-edit text-sm"></i>
              </button>
              <button type="button" class="text-orange-600 hover:text-orange-900 retake-evaluation-btn p-2 hover:bg-orange-50 rounded-lg transition-colors min-w-[44px] min-h-[44px] flex items-center justify-center hidden sm:flex" 
                      data-student-id="${student.id}" title="Retake Evaluation" aria-label="Allow retake evaluation">
                <i class="fas fa-redo text-sm"></i>
              </button>
              <button type="button" class="text-red-600 hover:text-red-900 archive-student-btn p-2 hover:bg-red-50 rounded-lg transition-colors min-w-[44px] min-h-[44px] flex items-center justify-center hidden sm:flex" 
                      data-student-id="${student.id}" title="Archive Student" aria-label="Archive student">
                <i class="fas fa-archive"></i>
              </button>
            </div>
          </td>
        </tr>
      `;
    }
    
    
    // Helper functions
    function getInitials(firstName, lastName) {
      return (firstName.charAt(0) + lastName.charAt(0)).toUpperCase();
    }
    
    function getOrdinalSuffix(num) {
      const j = num % 10;
      const k = num % 100;
      if (j == 1 && k != 11) return "st";
      if (j == 2 && k != 12) return "nd";
      if (j == 3 && k != 13) return "rd";
      return "th";
    }
    
    function getAvatarColor(studentId) {
      const colors = [
        'bg-blue-100 text-blue-700',
        'bg-purple-100 text-purple-700',
        'bg-green-100 text-green-700',
        'bg-red-100 text-red-700',
        'bg-yellow-100 text-yellow-700',
        'bg-indigo-100 text-indigo-700',
        'bg-pink-100 text-pink-700',
        'bg-teal-100 text-teal-700'
      ];
      return colors[studentId % colors.length];
    }
    
    function getStatusBadge(status) {
      const statusMap = {
        'enrolled': 'bg-green-100 text-green-800',
        'irregular': 'bg-yellow-100 text-yellow-800',
        'on leave': 'bg-blue-100 text-blue-800',
        'graduated': 'bg-purple-100 text-purple-800',
        'dropped': 'bg-red-100 text-red-800'
      };
      const className = statusMap[status.toLowerCase()] || 'bg-gray-100 text-gray-800';
      return `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${className}">${status}</span>`;
    }
    
    function getProgramBadge(program) {
      if (!program) return '<span class="text-sm text-gray-500">No Department</span>';
      
      const colors = [
        'bg-blue-100 text-blue-800',
        'bg-purple-100 text-purple-800',
        'bg-green-100 text-green-800',
        'bg-red-100 text-red-800',
        'bg-yellow-100 text-yellow-800'
      ];
      const hash = program.split('').reduce((a, b) => { a = ((a << 5) - a) + b.charCodeAt(0); return a & a; }, 0);
      const colorClass = colors[Math.abs(hash) % colors.length];
      
      return `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${colorClass}">${program}</span>`;
    }
    
    // Setup event listeners
    function setupEventListeners() {
      // Search functionality
      const searchInput = document.getElementById('search-student');
      searchInput.addEventListener('input', function() {
        applyFilters();
      });
      
      // Program filter
      const programFilter = document.getElementById('program-filter');
      programFilter.addEventListener('change', function() {
        applyFilters();
      });
      
      // Year filter
      const yearFilter = document.getElementById('year-filter');
      yearFilter.addEventListener('change', function() {
        applyFilters();
      });
      
      // Status filter
      const statusFilter = document.getElementById('status-filter');
      statusFilter.addEventListener('change', function() {
        applyFilters();
      });
      
      // Reset filters with animation
      const resetFiltersBtn = document.getElementById('reset-filters');
      resetFiltersBtn.addEventListener('click', function() {
        // Add loading state
        const icon = this.querySelector('i');
        icon.classList.add('fa-spin');
        
        // Reset after brief delay for visual feedback
        setTimeout(() => {
          searchInput.value = '';
          programFilter.selectedIndex = 0;
          yearFilter.selectedIndex = 0;
          statusFilter.selectedIndex = 0;
          applyFilters();
          icon.classList.remove('fa-spin');
        }, 300);
      });
      
      // Student action buttons (delegated event listener)
      document.addEventListener('click', function(e) {
        if (e.target.closest('.view-student-btn')) {
          const studentId = e.target.closest('.view-student-btn').dataset.studentId;
          const student = studentData.find(s => s.id == studentId);
          if (student) {
            viewStudentDetails(student);
          }
        }
        
        if (e.target.closest('.edit-student-btn')) {
          const studentId = e.target.closest('.edit-student-btn').dataset.studentId;
          const student = studentData.find(s => s.id == studentId);
          if (student) {
            editStudentDetails(student);
          }
        }
        
        if (e.target.closest('.retake-evaluation-btn')) {
          const studentId = e.target.closest('.retake-evaluation-btn').dataset.studentId;
          const student = studentData.find(s => s.id == studentId);
          if (student) {
            retakeEvaluation(student);
          }
        }
      });
      
      // Add student button
      const addStudentBtn = document.getElementById('add-student-btn');
      if (addStudentBtn) {
        addStudentBtn.addEventListener('click', function() {
          addNewStudent();
        });
      }
      
      // Archive student button (delegated)
      document.addEventListener('click', function(e) {
        if (e.target.closest('.archive-student-btn')) {
          const studentId = e.target.closest('.archive-student-btn').dataset.studentId;
          const student = studentData.find(s => s.id == studentId);
          if (student) {
            archiveStudent(student);
          }
        }
      });
    }
    
    // Apply all filters
    function applyFilters() {
      const searchTerm = document.getElementById('search-student').value.toLowerCase();
      const programFilter = document.getElementById('program-filter').value;
      const yearFilter = document.getElementById('year-filter').value;
      const statusFilter = document.getElementById('status-filter').value.toLowerCase();
      
      filteredData = studentData.filter(student => {
        const fullName = `${student.first_name} ${student.last_name}`.toLowerCase();
        const studentNumber = student.student_number.toLowerCase();
        
        const matchesSearch = !searchTerm || 
          fullName.includes(searchTerm) || 
          studentNumber.includes(searchTerm);
        
        const matchesProgram = !programFilter || 
          (student.program && student.program.includes(programFilter));
        
        const matchesYear = !yearFilter || 
          student.year_level === yearFilter;
        
        const matchesStatus = !statusFilter || 
          (student.status && student.status.toLowerCase() === statusFilter);
        
        return matchesSearch && matchesProgram && matchesYear && matchesStatus;
      });
      
      // Reset to page 1 when filters change
      currentPage = 1;
      
      renderStudentTable();
      updatePaginationInfo();
      updateActiveFilters();
    }
    
    
    // Update pagination info and results count
    function updatePaginationInfo() {
      const totalResults = filteredData.length;
      const startIndex = (currentPage - 1) * itemsPerPage + 1;
      const endIndex = Math.min(currentPage * itemsPerPage, totalResults);
      
      // Update results count badge
      const resultsCount = document.getElementById('results-count');
      if (resultsCount) {
        resultsCount.textContent = `${totalResults} result${totalResults !== 1 ? 's' : ''}`;
      }
      
      // Update pagination text
      const paginationText = document.getElementById('pagination-info');
      if (paginationText) {
        if (totalResults === 0) {
          paginationText.innerHTML = 'Showing 0 results';
        } else {
          paginationText.innerHTML = `
            Showing <span class="font-medium">${startIndex}</span> to <span class="font-medium">${endIndex}</span> of <span class="font-medium">${totalResults}</span> results
          `;
        }
      }
      
      // Update active filters display
      updateActiveFilters();
    }
    
    // Render pagination controls
    function renderPagination() {
      const totalPages = Math.ceil(filteredData.length / itemsPerPage);
      const paginationNav = document.querySelector('nav[aria-label="Pagination"]');
      
      if (!paginationNav || totalPages <= 1) {
        if (paginationNav) {
          paginationNav.style.display = 'none';
        }
        return;
      }
      
      paginationNav.style.display = 'inline-flex';
      
      let paginationHTML = '';
      
      // Previous button
      paginationHTML += `
        <a href="#" class="pagination-prev relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium ${currentPage === 1 ? 'text-gray-300 cursor-not-allowed' : 'text-gray-500 hover:bg-gray-50'}" ${currentPage === 1 ? 'disabled' : ''}>
          <span class="sr-only">Previous</span>
          <i class="fas fa-chevron-left"></i>
        </a>
      `;
      
      // Page numbers
      const maxVisiblePages = 7;
      let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
      let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
      
      if (endPage - startPage < maxVisiblePages - 1) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
      }
      
      // First page
      if (startPage > 1) {
        paginationHTML += `
          <a href="#" class="pagination-page bg-white border-gray-300 text-gray-500 hover:bg-gray-50 relative inline-flex items-center px-4 py-2 border text-sm font-medium" data-page="1">
            1
          </a>
        `;
        if (startPage > 2) {
          paginationHTML += `
            <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700">
              ...
            </span>
          `;
        }
      }
      
      // Page numbers
      for (let i = startPage; i <= endPage; i++) {
        if (i === currentPage) {
          paginationHTML += `
            <a href="#" aria-current="page" class="z-10 bg-primary-50 border-primary-500 text-primary-600 relative inline-flex items-center px-4 py-2 border text-sm font-medium">
              ${i}
            </a>
          `;
        } else {
          paginationHTML += `
            <a href="#" class="pagination-page bg-white border-gray-300 text-gray-500 hover:bg-gray-50 relative inline-flex items-center px-4 py-2 border text-sm font-medium" data-page="${i}">
              ${i}
            </a>
          `;
        }
      }
      
      // Last page
      if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
          paginationHTML += `
            <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700">
              ...
            </span>
          `;
        }
        paginationHTML += `
          <a href="#" class="pagination-page bg-white border-gray-300 text-gray-500 hover:bg-gray-50 relative inline-flex items-center px-4 py-2 border text-sm font-medium" data-page="${totalPages}">
            ${totalPages}
          </a>
        `;
      }
      
      // Next button
      paginationHTML += `
        <a href="#" class="pagination-next relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium ${currentPage === totalPages ? 'text-gray-300 cursor-not-allowed' : 'text-gray-500 hover:bg-gray-50'}" ${currentPage === totalPages ? 'disabled' : ''}>
          <span class="sr-only">Next</span>
          <i class="fas fa-chevron-right"></i>
        </a>
      `;
      
      paginationNav.innerHTML = paginationHTML;
      
      // Add event listeners to pagination controls
      paginationNav.querySelectorAll('.pagination-page').forEach(link => {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          const page = parseInt(this.dataset.page);
          goToPage(page);
        });
      });
      
      const prevButton = paginationNav.querySelector('.pagination-prev');
      if (prevButton && currentPage > 1) {
        prevButton.addEventListener('click', function(e) {
          e.preventDefault();
          goToPage(currentPage - 1);
        });
      }
      
      const nextButton = paginationNav.querySelector('.pagination-next');
      if (nextButton && currentPage < totalPages) {
        nextButton.addEventListener('click', function(e) {
          e.preventDefault();
          goToPage(currentPage + 1);
        });
      }
    }
    
    // Go to specific page
    function goToPage(page) {
      const totalPages = Math.ceil(filteredData.length / itemsPerPage);
      if (page < 1 || page > totalPages) return;
      
      currentPage = page;
      renderStudentTable();
      updatePaginationInfo();
      
      // Scroll to top of table
      document.querySelector('#student-table').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    // Update active filters display
    function updateActiveFilters() {
      const searchTerm = document.getElementById('search-student').value;
      const programFilter = document.getElementById('program-filter').value;
      const yearFilter = document.getElementById('year-filter').value;
      const statusFilter = document.getElementById('status-filter').value;
      
      const activeFiltersContainer = document.getElementById('active-filters');
      const filterTagsContainer = document.getElementById('filter-tags');
      
      const tags = [];
      
      if (searchTerm) {
        tags.push({
          type: 'search',
          label: `Search: "${searchTerm}"`,
          value: searchTerm
        });
      }
      
      if (programFilter) {
        tags.push({
          type: 'program',
          label: `Program: ${programFilter}`,
          value: programFilter
        });
      }
      
      if (yearFilter) {
        tags.push({
          type: 'year',
          label: `Year: ${yearFilter}${getOrdinalSuffix(yearFilter)}`,
          value: yearFilter
        });
      }
      
      if (statusFilter) {
        const statusText = statusFilter.charAt(0).toUpperCase() + statusFilter.slice(1);
        tags.push({
          type: 'status',
          label: `Status: ${statusText}`,
          value: statusFilter
        });
      }
      
      if (tags.length > 0) {
        activeFiltersContainer.classList.remove('hidden');
        filterTagsContainer.innerHTML = tags.map(tag => `
          <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-primary-100 text-primary-800 border border-primary-200">
            ${tag.label}
            <button type="button" class="ml-2 inline-flex items-center justify-center w-4 h-4 rounded-full bg-primary-200 hover:bg-primary-300 transition-colors" onclick="removeFilter('${tag.type}', '${tag.value}')">
              <i class="fas fa-times text-xs"></i>
            </button>
          </span>
        `).join('');
      } else {
        activeFiltersContainer.classList.add('hidden');
      }
    }
    
    // Remove individual filter
    function removeFilter(type, value) {
      switch(type) {
        case 'search':
          document.getElementById('search-student').value = '';
          break;
        case 'program':
          document.getElementById('program-filter').value = '';
          break;
        case 'year':
          document.getElementById('year-filter').value = '';
          break;
        case 'status':
          document.getElementById('status-filter').value = '';
          break;
      }
      applyFilters();
    }
    
    // Add new student
    async function addNewStudent() {
      // Get programs from API for dropdown
      let programOptions = '';
      let sectionOptions = '';
      
      try {
        const progResponse = await fetch('/api/programs');
        const progResult = await progResponse.json();
        if (progResult.success) {
          programOptions = progResult.data.map(prog => 
            `<option value="${prog.program_id}">${prog.program_code} - ${prog.name}</option>`
          ).join('');
        }
        
        // Get sections from API for dropdown
        const sectResponse = await fetch('/api/sections-master');
        const sectResult = await sectResponse.json();
        if (sectResult.success) {
          sectionOptions = sectResult.data.map(sect => 
            `<option value="${sect.section_id}" data-program="${sect.program_id}" data-year="${sect.year_level}">${sect.section_code} - ${sect.section_name}</option>`
          ).join('');
        }
      } catch (error) {
        console.error('Error loading programs:', error);
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Failed to load programs. Please try again.',
          confirmButtonColor: '#0059cc'
        });
        return;
      }
      
      const { value: formValues } = await Swal.fire({
        title: 'Add New Student',
        html: `
          <div class="space-y-4 text-left">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">First Name <span class="text-red-500">*</span></label>
                <input id="add-first-name" class="swal2-input w-full" placeholder="First Name">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Last Name <span class="text-red-500">*</span></label>
                <input id="add-last-name" class="swal2-input w-full" placeholder="Last Name">
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Middle Name</label>
              <input id="add-middle-name" class="swal2-input w-full" placeholder="Middle Name (Optional)">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Student Number <span class="text-red-500">*</span></label>
              <input id="add-student-number" class="swal2-input w-full" placeholder="e.g., 2024-0001">
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Birth Date <span class="text-red-500">*</span></label>
                <input id="add-birthdate" type="date" class="swal2-input w-full">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Age <span class="text-red-500">*</span></label>
                <input id="add-age" type="number" min="15" max="100" class="swal2-input w-full" placeholder="Age">
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Address <span class="text-red-500">*</span></label>
              <textarea id="add-address" rows="2" class="swal2-input w-full" style="min-height: 60px; resize: vertical;" placeholder="Complete Address"></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
              <input id="add-email" type="email" class="swal2-input w-full" placeholder="student@example.com">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Contact Number</label>
              <input id="add-contact" class="swal2-input w-full" placeholder="e.g., 09123456789">
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Department <span class="text-red-500">*</span></label>
                <select id="add-program" class="swal2-input w-full">
                  <option value="">Select Department</option>
                  ${programOptions}
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Year Level <span class="text-red-500">*</span></label>
                <select id="add-year-level" class="swal2-input w-full">
                  <option value="">Select Year</option>
                  <option value="1">1st Year</option>
                  <option value="2">2nd Year</option>
                  <option value="3">3rd Year</option>
                  <option value="4">4th Year</option>
                </select>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Section <span class="text-gray-500 text-xs">(Select a section to assign student)</span></label>
              <select id="add-section" class="swal2-input w-full">
                <option value="">-- Select Section --</option>
                ${sectionOptions}
              </select>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Gender <span class="text-red-500">*</span></label>
                <select id="add-gender" class="swal2-input w-full">
                  <option value="">Select Gender</option>
                  <option value="Male">Male</option>
                  <option value="Female">Female</option>
                  <option value="Other">Other</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Status <span class="text-red-500">*</span></label>
                <select id="add-status" class="swal2-input w-full">
                  <option value="Enrolled">Enrolled</option>
                  <option value="Irregular">Irregular</option>
                  <option value="On Leave">On Leave</option>
                </select>
              </div>
            </div>
          </div>
        `,
        focusConfirm: false,
        showCancelButton: true,
        confirmButtonText: 'Add Student',
        cancelButtonText: 'Cancel',
        confirmButtonColor: '#0059cc',
        width: '90%',
        customClass: {
          htmlContainer: 'swal2-html-container-custom'
        },
        didOpen: () => {
          // Auto-calculate age from birthdate
          const birthdateInput = document.getElementById('add-birthdate');
          const ageInput = document.getElementById('add-age');
          
          birthdateInput.addEventListener('change', function() {
            if (this.value) {
              const birthDate = new Date(this.value);
              const today = new Date();
              let age = today.getFullYear() - birthDate.getFullYear();
              const monthDiff = today.getMonth() - birthDate.getMonth();
              
              if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
              }
              
              ageInput.value = age;
            }
          });
          
          // Filter sections based on selected program and year
          const programInput = document.getElementById('add-program');
          const yearInput = document.getElementById('add-year-level');
          const sectionInput = document.getElementById('add-section');
          
          const filterSections = () => {
            const selectedProgram = programInput.value;
            const selectedYear = yearInput.value;
            
            console.log('Filtering sections - Program:', selectedProgram, 'Year:', selectedYear);
            
            // Reset section dropdown
            sectionInput.innerHTML = '<option value="">-- Select Section --</option>';
            
            // Always parse the original sectionOptions to rebuild dropdown
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = '<select>' + sectionOptions + '</select>';
            const options = tempDiv.querySelectorAll('option');
            
            let matchedCount = 0;
            
            options.forEach(option => {
              if (option.value) { // Skip empty value options
                const optionProgram = option.getAttribute('data-program');
                const optionYear = option.getAttribute('data-year');
                
                console.log('Checking option:', option.textContent, '| Program:', optionProgram, '| Year:', optionYear);
                
                // Convert to strings for comparison
                const optionProgramStr = optionProgram ? optionProgram.toString() : '';
                const optionYearStr = optionYear ? optionYear.toString() : '';
                const selectedProgramStr = selectedProgram ? selectedProgram.toString() : '';
                const selectedYearStr = selectedYear ? selectedYear.toString() : '';
                
                // If both filters are selected, show only matching sections
                if (selectedProgramStr && selectedYearStr) {
                  if (optionProgramStr === selectedProgramStr && optionYearStr === selectedYearStr) {
                    const newOption = option.cloneNode(true);
                    sectionInput.appendChild(newOption);
                    matchedCount++;
                    console.log(' Match found (both filters):', option.textContent);
                  }
                }
                // If only program selected, show all sections for that program
                else if (selectedProgramStr && !selectedYearStr) {
                  if (optionProgramStr === selectedProgramStr) {
                    const newOption = option.cloneNode(true);
                    sectionInput.appendChild(newOption);
                    matchedCount++;
                    console.log(' Match found (program only):', option.textContent);
                  }
                }
                // If only year selected, show all sections for that year
                else if (!selectedProgramStr && selectedYearStr) {
                  if (optionYearStr === selectedYearStr) {
                    const newOption = option.cloneNode(true);
                    sectionInput.appendChild(newOption);
                    matchedCount++;
                    console.log(' Match found (year only):', option.textContent);
                  }
                }
              }
            });
            
            console.log('Total matched sections:', matchedCount);
            
            // Show message if no sections found after filtering
            if (matchedCount === 0 && (selectedProgram || selectedYear)) {
              const noSectionOption = document.createElement('option');
              noSectionOption.value = '';
              noSectionOption.textContent = 'No sections available for selected filters';
              noSectionOption.disabled = true;
              sectionInput.appendChild(noSectionOption);
            }
          };
          
          programInput.addEventListener('change', filterSections);
          yearInput.addEventListener('change', filterSections);
        },
        preConfirm: () => {
          return {
            first_name: document.getElementById('add-first-name').value,
            last_name: document.getElementById('add-last-name').value,
            middle_name: document.getElementById('add-middle-name').value,
            student_number: document.getElementById('add-student-number').value,
            birthdate: document.getElementById('add-birthdate').value,
            age: document.getElementById('add-age').value,
            address: document.getElementById('add-address').value,
            email: document.getElementById('add-email').value,
            contact_number: document.getElementById('add-contact').value,
            program_id: document.getElementById('add-program').value,
            year_level: document.getElementById('add-year-level').value,
            section_id: document.getElementById('add-section').value,
            gender: document.getElementById('add-gender').value,
            status: document.getElementById('add-status').value
          }
        }
      });

      if (formValues) {
        // Validate required fields
        if (!formValues.first_name || !formValues.last_name || !formValues.student_number || 
            !formValues.birthdate || !formValues.age || !formValues.address ||
            !formValues.program_id || !formValues.year_level || !formValues.gender) {
          Swal.fire({
            icon: 'error',
            title: 'Validation Error',
            text: 'Please fill in all required fields marked with *',
            confirmButtonColor: '#0059cc'
          });
          return;
        }
        
        // Validate age is a positive number
        if (formValues.age < 15 || formValues.age > 100) {
          Swal.fire({
            icon: 'error',
            title: 'Validation Error',
            text: 'Please enter a valid age (15-100)',
            confirmButtonColor: '#0059cc'
          });
          return;
        }

        // Send to server
        try {
          const response = await fetch('/api/students', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(formValues)
          });

          const result = await response.json();

          if (result.success) {
            // Show success message with generated credentials
            Swal.fire({
              icon: 'success',
              title: 'Student Added Successfully!',
              html: `
                <div class="text-left space-y-2">
                  <p class="text-gray-700"><strong>Student created with user account</strong></p>
                  <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mt-3">
                    <p class="text-sm font-medium text-blue-900">Login Credentials:</p>
                    <p class="text-sm text-blue-800 mt-1"><strong>Username:</strong> ${result.username}</p>
                    <p class="text-sm text-blue-800"><strong>Password:</strong> ${result.default_password}</p>
                    <p class="text-xs text-blue-600 mt-2"><i class="fas fa-info-circle mr-1"></i>Please provide these credentials to the student</p>
                  </div>
                </div>
              `,
              confirmButtonText: 'OK',
              confirmButtonColor: '#0059cc',
              width: '500px'
            });
            
            // Reload student data
            loadStudentData();
          } else {
            Swal.fire({
              icon: 'error',
              title: 'Error',
              text: result.error || 'Failed to add student',
              confirmButtonColor: '#0059cc'
            });
          }
        } catch (error) {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'An error occurred while adding student',
            confirmButtonColor: '#0059cc'
          });
          console.error('Error adding student:', error);
        }
      }
    }
    
    // Edit student details
    async function editStudentDetails(student) {
      // Get programs from API for dropdown
      let programOptions = '';
      let sectionOptions = '';
      
      try {
        const progResponse = await fetch('/api/programs');
        const progResult = await progResponse.json();
        if (progResult.success) {
          programOptions = progResult.data.map(prog => 
            `<option value="${prog.program_id}" ${student.program_id == prog.program_id ? 'selected' : ''}>${prog.program_code} - ${prog.name}</option>`
          ).join('');
        }
        
        // Get sections from API for dropdown
        const sectResponse = await fetch('/api/sections-master');
        const sectResult = await sectResponse.json();
        if (sectResult.success) {
          sectionOptions = sectResult.data.map(sect => {
            const isSelected = student.current_section_id && sect.section_id == student.current_section_id ? 'selected' : '';
            return `<option value="${sect.section_id}" data-program="${sect.program_id}" data-year="${sect.year_level}" ${isSelected}>${sect.section_code} - ${sect.section_name}</option>`;
          }).join('');
        }
      } catch (error) {
        console.error('Error loading programs:', error);
      }
      
      const { value: formValues } = await Swal.fire({
        title: 'Edit Student Details',
        html: `
          <div class="space-y-4 text-left">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">First Name</label>
                <input id="edit-first-name" class="swal2-input w-full" value="${student.first_name}" placeholder="First Name">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Last Name</label>
                <input id="edit-last-name" class="swal2-input w-full" value="${student.last_name}" placeholder="Last Name">
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Middle Name</label>
              <input id="edit-middle-name" class="swal2-input w-full" value="${student.middle_name || ''}" placeholder="Middle Name">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Student Number</label>
              <input id="edit-student-number" class="swal2-input w-full" value="${student.student_number}" placeholder="Student Number">
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Birth Date</label>
                <input id="edit-birthdate" type="date" class="swal2-input w-full" value="${student.birthdate || ''}">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Age</label>
                <input id="edit-age" type="number" min="15" max="100" class="swal2-input w-full" value="${student.age || ''}" placeholder="Age">
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Address</label>
              <textarea id="edit-address" rows="2" class="swal2-input w-full" style="min-height: 60px; resize: vertical;" placeholder="Complete Address">${student.address || ''}</textarea>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
              <input id="edit-email" type="email" class="swal2-input w-full" value="${student.email || ''}" placeholder="Email">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Contact Number</label>
              <input id="edit-contact" class="swal2-input w-full" value="${student.contact_number || ''}" placeholder="Contact Number">
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Program</label>
                <select id="edit-program" class="swal2-input w-full">
                  <option value="">Select Program</option>
                  ${programOptions}
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Year Level</label>
                <select id="edit-year-level" class="swal2-input w-full">
                  <option value="1" ${student.year_level == '1' ? 'selected' : ''}>1st Year</option>
                  <option value="2" ${student.year_level == '2' ? 'selected' : ''}>2nd Year</option>
                  <option value="3" ${student.year_level == '3' ? 'selected' : ''}>3rd Year</option>
                  <option value="4" ${student.year_level == '4' ? 'selected' : ''}>4th Year</option>
                </select>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Section <span class="text-gray-500 text-xs">(Select a section to assign student)</span></label>
              <select id="edit-section" class="swal2-input w-full">
                <option value="">-- Select Section --</option>
                ${sectionOptions}
              </select>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Gender</label>
                <select id="edit-gender" class="swal2-input w-full">
                  <option value="">Select Gender</option>
                  <option value="Male" ${student.gender === 'Male' ? 'selected' : ''}>Male</option>
                  <option value="Female" ${student.gender === 'Female' ? 'selected' : ''}>Female</option>
                  <option value="Other" ${student.gender === 'Other' ? 'selected' : ''}>Other</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                <select id="edit-status" class="swal2-input w-full">
                  <option value="Enrolled" ${student.status === 'Enrolled' ? 'selected' : ''}>Enrolled</option>
                  <option value="Irregular" ${student.status === 'Irregular' ? 'selected' : ''}>Irregular</option>
                  <option value="On Leave" ${student.status === 'On Leave' ? 'selected' : ''}>On Leave</option>
                  <option value="Graduated" ${student.status === 'Graduated' ? 'selected' : ''}>Graduated</option>
                  <option value="Dropped" ${student.status === 'Dropped' ? 'selected' : ''}>Dropped</option>
                </select>
              </div>
            </div>
          </div>
        `,
        focusConfirm: false,
        showCancelButton: true,
        confirmButtonText: 'Save Changes',
        cancelButtonText: 'Cancel',
        confirmButtonColor: '#0059cc',
        width: '90%',
        customClass: {
          htmlContainer: 'swal2-html-container-custom'
        },
        didOpen: () => {
          // Auto-calculate age from birthdate
          const birthdateInput = document.getElementById('edit-birthdate');
          const ageInput = document.getElementById('edit-age');
          
          birthdateInput.addEventListener('change', function() {
            if (this.value) {
              const birthDate = new Date(this.value);
              const today = new Date();
              let age = today.getFullYear() - birthDate.getFullYear();
              const monthDiff = today.getMonth() - birthDate.getMonth();
              
              if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
              }
              
              ageInput.value = age;
            }
          });
          
          // Filter sections based on selected program and year
          const programInput = document.getElementById('edit-program');
          const yearInput = document.getElementById('edit-year-level');
          const sectionInput = document.getElementById('edit-section');
          
          const filterSections = () => {
            const selectedProgram = programInput.value;
            const selectedYear = yearInput.value;
            
            console.log('Editing - Filtering sections - Program:', selectedProgram, 'Year:', selectedYear);
            
            // Get current section value to preserve it if possible
            // Try to get from current dropdown value OR from student's current_section_id
            const currentSection = sectionInput.value || (student.current_section_id ? student.current_section_id.toString() : '');
            
            // Reset section dropdown
            sectionInput.innerHTML = '<option value="">-- Select Section --</option>';
            
            // Always parse the original sectionOptions to rebuild dropdown
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = '<select>' + sectionOptions + '</select>';
            const options = tempDiv.querySelectorAll('option');
            
            let matchedCount = 0;
            let foundCurrent = false;
            
            options.forEach(option => {
              if (option.value) { // Skip empty value options
                const optionProgram = option.getAttribute('data-program');
                const optionYear = option.getAttribute('data-year');
                
                console.log('Checking option:', option.textContent, '| Program:', optionProgram, '| Year:', optionYear);
                
                // Convert to strings for comparison
                const optionProgramStr = optionProgram ? optionProgram.toString() : '';
                const optionYearStr = optionYear ? optionYear.toString() : '';
                const selectedProgramStr = selectedProgram ? selectedProgram.toString() : '';
                const selectedYearStr = selectedYear ? selectedYear.toString() : '';
                
                // If both filters are selected, show only matching sections
                if (selectedProgramStr && selectedYearStr) {
                  if (optionProgramStr === selectedProgramStr && optionYearStr === selectedYearStr) {
                    const newOption = option.cloneNode(true);
                    // Restore previous selection if it matches
                    if (option.value === currentSection) {
                      newOption.selected = true;
                      foundCurrent = true;
                    }
                    sectionInput.appendChild(newOption);
                    matchedCount++;
                    console.log(' Match found (both filters):', option.textContent);
                  }
                }
                // If only program selected, show all sections for that program
                else if (selectedProgramStr && !selectedYearStr) {
                  if (optionProgramStr === selectedProgramStr) {
                    const newOption = option.cloneNode(true);
                    if (option.value === currentSection) {
                      newOption.selected = true;
                      foundCurrent = true;
                    }
                    sectionInput.appendChild(newOption);
                    matchedCount++;
                    console.log(' Match found (program only):', option.textContent);
                  }
                }
                // If only year selected, show all sections for that year
                else if (!selectedProgramStr && selectedYearStr) {
                  if (optionYearStr === selectedYearStr) {
                    const newOption = option.cloneNode(true);
                    if (option.value === currentSection) {
                      newOption.selected = true;
                      foundCurrent = true;
                    }
                    sectionInput.appendChild(newOption);
                    matchedCount++;
                    console.log(' Match found (year only):', option.textContent);
                  }
                }
              }
            });
            
            console.log('Total matched sections:', matchedCount);
            
            // Show message if no sections found after filtering
            if (matchedCount === 0 && (selectedProgram || selectedYear)) {
              const noSectionOption = document.createElement('option');
              noSectionOption.value = '';
              noSectionOption.textContent = 'No sections available for selected filters';
              noSectionOption.disabled = true;
              sectionInput.appendChild(noSectionOption);
            }
          };
          
          // On initial open, populate ALL sections without filtering to show current section
          // Only filter when user actively changes program or year
          const initializeSections = () => {
            sectionInput.innerHTML = '<option value="">-- Select Section --</option>';
            
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = '<select>' + sectionOptions + '</select>';
            const options = tempDiv.querySelectorAll('option');
            
            options.forEach(option => {
              const newOption = option.cloneNode(true);
              // Pre-select current section if it matches
              if (student.current_section_id && option.value == student.current_section_id) {
                newOption.selected = true;
              }
              sectionInput.appendChild(newOption);
            });
          };
          
          // Initialize with all sections on modal open
          initializeSections();
          
          // Only filter when user changes program or year
          programInput.addEventListener('change', filterSections);
          yearInput.addEventListener('change', filterSections);
        },
        preConfirm: () => {
          return {
            first_name: document.getElementById('edit-first-name').value,
            last_name: document.getElementById('edit-last-name').value,
            middle_name: document.getElementById('edit-middle-name').value,
            student_number: document.getElementById('edit-student-number').value,
            birthdate: document.getElementById('edit-birthdate').value,
            age: document.getElementById('edit-age').value,
            address: document.getElementById('edit-address').value,
            email: document.getElementById('edit-email').value,
            contact_number: document.getElementById('edit-contact').value,
            program_id: document.getElementById('edit-program').value,
            year_level: document.getElementById('edit-year-level').value,
            section_id: document.getElementById('edit-section').value,
            gender: document.getElementById('edit-gender').value,
            status: document.getElementById('edit-status').value
          }
        }
      });

      if (formValues) {
        // Validate required fields
        if (!formValues.first_name || !formValues.last_name || !formValues.student_number) {
          Swal.fire({
            icon: 'error',
            title: 'Validation Error',
            text: 'First name, last name, and student number are required',
            confirmButtonColor: '#0059cc'
          });
          return;
        }
        
        // Validate age if provided
        if (formValues.age && (formValues.age < 15 || formValues.age > 100)) {
          Swal.fire({
            icon: 'error',
            title: 'Validation Error',
            text: 'Please enter a valid age (15-100)',
            confirmButtonColor: '#0059cc'
          });
          return;
        }

        // Send update to server
        try {
          const response = await fetch(`/api/students/${student.id}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(formValues)
          });

          const result = await response.json();

          if (result.success) {
            Swal.fire({
              icon: 'success',
              title: 'Success!',
              text: 'Student details updated successfully',
              toast: true,
              position: 'top-end',
              showConfirmButton: false,
              timer: 3000,
              timerProgressBar: true
            });
            
            // Reload student data
            loadStudentData();
          } else {
            Swal.fire({
              icon: 'error',
              title: 'Error',
              text: result.error || 'Failed to update student details',
              confirmButtonColor: '#0059cc'
            });
          }
        } catch (error) {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'An error occurred while updating student details',
            confirmButtonColor: '#0059cc'
          });
          console.error('Error updating student:', error);
        }
      }
    }
    
    // View student details
    function viewStudentDetails(student) {
      const details = `
        <div class="text-left space-y-3">
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <p class="text-xs text-gray-500 uppercase">Full Name</p>
              <p class="font-medium">${student.first_name} ${student.middle_name || ''} ${student.last_name}</p>
            </div>
            <div>
              <p class="text-xs text-gray-500 uppercase">Student Number</p>
              <p class="font-medium">${student.student_number}</p>
            </div>
          </div>
          
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <p class="text-xs text-gray-500 uppercase">Program</p>
              <p class="font-medium">${student.program || 'Not assigned'}</p>
            </div>
            <div>
              <p class="text-xs text-gray-500 uppercase">Year Level</p>
              <p class="font-medium">${student.year_level || 'N/A'}</p>
            </div>
          </div>
          
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <p class="text-xs text-gray-500 uppercase">Status</p>
              <p class="font-medium">${student.status}</p>
            </div>
            <div>
              <p class="text-xs text-gray-500 uppercase">Gender</p>
              <p class="font-medium">${student.gender || 'N/A'}</p>
            </div>
          </div>
          
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <p class="text-xs text-gray-500 uppercase">Email</p>
              <p class="font-medium text-sm break-words">${student.email || 'Not provided'}</p>
            </div>
            <div>
              <p class="text-xs text-gray-500 uppercase">Contact Number</p>
              <p class="font-medium">${student.contact_number || 'Not provided'}</p>
            </div>
          </div>
          
          <div>
            <p class="text-xs text-gray-500 uppercase">Account Status</p>
            <p class="font-medium">
              ${student.username ? 
                `<span class="text-green-600"><i class="fas fa-check-circle mr-1"></i>Active (${student.username})</span>` : 
                '<span class="text-red-600"><i class="fas fa-times-circle mr-1"></i>No Account</span>'
              }
            </p>
          </div>
          
          ${student.enrollment_date ? `
          <div>
            <p class="text-xs text-gray-500 uppercase">Enrollment Date</p>
            <p class="font-medium">${new Date(student.enrollment_date).toLocaleDateString()}</p>
          </div>
          ` : ''}
        </div>
      `;
      
      if (typeof Swal !== 'undefined') {
        Swal.fire({
          title: '<i class="fas fa-user-graduate mr-2"></i>Student Details',
          html: details,
          icon: null,
          confirmButtonText: 'Close',
          width: '90%',
          customClass: {
            confirmButton: 'bg-primary-500 hover:bg-primary-600'
          }
        });
      } else {
        alert(`Student Details:\n${student.first_name} ${student.last_name}\nStudent Number: ${student.student_number}`);
      }
    }
    
    // Retake evaluation
    async function retakeEvaluation(student) {
      try {
        // First, fetch student's evaluation history
        const response = await fetch(`/api/students/${student.id}/evaluations`);
        const result = await response.json();
        
        if (!result.success || !result.evaluations || result.evaluations.length === 0) {
          Swal.fire({
            icon: 'info',
            title: 'No Evaluations Found',
            text: `${student.first_name} ${student.last_name} has no completed or expired evaluations to retake.`,
            confirmButtonText: 'OK'
          });
          return;
        }
        
        // Filter completed and expired evaluations
        const retakeableEvals = result.evaluations.filter(e => e.status === 'Completed' || e.status === 'Expired');
        
        if (retakeableEvals.length === 0) {
          Swal.fire({
            icon: 'info',
            title: 'No Evaluations Available',
            text: `${student.first_name} ${student.last_name} has no completed or expired evaluations available for retake.`,
            confirmButtonText: 'OK'
          });
          return;
        }
        
        // Show list of completed and expired evaluations with checkboxes
        const evaluationsList = retakeableEvals.map((eval, index) => {
          const isExpired = eval.status === 'Expired';
          const statusBadge = isExpired 
            ? '<span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800"><i class="fas fa-clock mr-1"></i>Expired</span>'
            : '<span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800"><i class="fas fa-check-circle mr-1"></i>Completed</span>';
          const borderClass = isExpired ? 'border-l-4 border-red-400 bg-red-50' : 'bg-white';
          const isLastItem = index === retakeableEvals.length - 1;
          
          // Get course/subject information - try multiple field name variations
          const courseCode = eval.subject_code || eval.course_code || 'N/A';
          const courseTitle = eval.subject_title || eval.subject_name || eval.course_title || eval.course_name || 'Unknown Course';
          const courseFull = `${courseCode} - ${courseTitle}`;
          
          return `
            <label class="flex items-start p-3 hover:bg-gray-100 cursor-pointer ${isLastItem ? '' : 'border-b border-gray-200'} ${borderClass} transition-colors">
              <input type="checkbox" 
                     class="subject-checkbox mt-1 h-4 w-4 text-primary-600 border-gray-300 rounded focus:ring-primary-500 cursor-pointer" 
                     value="${eval.evaluation_id}"
                     data-faculty="${eval.faculty_name || 'Unknown Faculty'}"
                     data-course="${courseFull}"
                     data-status="${eval.status}">
              <div class="ml-3 flex-1 min-w-0">
                <div class="text-sm font-medium text-gray-900 truncate">${courseFull}</div>
                <div class="text-xs text-gray-600 mt-1 truncate">
                  <i class="fas fa-user-tie mr-1"></i>${eval.faculty_name || 'Unknown Faculty'}
                </div>
                <div class="text-xs text-gray-500 mt-1">
                  <i class="fas fa-calendar mr-1"></i>${eval.period_name || eval.period_title || 'N/A'} | ${eval.academic_year || ''} ${eval.semester ? '- ' + eval.semester : ''}
                </div>
                ${eval.completion_time ? `<div class="text-xs text-gray-400 mt-1"><i class="fas fa-check-circle mr-1"></i>Completed: ${new Date(eval.completion_time).toLocaleDateString()}</div>` : ''}
                ${isExpired ? '<div class="text-xs text-red-600 mt-1 font-medium"><i class="fas fa-exclamation-triangle mr-1"></i>Evaluation expired - student did not complete in time</div>' : ''}
              </div>
              <div class="ml-2">${statusBadge}</div>
            </label>
          `;
        }).join('');
        
        const { value: formData } = await Swal.fire({
          title: '<i class="fas fa-redo mr-2"></i>Allow Evaluation Retake',
          html: `
            <div class="text-left">
              <p class="text-sm text-gray-600 mb-2">Student: <span class="font-semibold">${student.first_name} ${student.last_name}</span></p>
              <p class="text-sm text-gray-600 mb-3">Select evaluation(s) to reset and allow retake <span class="text-xs text-gray-500">(Completed & Expired)</span>:</p>
              
              <div class="flex items-center justify-between mb-2">
                <label class="text-sm font-medium text-gray-700">Select Evaluations</label>
                <button type="button" id="select-all-btn" class="text-xs text-primary-600 hover:text-primary-700 font-medium px-3 py-1.5 hover:bg-primary-50 rounded-md transition-colors">
                  <i class="fas fa-check-square mr-1"></i>Select All
                </button>
              </div>
              
              <div class="max-h-80 overflow-y-auto border border-gray-300 rounded-lg mb-4 bg-gray-50" id="evaluations-list" style="scrollbar-width: thin; scrollbar-color: #cbd5e0 #f7fafc;">
                ${evaluationsList}
              </div>
              
              <div class="mt-3">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  Reason for Retake <span class="text-red-500">*</span>
                </label>
                <textarea id="retake-reason" rows="3" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-transparent resize-none" placeholder="Enter reason for allowing retake (e.g., technical issues, student request)..."></textarea>
              </div>
            </div>
          `,
          width: '650px',
          showCancelButton: true,
          confirmButtonText: '<i class="fas fa-redo mr-2"></i>Allow Retake',
          cancelButtonText: 'Cancel',
          confirmButtonColor: '#0059cc',
          cancelButtonColor: '#6b7280',
          customClass: {
            popup: 'swal2-popup-responsive',
            htmlContainer: 'p-0'
          },
          didOpen: () => {
            // Setup select all functionality
            const selectAllBtn = document.getElementById('select-all-btn');
            const checkboxes = document.querySelectorAll('.subject-checkbox');
            
            selectAllBtn.addEventListener('click', function() {
              const allChecked = Array.from(checkboxes).every(cb => cb.checked);
              
              checkboxes.forEach(checkbox => {
                checkbox.checked = !allChecked;
              });
              
              // Update button text
              if (allChecked) {
                selectAllBtn.innerHTML = '<i class="fas fa-check-square mr-1"></i>Select All';
              } else {
                selectAllBtn.innerHTML = '<i class="fas fa-square mr-1"></i>Deselect All';
              }
            });
            
            // Update button text based on checkbox states
            checkboxes.forEach(checkbox => {
              checkbox.addEventListener('change', function() {
                const allChecked = Array.from(checkboxes).every(cb => cb.checked);
                if (allChecked) {
                  selectAllBtn.innerHTML = '<i class="fas fa-square mr-1"></i>Deselect All';
                } else {
                  selectAllBtn.innerHTML = '<i class="fas fa-check-square mr-1"></i>Select All';
                }
              });
            });
          },
          preConfirm: () => {
            const selectedCheckboxes = document.querySelectorAll('.subject-checkbox:checked');
            const reason = document.getElementById('retake-reason').value;
            
            if (selectedCheckboxes.length === 0) {
              Swal.showValidationMessage('Please select at least one evaluation to retake');
              return false;
            }
            
            if (!reason.trim()) {
              Swal.showValidationMessage('Please provide a reason for the retake');
              return false;
            }
            
            return {
              evaluation_ids: Array.from(selectedCheckboxes).map(cb => cb.value),
              checkboxes: selectedCheckboxes,
              reason: reason
            };
          }
        });
        
        if (formData) {
          // Show confirmation with selected evaluations
          const selectedEvals = Array.from(formData.checkboxes).map(cb => {
            const isExpired = cb.dataset.status === 'Expired';
            const statusIcon = isExpired ? '<i class="fas fa-clock text-red-500 mr-1"></i>' : '<i class="fas fa-check-circle text-green-500 mr-1"></i>';
            return `<li>${statusIcon}${cb.dataset.course} - ${cb.dataset.faculty}</li>`;
          }).join('');
          
          const confirmResult = await Swal.fire({
            title: 'Confirm Retake Permission',
            html: `
              <div class="text-left">
                <p class="mb-3">Are you sure you want to allow <strong>${student.first_name} ${student.last_name}</strong> to retake the following ${formData.evaluation_ids.length} evaluation(s)?</p>
                <ul class="list-disc list-inside text-sm text-gray-700 space-y-1 mb-3">
                  ${selectedEvals}
                </ul>
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mt-3">
                  <p class="text-xs text-yellow-800">
                    <i class="fas fa-exclamation-triangle mr-1"></i>
                    <strong>Note:</strong> This will reset the status to "Pending" and delete all previous responses for completed evaluations. Expired evaluations will be given a fresh start.
                  </p>
                </div>
              </div>
            `,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#0059cc',
            cancelButtonColor: '#6b7280',
            confirmButtonText: 'Yes, Allow Retake',
            cancelButtonText: 'Cancel',
            width: 600
          });
          
          if (confirmResult.isConfirmed) {
            // Show loading
            Swal.fire({
              title: 'Processing...',
              text: `Granting retake permission for ${formData.evaluation_ids.length} evaluation(s)...`,
              allowOutsideClick: false,
              showConfirmButton: false,
              willOpen: () => {
                Swal.showLoading();
              }
            });
            
            // Send retake request to admin endpoint
            try {
              const retakeResponse = await fetch('/api/admin/allow-retake', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  student_number: student.student_number,
                  evaluation_ids: formData.evaluation_ids,
                  reason: formData.reason
                })
              });
              
              const retakeResult = await retakeResponse.json();
              
              if (retakeResult.success) {
                Swal.fire({
                  icon: 'success',
                  title: 'Success!',
                  text: `Retake permission granted for ${formData.evaluation_ids.length} evaluation(s)`,
                  timer: 2000,
                  showConfirmButton: false
                });
                
                // Refresh student data
                loadStudentData();
              } else {
                Swal.fire({
                  icon: 'error',
                  title: 'Failed',
                  text: retakeResult.message || 'Failed to grant retake permission',
                  confirmButtonColor: '#0059cc'
                });
              }
            } catch (error) {
              console.error('Error granting retake:', error);
              Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Error granting retake permission: ' + error.message,
                confirmButtonColor: '#0059cc'
              });
            }
          }
        }
        
      } catch (error) {
        console.error('Error fetching evaluations:', error);
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Failed to load evaluation history. Please try again.'
        });
      }
    }
    
    // Show error message
    function showError(message) {
      const tableBody = document.getElementById('student-table-body');
      tableBody.innerHTML = `
        <tr>
          <td colspan="5" class="px-6 py-8 text-center">
            <div class="text-red-500">
              <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
              <p>${message}</p>
              <button onclick="loadStudentData()" class="mt-2 text-blue-600 hover:text-blue-800">
                <i class="fas fa-retry mr-1"></i> Retry
              </button>
            </div>
          </td>
        </tr>
      `;
      
      if (typeof Swal !== 'undefined') {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: message,
          toast: true,
          position: 'top-end',
          showConfirmButton: false,
          timer: 5000
        });
      }
    }
    
    // Archive student
    async function archiveStudent(student) {
      const result = await Swal.fire({
        title: 'Archive Student?',
        html: `
          <p>Are you sure you want to archive <strong>${student.first_name} ${student.last_name}</strong>?</p>
          <p class="text-sm text-gray-600 mt-2">Archived students will be hidden from the main list but can be restored later.</p>
        `,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#dc2626',
        cancelButtonColor: '#6b7280',
        confirmButtonText: '<i class="fas fa-archive mr-2"></i>Yes, Archive',
        cancelButtonText: 'Cancel'
      });
      
      if (result.isConfirmed) {
        try {
          const response = await fetch(`/api/students/${student.id}/archive`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json'
            }
          });
          
          const apiResult = await response.json();
          
          if (apiResult.success) {
            Swal.fire({
              icon: 'success',
              title: 'Archived!',
              text: 'Student has been archived successfully.',
              toast: true,
              position: 'top-end',
              showConfirmButton: false,
              timer: 3000,
              timerProgressBar: true
            });
            
            // Reload student data
            loadStudentData();
          } else {
            Swal.fire({
              icon: 'error',
              title: 'Error',
              text: apiResult.error || 'Failed to archive student',
              confirmButtonColor: '#0059cc'
            });
          }
        } catch (error) {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'An error occurred while archiving the student',
            confirmButtonColor: '#0059cc'
          });
          console.error('Error archiving student:', error);
        }
      }
    }
  </script>

  <!-- Include admin navigation script -->
  <script src="{{ url_for('static', filename='js/admin-navigation.js') }}"></script>
  
  <!-- Include loading animation script -->
  <script src="{{ url_for('static', filename='js/loading-animation.js') }}"></script>

  <!-- Prevent logout on browser back button -->
  <script src="{{ url_for('static', filename='js/prevent-back-logout.js') }}"></script>

  <!-- Session Timeout Monitor (Auto-logout after 1 hour) -->
  <script src="{{ url_for('static', filename='js/session-timeout.js') }}"></script>

</body>
</html>