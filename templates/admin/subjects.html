<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Courses & Classes | IntellEvalPro</title>
  
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/nclogo.png') }}">
  <link rel="shortcut icon" type="image/png" href="{{ url_for('static', filename='images/nclogo.png') }}">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='images/nclogo.png') }}">

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  
  <!-- SweetAlert2 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.12/dist/sweetalert2.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.12/dist/sweetalert2.all.min.js"></script>
  
  <script>
    tailwind.config = {
      theme: {
        fontFamily: {
          'sans': ['Inter', 'system-ui', 'sans-serif'],
        },
        extend: {
          colors: {
            primary: {
              50: '#e6f0ff',
              100: '#b3d1ff',
              200: '#80b3ff',
              300: '#4d94ff', 
              400: '#1a75ff',
              500: '#0059cc',
              600: '#004db3',
              700: '#004099',
              800: '#003380',
              900: '#002766',
            },
            secondary: {
              50: '#f5f7fa',
              100: '#e4e7eb',
              200: '#cbd2d9',
              300: '#9aa5b1',
              400: '#7b8794',
              500: '#616e7c',
              600: '#52606d',
              700: '#3e4c59',
              800: '#323f4b',
              900: '#1f2933',
            },
          },
        }
      }
    }
  </script>
  
  <style>
    /* Prevent horizontal overflow */
    body, html {
      overflow-x: hidden;
      max-width: 100vw;
    }

    #main-content {
      overflow-x: hidden;
    }

    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }

    /* Active nav link */
    .nav-link.active {
      position: relative;
    }
    
    .nav-link.active::after {
      content: '';
      position: absolute;
      left: 0;
      width: 4px;
      height: 100%;
      background-color: #0059cc;
      border-radius: 0 2px 2px 0;
    }

    /* Responsive table styles */
    @media (max-width: 768px) {
      /* Hide Program and Units columns on mobile */
      #courses-table thead th:nth-child(3),
      #courses-table tbody td:nth-child(3),
      #courses-table thead th:nth-child(4),
      #courses-table tbody td:nth-child(4) {
        display: none;
      }
    }

    @media (max-width: 640px) {
      /* Stack action buttons on small mobile */
      .action-buttons {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }
    }

    /* Responsive modal styles */
    @media (max-width: 768px) {
      .swal2-popup {
        width: 95% !important;
        max-width: 95% !important;
        padding: 1rem !important;
      }

      .swal2-title {
        font-size: 1.25rem !important;
      }
    }
  </style>
</head>
<body class="bg-gray-50 font-sans overflow-x-hidden">
  
  <!-- Loading overlay -->
  <div id="loader-overlay" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-white bg-opacity-90 backdrop-blur-sm transition-opacity duration-300">
    <img src="{{ url_for('static', filename='images/nclogo.png') }}" alt="Logo" class="w-32 h-auto mb-6 animate-bounce">
    <div class="flex items-center space-x-2">
      <div class="w-3 h-3 rounded-full bg-primary-500 animate-pulse"></div>
      <div class="w-3 h-3 rounded-full bg-primary-500 animate-pulse" style="animation-delay: 0.2s"></div>
      <div class="w-3 h-3 rounded-full bg-primary-500 animate-pulse" style="animation-delay: 0.4s"></div>
    </div>
  </div>

  <div class="flex h-screen bg-gray-50">
    <!-- Admin Sidebar -->
    <div id="admin-sidebar"></div>
    
    <!-- Main content -->
    <div class="lg:ml-64 flex flex-col flex-1 min-h-screen">
      <!-- Admin Header -->
      <div id="admin-header"></div>

      <!-- Main content area -->
      <main id="main-content" class="flex-1 overflow-auto p-4 md:p-6 bg-gray-50">
        <!-- Page header -->
        <div class="mb-4 md:mb-6">
          <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
            <div>
              <h1 class="text-xl sm:text-2xl font-bold text-gray-800">Subjects Management</h1>
              <p class="text-sm sm:text-base text-gray-500 mt-1">Manage academic subjects and course information</p>
            </div>
            <div class="w-full sm:w-auto">
              <button type="button" id="add-course-btn" class="w-full sm:w-auto inline-flex items-center justify-center px-4 py-2 bg-primary-500 text-white font-medium rounded-lg hover:bg-primary-600 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 transition-colors duration-200">
                <i class="fas fa-plus mr-2"></i>
                Add Subject
              </button>
            </div>
          </div>
        </div>

        <!-- Statistics Cards -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4 mb-4 md:mb-6">
          <div class="bg-white rounded-lg shadow-sm p-4 sm:p-5 md:p-6 hover:shadow-md transition-all">
            <div class="flex items-center">
              <div class="p-2.5 sm:p-3 rounded-full bg-blue-100">
                <i class="fas fa-book text-blue-600 text-lg sm:text-xl"></i>
              </div>
              <div class="ml-3 sm:ml-4">
                <h3 class="text-xl sm:text-2xl font-bold text-gray-800" id="total-courses">0</h3>
                <p class="text-gray-600 text-xs sm:text-sm">Total Subjects</p>
              </div>
            </div>
          </div>
          <div class="bg-white rounded-lg shadow-sm p-4 sm:p-5 md:p-6 hover:shadow-md transition-all">
            <div class="flex items-center">
              <div class="p-2.5 sm:p-3 rounded-full bg-green-100">
                <i class="fas fa-graduation-cap text-green-600 text-lg sm:text-xl"></i>
              </div>
              <div class="ml-3 sm:ml-4">
                <h3 class="text-xl sm:text-2xl font-bold text-gray-800" id="total-departments">0</h3>
                <p class="text-gray-600 text-xs sm:text-sm">Departments</p>
              </div>
            </div>
          </div>
          <div class="bg-white rounded-lg shadow-sm p-4 sm:p-5 md:p-6 hover:shadow-md transition-all">
            <div class="flex items-center">
              <div class="p-2.5 sm:p-3 rounded-full bg-purple-100">
                <i class="fas fa-chart-line text-purple-600 text-lg sm:text-xl"></i>
              </div>
              <div class="ml-3 sm:ml-4">
                <h3 class="text-xl sm:text-2xl font-bold text-gray-800" id="total-units">0</h3>
                <p class="text-gray-600 text-xs sm:text-sm">Total Units</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Filters and search section -->
        <div class="bg-white rounded-lg shadow-sm p-3 sm:p-4 mb-4 md:mb-6">
          <div class="flex flex-col sm:flex-row gap-3 sm:gap-4">
            <div class="flex-grow">
              <div class="relative">
                <input type="text" id="search-courses" placeholder="Search courses or sections..." class="w-full pl-9 sm:pl-10 pr-3 sm:pr-4 py-2 sm:py-2.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-sm"></i>
              </div>
            </div>
            <div class="w-full sm:w-64">
              <select id="department-filter" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
                <option value="">All Departments</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Courses and Sections Table -->
        <div class="bg-white rounded-lg shadow-sm overflow-hidden mb-4 md:mb-6">
          <div class="overflow-x-auto">
            <table id="courses-table" class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-3 sm:px-4 md:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Subject Code</th>
                  <th class="px-3 sm:px-4 md:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Subject Name</th>
                  <th class="hidden md:table-cell px-3 sm:px-4 md:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Department</th>
                  <th class="hidden md:table-cell px-3 sm:px-4 md:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Units</th>
                  <th class="px-3 sm:px-4 md:px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Sections</th>
                  <th class="px-3 sm:px-4 md:px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                </tr>
              </thead>
              <tbody id="courses-table-body" class="bg-white divide-y divide-gray-200">
                <!-- Subject rows will be dynamically generated here -->
                <tr>
                  <td colspan="6" class="px-3 sm:px-6 py-8 sm:py-12 text-center text-gray-500">
                    <i class="fas fa-spinner fa-spin text-2xl sm:text-3xl mb-3"></i>
                    <p class="text-sm sm:text-base">Loading subjects...</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          
          <!-- Pagination -->
          <div class="bg-white px-3 sm:px-4 md:px-6 py-3 border-t border-gray-200">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
              <div>
                <p id="pagination-info" class="text-xs sm:text-sm text-gray-700">
                  Showing <span class="font-medium">1</span> to <span class="font-medium">10</span> of <span class="font-medium">45</span> courses
                </p>
              </div>
              <div>
                <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                  <!-- Pagination buttons will be dynamically generated here -->
                </nav>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Assign Section Modal -->
  <div id="assign-section-modal" class="hidden fixed inset-0 z-50 overflow-y-auto" aria-labelledby="assign-section-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
      <!-- Background overlay -->
      <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>

      <!-- Modal panel -->
      <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full">
        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
          <div class="sm:flex sm:items-start">
            <div class="mt-3 text-center sm:mt-0 sm:text-left w-full">
              <h3 class="text-lg leading-6 font-medium text-gray-900" id="assign-section-title">
                Assign Sections to <span id="subject-title-display"></span>
              </h3>
              
              <div class="mt-4">
                <!-- Info Box -->
                <div class="mb-6 p-4 bg-blue-50 border-l-4 border-blue-400 rounded">
                  <div class="flex">
                    <div class="flex-shrink-0">
                      <i class="fas fa-info-circle text-blue-400"></i>
                    </div>
                    <div class="ml-3">
                      <p class="text-sm text-blue-700">
                        Assign sections that have students to this subject. Only sections with enrolled students can be assigned.
                      </p>
                    </div>
                  </div>
                </div>

                <!-- Add Section -->
                <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                  <h4 class="text-md font-medium text-gray-800 mb-3">Assign New Section</h4>
                  <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
                    <div>
                      <label for="section-select" class="block text-sm font-medium text-gray-700 mb-1">Select Section (with students)</label>
                      <select id="section-select" class="w-full border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500">
                        <option value="">Select a section...</option>
                      </select>
                    </div>
                    <div>
                      <label for="faculty-select" class="block text-sm font-medium text-gray-700 mb-1">Assign Faculty <span class="text-red-500">*</span></label>
                      <select id="faculty-select" class="w-full border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500">
                        <option value="">Select a faculty...</option>
                      </select>
                    </div>
                    <div>
                      <label for="term-select" class="block text-sm font-medium text-gray-700 mb-1">Academic Term <span class="text-red-500">*</span></label>
                      <select id="term-select" class="w-full border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500">
                        <option value="">Select a term...</option>
                      </select>
                    </div>
                  </div>
                  <div class="flex justify-end">
                    <button type="button" id="assign-section-btn" class="px-4 py-2 bg-primary-600 text-white rounded-md hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500">
                      <i class="fas fa-plus mr-1"></i> Assign Section
                    </button>
                  </div>
                </div>

                <!-- Assigned Sections Table -->
                <div>
                  <h4 class="text-md font-medium text-gray-800 mb-3">Assigned Sections</h4>
                  <div class="border rounded-lg overflow-hidden">
                    <div class="overflow-x-auto max-h-96">
                      <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                          <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Section Code</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Section Name</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Faculty</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Term</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Year Level</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Students</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                          </tr>
                        </thead>
                        <tbody id="assigned-sections-tbody" class="bg-white divide-y divide-gray-200">
                          <tr>
                            <td colspan="8" class="px-4 py-8 text-center text-gray-500">
                              <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                              <p>Loading sections...</p>
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
          <button type="button" id="close-section-modal-btn" class="w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 sm:w-auto sm:text-sm">
            Close
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Course Modal -->
  <div id="add-course-modal" class="hidden fixed inset-0 z-50 overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
      <!-- Background overlay -->
      <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>

      <!-- Modal panel -->
      <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
          <div class="sm:flex sm:items-start">
            <div class="mt-3 text-center sm:mt-0 sm:text-left w-full">
              <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                Add New Subject
              </h3>
              <div class="mt-4">
                <form id="add-course-form" class="space-y-4">
                  <div>
                    <label for="course-code" class="block text-sm font-medium text-gray-700">Subject Code</label>
                    <input type="text" id="course-code" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500 sm:text-sm" placeholder="e.g., CS101">
                  </div>
                  <div>
                    <label for="course-name" class="block text-sm font-medium text-gray-700">Subject Name</label>
                    <input type="text" id="course-name" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500 sm:text-sm" placeholder="e.g., Introduction to Programming">
                  </div>
                  <div>
                    <label for="course-units" class="block text-sm font-medium text-gray-700">Units</label>
                    <input type="number" id="course-units" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500 sm:text-sm" placeholder="3">
                  </div>
                  <div>
                    <label for="course-department" class="block text-sm font-medium text-gray-700">Department</label>
                    <select id="course-department" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500 sm:text-sm">
                      <option value="">Select Department</option>
                    </select>
                  </div>
                  <div>
                    <label for="course-description" class="block text-sm font-medium text-gray-700">Description</label>
                    <textarea id="course-description" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-primary-500 focus:border-primary-500 sm:text-sm" placeholder="Course description..."></textarea>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
        <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
          <button type="button" id="save-course-btn" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-primary-600 text-base font-medium text-white hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 sm:ml-3 sm:w-auto sm:text-sm">
            Add Subject
          </button>
          <button type="button" id="cancel-course-btn" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
            Cancel
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Pagination variables
    let currentPage = 1;
    const itemsPerPage = 10;
    let subjectsData = []; // This will hold your subjects data
    let filteredData = []; // This will hold filtered results
    let departmentsData = []; // Departments list
    let editingSubjectId = null; // Track if we're editing a subject
    let currentSubjectId = null; // Track current subject for student management
    let allStudents = []; // Store all available students
    
    document.addEventListener('DOMContentLoaded', function() {
      // Load initial data
      loadSubjects();
      loadDepartments();
      
      // Modal functionality - Add Course
      const addCourseBtn = document.getElementById('add-course-btn');
      const addCourseModal = document.getElementById('add-course-modal');
      const cancelCourseBtn = document.getElementById('cancel-course-btn');
      const saveCourseBtn = document.getElementById('save-course-btn');

      addCourseBtn.addEventListener('click', function() {
        editingSubjectId = null;
        document.getElementById('modal-title').textContent = 'Add New Subject';
        saveCourseBtn.textContent = 'Add Subject';
        document.getElementById('add-course-form').reset();
        addCourseModal.classList.remove('hidden');
      });

      cancelCourseBtn.addEventListener('click', function() {
        addCourseModal.classList.add('hidden');
        editingSubjectId = null;
      });

      saveCourseBtn.addEventListener('click', function() {
        saveSubject();
      });

      // Search functionality
      const searchInput = document.getElementById('search-courses');
      searchInput.addEventListener('input', function() {
        // Reset to page 1 when searching
        currentPage = 1;
        applyFilters();
      });

      // Filter functionality
      const departmentFilter = document.getElementById('department-filter');

      departmentFilter.addEventListener('change', function() {
        currentPage = 1;
        applyFilters();
      });

      // Assign Section Modal functionality
      const assignSectionModal = document.getElementById('assign-section-modal');
      const closeSectionModalBtn = document.getElementById('close-section-modal-btn');
      
      closeSectionModalBtn.addEventListener('click', function() {
        assignSectionModal.classList.add('hidden');
        currentSubjectId = null;
      });

      // Assign section to subject
      const assignSectionBtn = document.getElementById('assign-section-btn');
      assignSectionBtn.addEventListener('click', function() {
        assignSectionToSubject();
      });

      // Close modal when clicking outside
      window.addEventListener('click', function(event) {
        const addCourseModal = document.getElementById('add-course-modal');
        const assignSectionModal = document.getElementById('assign-section-modal');
        
        if (event.target === addCourseModal) {
          addCourseModal.classList.add('hidden');
          editingSubjectId = null;
        }
        
        if (event.target === assignSectionModal) {
          assignSectionModal.classList.add('hidden');
          currentSubjectId = null;
        }
      });
    });
    
    // Load subjects data from API
    function loadSubjects() {
      fetch('/api/subjects')
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            subjectsData = data.data;
            filteredData = subjectsData;
            renderSubjectsTable();
            renderPagination(filteredData.length);
            
            // Update statistics cards with real data
            if (data.stats) {
              updateStatistics(data.stats);
            }
          } else {
            showError('Failed to load subjects: ' + (data.error || 'Unknown error'));
          }
        })
        .catch(error => {
          console.error('Error loading subjects:', error);
          showError('Failed to load subjects. Please try again.');
        });
    }
    
    // Update statistics cards
    function updateStatistics(stats) {
      // Update Total Subjects
      const totalCoursesEl = document.getElementById('total-courses');
      if (totalCoursesEl) {
        totalCoursesEl.textContent = stats.total_subjects || 0;
      }
      
      // Update Total Departments
      const totalDepartmentsEl = document.getElementById('total-departments');
      if (totalDepartmentsEl) {
        totalDepartmentsEl.textContent = stats.total_departments || 0;
      }
      
      // Update Total Units
      const totalUnitsEl = document.getElementById('total-units');
      if (totalUnitsEl) {
        totalUnitsEl.textContent = stats.total_units || 0;
      }
    }
    
    // Load departments
    function loadDepartments() {
      fetch('/api/programs')
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            departmentsData = data.data;
            populateDepartmentDropdown();
            populateDepartmentFilter();
          }
        })
        .catch(error => console.error('Error loading programs:', error));
    }
    
    // Populate department dropdown in Add/Edit form
    function populateDepartmentDropdown() {
      const select = document.getElementById('course-department');
      select.innerHTML = '<option value="">Select Department</option>';
      departmentsData.forEach(dept => {
        const option = document.createElement('option');
        option.value = dept.program_id;
        option.textContent = `${dept.program_code} - ${dept.name}`;
        select.appendChild(option);
      });
    }
    
    // Populate department filter
    function populateDepartmentFilter() {
      const select = document.getElementById('department-filter');
      select.innerHTML = '<option value="">All Departments</option>';
      departmentsData.forEach(dept => {
        const option = document.createElement('option');
        option.value = dept.program_id;
        option.textContent = dept.name; // Show full department name from programs table
        select.appendChild(option);
      });
    }
    
    // Save subject (create or update)
    function saveSubject() {
      const courseCode = document.getElementById('course-code').value.trim();
      const courseName = document.getElementById('course-name').value.trim();
      const courseUnits = document.getElementById('course-units').value;
      const courseDepartment = document.getElementById('course-department').value;
      const courseDescription = document.getElementById('course-description').value.trim();
      
      // Validation
      if (!courseCode || !courseName || !courseUnits || !courseDepartment) {
        Swal.fire({
          icon: 'error',
          title: 'Validation Error',
          text: 'Please fill in all required fields',
          confirmButtonColor: '#3B82F6'
        });
        return;
      }
      
      const subjectData = {
        subject_code: courseCode,
        title: courseName,
        units: parseInt(courseUnits),
        program_id: parseInt(courseDepartment),
        description: courseDescription
      };
      
      const url = editingSubjectId ? `/api/subjects/${editingSubjectId}` : '/api/subjects';
      const method = editingSubjectId ? 'PUT' : 'POST';
      
      fetch(url, {
        method: method,
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(subjectData)
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          Swal.fire({
            icon: 'success',
            title: editingSubjectId ? 'Subject Updated!' : 'Subject Added!',
            text: data.message,
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true
          });
          document.getElementById('add-course-modal').classList.add('hidden');
          document.getElementById('add-course-form').reset();
          editingSubjectId = null;
          loadSubjects(); // Reload subjects
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: data.error || 'Failed to save subject',
            confirmButtonColor: '#3B82F6'
          });
        }
      })
      .catch(error => {
        console.error('Error saving subject:', error);
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Failed to save subject. Please try again.',
          confirmButtonColor: '#3B82F6'
        });
      });
    }
    
    // Edit subject
    function editSubject(subjectId) {
      const subject = subjectsData.find(s => s.subject_id === subjectId);
      if (!subject) return;
      
      editingSubjectId = subjectId;
      
      // Populate form
      document.getElementById('course-code').value = subject.subject_code;
      document.getElementById('course-name').value = subject.subject_name;
      document.getElementById('course-units').value = subject.units;
      document.getElementById('course-department').value = subject.department_id;
      document.getElementById('course-description').value = subject.description || '';
      
      // Update modal title and button
      document.getElementById('modal-title').textContent = 'Edit Subject';
      document.getElementById('save-course-btn').textContent = 'Update Subject';
      
      // Show modal
      document.getElementById('add-course-modal').classList.remove('hidden');
    }
    
    // Delete subject
    function deleteSubject(subjectId) {
      const subject = subjectsData.find(s => s.subject_id === subjectId);
      if (!subject) return;
      
      Swal.fire({
        title: 'Delete Subject?',
        text: `Are you sure you want to delete "${subject.subject_code} - ${subject.subject_name}"?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#EF4444',
        cancelButtonColor: '#6B7280',
        confirmButtonText: 'Yes, delete it!',
        cancelButtonText: 'Cancel'
      }).then((result) => {
        if (result.isConfirmed) {
          fetch(`/api/subjects/${subjectId}`, {
            method: 'DELETE'
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              Swal.fire({
                icon: 'success',
                title: 'Deleted!',
                text: data.message,
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true
              });
              loadSubjects();
            } else {
              Swal.fire({
                icon: 'error',
                title: 'Error',
                text: data.error || 'Failed to delete subject',
                confirmButtonColor: '#3B82F6'
              });
            }
          })
          .catch(error => {
            console.error('Error deleting subject:', error);
            Swal.fire({
              icon: 'error',
              title: 'Error',
              text: 'Failed to delete subject. Please try again.',
              confirmButtonColor: '#3B82F6'
            });
          });
        }
      });
    }
    
    // Render subjects table
    function renderSubjectsTable() {
      const tbody = document.getElementById('courses-table-body');
      
      if (!filteredData || filteredData.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6" class="px-3 sm:px-6 py-8 sm:py-12 text-center text-gray-500">
              <i class="fas fa-folder-open text-2xl sm:text-3xl mb-3"></i>
              <p class="text-sm sm:text-base">No subjects found</p>
            </td>
          </tr>
        `;
        return;
      }
      
      // Calculate pagination
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const paginatedData = filteredData.slice(startIndex, endIndex);
      
      let html = '';
      paginatedData.forEach(subject => {
        html += `
          <tr class="hover:bg-gray-50">
            <td class="px-3 sm:px-4 md:px-6 py-3 sm:py-4 whitespace-nowrap">
              <div class="text-xs sm:text-sm font-medium text-gray-900">${escapeHtml(subject.subject_code)}</div>
            </td>
            <td class="px-3 sm:px-4 md:px-6 py-3 sm:py-4">
              <div class="text-xs sm:text-sm font-medium text-gray-900">${escapeHtml(subject.subject_name)}</div>
              ${subject.description ? `<div class="text-xs sm:text-sm text-gray-500 mt-1">${escapeHtml(subject.description.substring(0, 60))}${subject.description.length > 60 ? '...' : ''}</div>` : ''}
              <!-- Mobile inline data: Program and Units -->
              <div class="md:hidden text-xs text-gray-500 mt-2 space-y-1">
                <div>
                  <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                    ${escapeHtml(subject.department_name || 'No Department')}
                  </span>
                </div>
                <div class="font-medium text-gray-700">${subject.units} ${subject.units !== 1 ? 'Units' : 'Unit'}</div>
              </div>
            </td>
            <td class="hidden md:table-cell px-3 sm:px-4 md:px-6 py-3 sm:py-4 whitespace-nowrap">
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                ${escapeHtml(subject.department_name || 'No Department')}
              </span>
            </td>
            <td class="hidden md:table-cell px-3 sm:px-4 md:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-900">
              <span class="font-medium">${subject.units} ${subject.units !== 1 ? 'Units' : 'Unit'}</span>
            </td>
            <td class="px-3 sm:px-4 md:px-6 py-3 sm:py-4 whitespace-nowrap text-center">
              <span class="inline-flex items-center px-2 sm:px-3 py-0.5 sm:py-1 rounded-full text-xs sm:text-sm font-semibold ${subject.section_count > 0 ? 'bg-purple-100 text-purple-800' : 'bg-gray-100 text-gray-600'}">
                <i class="fas fa-layer-group mr-1 sm:mr-1.5"></i>
                ${subject.section_count || 0}
              </span>
            </td>
            <td class="px-3 sm:px-4 md:px-6 py-3 sm:py-4 whitespace-nowrap text-right">
              <div class="flex flex-col sm:flex-row justify-end gap-1 sm:gap-3">
                <button class="inline-flex items-center justify-center px-2 py-1.5 text-xs sm:text-sm text-blue-600 hover:text-blue-900 hover:bg-blue-50 rounded transition-colors" onclick="viewSubject(${subject.subject_id})" title="View Details">
                  <i class="fas fa-eye mr-1"></i>
                  <span class="hidden sm:inline">View</span>
                </button>
                <button class="inline-flex items-center justify-center px-2 py-1.5 text-xs sm:text-sm text-purple-600 hover:text-purple-900 hover:bg-purple-50 rounded transition-colors" onclick="assignSection(${subject.subject_id})" title="Assign Section">
                  <i class="fas fa-layer-group mr-1"></i>
                  <span class="hidden sm:inline">Assign</span>
                </button>
                <button class="inline-flex items-center justify-center px-2 py-1.5 text-xs sm:text-sm text-green-600 hover:text-green-900 hover:bg-green-50 rounded transition-colors" onclick="editSubject(${subject.subject_id})" title="Edit Subject">
                  <i class="fas fa-edit mr-1"></i>
                  <span class="hidden sm:inline">Edit</span>
                </button>
                <button class="inline-flex items-center justify-center px-2 py-1.5 text-xs sm:text-sm text-red-600 hover:text-red-900 hover:bg-red-50 rounded transition-colors" onclick="deleteSubject(${subject.subject_id})" title="Delete Subject">
                  <i class="fas fa-trash mr-1"></i>
                  <span class="hidden sm:inline">Delete</span>
                </button>
              </div>
            </td>
          </tr>
        `;
      });
      
      tbody.innerHTML = html;
    }
    
    // View subject details
    function viewSubject(subjectId) {
      const subject = subjectsData.find(s => s.subject_id === subjectId);
      if (!subject) return;
      
      Swal.fire({
        title: subject.subject_code + ' - ' + subject.subject_name,
        html: `
          <div class="text-left space-y-3">
            <div>
              <p class="text-sm font-medium text-gray-700">Program:</p>
              <p class="text-sm text-gray-900">${escapeHtml(subject.department_name || 'N/A')}</p>
            </div>
            ${subject.program_code ? `
              <div>
                <p class="text-sm font-medium text-gray-700">Program Code:</p>
                <p class="text-sm text-gray-900">${escapeHtml(subject.program_code)}</p>
              </div>
            ` : ''}
            <div>
              <p class="text-sm font-medium text-gray-700">Units:</p>
              <p class="text-sm text-gray-900">${subject.units}</p>
            </div>
            ${subject.description ? `
              <div>
                <p class="text-sm font-medium text-gray-700">Description:</p>
                <p class="text-sm text-gray-900">${escapeHtml(subject.description)}</p>
              </div>
            ` : ''}
          </div>
        `,
        confirmButtonText: 'Close',
        confirmButtonColor: '#3B82F6',
        width: '500px'
      });
    }
    
    // Helper function to escape HTML
    function escapeHtml(text) {
      if (!text) return '';
      const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      };
      return text.toString().replace(/[&<>"']/g, m => map[m]);
    }
    
    // Show error message
    function showError(message) {
      const tbody = document.getElementById('courses-table-body');
      tbody.innerHTML = `
        <tr>
          <td colspan="6" class="px-6 py-12 text-center text-red-500">
            <i class="fas fa-exclamation-circle text-3xl mb-3"></i>
            <p>${escapeHtml(message)}</p>
            <button onclick="loadSubjects()" class="mt-3 text-primary-600 hover:text-primary-800">
              <i class="fas fa-redo mr-1"></i> Retry
            </button>
          </td>
        </tr>
      `;
    }
    
    // Apply filters
    function applyFilters() {
      const searchInput = document.getElementById('search-courses');
      const departmentFilter = document.getElementById('department-filter');
      
      const searchTerm = searchInput.value.toLowerCase();
      const selectedDept = departmentFilter.value;
      
      filteredData = subjectsData.filter(subject => {
        // Search filter
        const matchesSearch = !searchTerm || 
          subject.subject_code.toLowerCase().includes(searchTerm) ||
          subject.subject_name.toLowerCase().includes(searchTerm) ||
          (subject.department_name && subject.department_name.toLowerCase().includes(searchTerm));
        
        // Department filter
        const matchesDept = !selectedDept || 
          (subject.department_id && subject.department_id.toString() === selectedDept);
        
        return matchesSearch && matchesDept;
      });
      
      currentPage = 1;
      renderSubjectsTable();
      renderPagination(filteredData.length);
    }
    
    // Initialize pagination (removed - now called from loadSubjects)
    
    // Render pagination controls
    function renderPagination(totalItems) {
      const totalPages = Math.ceil(totalItems / itemsPerPage);
      const paginationNav = document.querySelector('nav[aria-label="Pagination"]');
      
      if (!paginationNav || totalPages <= 1) {
        if (paginationNav) {
          paginationNav.style.display = 'none';
        }
        updatePaginationInfo(totalItems);
        return;
      }
      
      paginationNav.style.display = 'inline-flex';
      
      let paginationHTML = '';
      
      // Previous button
      paginationHTML += `
        <a href="#" class="pagination-prev relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium ${currentPage === 1 ? 'text-gray-300 cursor-not-allowed' : 'text-gray-500 hover:bg-gray-50'}" ${currentPage === 1 ? 'disabled' : ''}>
          <span class="sr-only">Previous</span>
          <i class="fas fa-chevron-left"></i>
        </a>
      `;
      
      // Page numbers
      const maxVisiblePages = 7;
      let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
      let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
      
      if (endPage - startPage < maxVisiblePages - 1) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
      }
      
      // First page
      if (startPage > 1) {
        paginationHTML += `
          <a href="#" class="pagination-page bg-white border-gray-300 text-gray-500 hover:bg-gray-50 relative inline-flex items-center px-4 py-2 border text-sm font-medium" data-page="1">
            1
          </a>
        `;
        if (startPage > 2) {
          paginationHTML += `
            <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700">
              ...
            </span>
          `;
        }
      }
      
      // Page numbers
      for (let i = startPage; i <= endPage; i++) {
        if (i === currentPage) {
          paginationHTML += `
            <a href="#" aria-current="page" class="z-10 bg-primary-50 border-primary-500 text-primary-600 relative inline-flex items-center px-4 py-2 border text-sm font-medium">
              ${i}
            </a>
          `;
        } else {
          paginationHTML += `
            <a href="#" class="pagination-page bg-white border-gray-300 text-gray-500 hover:bg-gray-50 relative inline-flex items-center px-4 py-2 border text-sm font-medium" data-page="${i}">
              ${i}
            </a>
          `;
        }
      }
      
      // Last page
      if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
          paginationHTML += `
            <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700">
              ...
            </span>
          `;
        }
        paginationHTML += `
          <a href="#" class="pagination-page bg-white border-gray-300 text-gray-500 hover:bg-gray-50 relative inline-flex items-center px-4 py-2 border text-sm font-medium" data-page="${totalPages}">
            ${totalPages}
          </a>
        `;
      }
      
      // Next button
      paginationHTML += `
        <a href="#" class="pagination-next relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium ${currentPage === totalPages ? 'text-gray-300 cursor-not-allowed' : 'text-gray-500 hover:bg-gray-50'}" ${currentPage === totalPages ? 'disabled' : ''}>
          <span class="sr-only">Next</span>
          <i class="fas fa-chevron-right"></i>
        </a>
      `;
      
      paginationNav.innerHTML = paginationHTML;
      
      // Add event listeners to pagination controls
      paginationNav.querySelectorAll('.pagination-page').forEach(link => {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          const page = parseInt(this.dataset.page);
          goToPage(page);
        });
      });
      
      const prevButton = paginationNav.querySelector('.pagination-prev');
      if (prevButton && currentPage > 1) {
        prevButton.addEventListener('click', function(e) {
          e.preventDefault();
          goToPage(currentPage - 1);
        });
      }
      
      const nextButton = paginationNav.querySelector('.pagination-next');
      if (nextButton && currentPage < totalPages) {
        nextButton.addEventListener('click', function(e) {
          e.preventDefault();
          goToPage(currentPage + 1);
        });
      }
      
      updatePaginationInfo(totalItems);
    }
    
    // Go to specific page
    function goToPage(page) {
      const totalItems = filteredData.length || 45; // Replace with actual data
      const totalPages = Math.ceil(totalItems / itemsPerPage);
      if (page < 1 || page > totalPages) return;
      
      currentPage = page;
      renderPagination(totalItems);
      
      // Scroll to top of table
      document.querySelector('#courses-table').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    // Update pagination info text
    function updatePaginationInfo(totalItems) {
      const startIndex = (currentPage - 1) * itemsPerPage + 1;
      const endIndex = Math.min(currentPage * itemsPerPage, totalItems);
      
      const paginationInfo = document.getElementById('pagination-info');
      if (paginationInfo) {
        if (totalItems === 0) {
          paginationInfo.innerHTML = 'Showing 0 subjects';
        } else {
          paginationInfo.innerHTML = `
            Showing <span class="font-medium">${startIndex}</span> to <span class="font-medium">${endIndex}</span> of <span class="font-medium">${totalItems}</span> subjects
          `;
        }
      }
    }
    
    // ============ SECTION ASSIGNMENT FUNCTIONS ============
    
    // Assign sections to a subject
    function assignSection(subjectId) {
      currentSubjectId = subjectId;
      const subject = subjectsData.find(s => s.subject_id === subjectId);
      if (!subject) return;
      
      // Update modal title
      document.getElementById('subject-title-display').textContent = `${subject.subject_code} - ${subject.subject_name}`;
      
      // Load available sections (with students)
      loadAvailableSections();
      
      // Load faculty list
      loadFacultyList();
      
      // Load academic terms
      loadAcademicTerms();
      
      // Load assigned sections
      loadAssignedSections(subjectId);
      
      // Show modal
      document.getElementById('assign-section-modal').classList.remove('hidden');
    }
    
    // Load faculty list
    function loadFacultyList() {
      const select = document.getElementById('faculty-select');
      select.innerHTML = '<option value="">Loading faculty...</option>';
      
      fetch('/api/faculty')
        .then(response => response.json())
        .then(data => {
          console.log('Faculty API Response:', data);
          if (data.success) {
            select.innerHTML = '<option value="">Select a faculty...</option>';
            
            if (!data.data || data.data.length === 0) {
              select.innerHTML = '<option value="">No faculty available</option>';
              return;
            }
            
            data.data.forEach(faculty => {
              const option = document.createElement('option');
              option.value = faculty.faculty_id;
              option.textContent = `${faculty.first_name} ${faculty.last_name}${faculty.department_name ? ' - ' + faculty.department_name : ''}`;
              select.appendChild(option);
            });
          } else {
            console.error('Failed to load faculty:', data.error);
            select.innerHTML = '<option value="">Error loading faculty</option>';
          }
        })
        .catch(error => {
          console.error('Error loading faculty:', error);
          select.innerHTML = '<option value="">Error loading faculty</option>';
        });
    }
    
    // Load academic terms
    function loadAcademicTerms() {
      const select = document.getElementById('term-select');
      select.innerHTML = '<option value="">Loading terms...</option>';
      
      fetch('/api/terms')
        .then(response => response.json())
        .then(data => {
          console.log('Academic Terms API Response:', data);
          if (data.success) {
            select.innerHTML = '<option value="">Select a term...</option>';
            
            if (!data.data || data.data.length === 0) {
              select.innerHTML = '<option value="">No terms available</option>';
              return;
            }
            
            data.data.forEach(term => {
              const option = document.createElement('option');
              option.value = term.term_id;
              
              // Build the display text with academic year and term name
              let displayText = '';
              
              // Add academic year code if available
              if (term.year_code) {
                displayText += term.year_code;
              }
              
              // Add term name if available
              if (term.term_name) {
                displayText += (displayText ? ' - ' : '') + term.term_name;
              }
              
              // If no year_code or term_name, show a fallback
              if (!displayText) {
                displayText = 'Academic Term';
              }
              
              // Format dates for display
              const startDate = term.start_date ? new Date(term.start_date).toLocaleDateString() : '';
              const endDate = term.end_date ? new Date(term.end_date).toLocaleDateString() : '';
              const dateRange = startDate && endDate ? ` (${startDate} - ${endDate})` : '';
              
              // Add current badge if this is the current term
              const currentBadge = term.is_current ? ' ' : '';
              
              option.textContent = `${displayText}${dateRange}${currentBadge}`;
              select.appendChild(option);
            });
          } else {
            console.error('Failed to load academic terms:', data.error);
            select.innerHTML = '<option value="">Error loading terms</option>';
          }
        })
        .catch(error => {
          console.error('Error loading academic terms:', error);
          select.innerHTML = '<option value="">Error loading terms</option>';
        });
    }
    
    // Load available sections that have students
    function loadAvailableSections() {
      const select = document.getElementById('section-select');
      select.innerHTML = '<option value="">Loading sections...</option>';
      
      // First, get already assigned sections for this subject
      fetch(`/api/subjects/${currentSubjectId}/classes`)
        .then(response => response.json())
        .then(classesData => {
          // Get array of already assigned section_ref_ids
          const assignedSectionIds = [];
          if (classesData.success && classesData.classes) {
            classesData.classes.forEach(cls => {
              if (cls.section_ref_id) {
                assignedSectionIds.push(cls.section_ref_id);
              }
            });
          }
          
          // Now fetch all sections
          return fetch('/api/sections-master')
            .then(response => response.json())
            .then(data => {
              console.log('Sections API Response:', data);
              console.log('Already assigned section IDs:', assignedSectionIds);
              
              if (data.success) {
                // Filter sections that:
                // 1. Have students
                // 2. Are NOT already assigned to this subject
                const availableSections = data.data.filter(s => 
                  s.total_students > 0 && !assignedSectionIds.includes(s.section_id)
                );
                
                select.innerHTML = '<option value="">Select a section...</option>';
                
                if (availableSections.length === 0) {
                  select.innerHTML = '<option value="">No sections available</option>';
                  Swal.fire({
                    icon: 'info',
                    title: 'No Sections Available',
                    text: 'All sections either have no students or are already assigned to this subject.',
                    confirmButtonColor: '#3B82F6'
                  });
                  return;
                }
                
                availableSections.forEach(section => {
                  const option = document.createElement('option');
                  option.value = section.section_id;
                  option.textContent = `${section.section_code} - ${section.section_name} (${section.total_students} students)`;
                  option.dataset.programName = section.program_name;
                  option.dataset.yearLevel = section.year_level;
                  select.appendChild(option);
                });
              } else {
                console.error('Failed to load sections:', data.error);
                select.innerHTML = '<option value="">Error loading sections</option>';
              }
            });
        })
        .catch(error => {
          console.error('Error loading sections:', error);
          select.innerHTML = '<option value="">Error loading sections</option>';
        });
    }
    
    // Load assigned sections for a subject
    function loadAssignedSections(subjectId) {
      const tbody = document.getElementById('assigned-sections-tbody');
      tbody.innerHTML = `
        <tr>
          <td colspan="8" class="px-4 py-8 text-center text-gray-500">
            <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
            <p>Loading assigned sections...</p>
          </td>
        </tr>
      `;
      
      // Fetch classes for this subject to get assigned sections
      fetch(`/api/subjects/${subjectId}/classes`)
        .then(response => response.json())
        .then(data => {
          console.log('Subject Classes API Response:', data);
          if (data.success) {
            if (!data.classes || data.classes.length === 0) {
              tbody.innerHTML = `
                <tr>
                  <td colspan="8" class="px-4 py-8 text-center text-gray-500">
                    <i class="fas fa-layer-group text-3xl mb-2 text-gray-300"></i>
                    <p>No sections assigned yet</p>
                    <p class="text-xs text-gray-400 mt-1">Assign sections with students to this subject</p>
                  </td>
                </tr>
              `;
              return;
            }
            
            // Build a map of section_ref_id to class info (includes faculty and term)
            const classMap = {};
            data.classes.forEach(cls => {
              if (cls.section_ref_id) {
                classMap[cls.section_ref_id] = cls;
              }
            });
            
            // Get unique section IDs from classes
            const sectionIds = [...new Set(data.classes.map(cls => cls.section_ref_id).filter(id => id))];
            
            if (sectionIds.length === 0) {
              tbody.innerHTML = `
                <tr>
                  <td colspan="8" class="px-4 py-8 text-center text-gray-500">
                    <p>No valid sections found</p>
                  </td>
                </tr>
              `;
              return;
            }
            
            // Fetch section details
            fetch('/api/sections-master')
              .then(response => response.json())
              .then(sectionsData => {
                if (sectionsData.success) {
                  const assignedSections = sectionsData.data.filter(s => sectionIds.includes(s.section_id));
                  
                  if (assignedSections.length === 0) {
                    tbody.innerHTML = `
                      <tr>
                        <td colspan="8" class="px-4 py-8 text-center text-gray-500">
                          <p>No section details found</p>
                        </td>
                      </tr>
                    `;
                    return;
                  }
                  
                  let html = '';
                  assignedSections.forEach(section => {
                    const classInfo = classMap[section.section_id];
                    const facultyName = classInfo?.faculty_name || 'Not assigned';
                    // Handle term_name properly - check for undefined, null, or empty string
                    let termName = 'Not assigned';
                    if (classInfo && classInfo.term_name && classInfo.term_name !== 'undefined' && classInfo.term_name.trim() !== '') {
                      termName = classInfo.term_name;
                    }
                    const yearBadge = getYearLevelBadge(section.year_level);
                    html += `
                      <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3 text-sm font-medium text-gray-900">${escapeHtml(section.section_code)}</td>
                        <td class="px-4 py-3 text-sm text-gray-900">${escapeHtml(section.section_name)}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">
                          ${facultyName !== 'Not assigned' ? `<span class="text-green-700"><i class="fas fa-chalkboard-teacher mr-1"></i>${escapeHtml(facultyName)}</span>` : `<span class="text-gray-400"><i class="fas fa-user-slash mr-1"></i>Not assigned</span>`}
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-700">
                          ${termName !== 'Not assigned' ? `<span class="text-blue-700"><i class="fas fa-calendar-alt mr-1"></i>${escapeHtml(termName)}</span>` : `<span class="text-gray-400"><i class="fas fa-calendar-times mr-1"></i>Not assigned</span>`}
                        </td>
                        <td class="px-4 py-3">${yearBadge}</td>
                        <td class="px-4 py-3">
                          <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">
                            <i class="fas fa-users mr-1"></i> ${section.total_students || 0}
                          </span>
                        </td>
                        <td class="px-4 py-3 text-right text-sm">
                          <button class="text-red-600 hover:text-red-900" onclick="unassignSection(${section.section_id}, ${subjectId})" title="Unassign Section">
                            <i class="fas fa-times-circle"></i>
                          </button>
                        </td>
                      </tr>
                    `;
                  });
                  tbody.innerHTML = html;
                } else {
                  tbody.innerHTML = `
                    <tr>
                      <td colspan="8" class="px-4 py-8 text-center text-red-500">
                        <i class="fas fa-exclamation-circle text-2xl mb-2"></i>
                        <p>Failed to load section details</p>
                      </td>
                    </tr>
                  `;
                }
              });
          } else {
            tbody.innerHTML = `
              <tr>
                <td colspan="8" class="px-4 py-8 text-center text-red-500">
                  <i class="fas fa-exclamation-circle text-2xl mb-2"></i>
                  <p>Failed to load assigned sections</p>
                </td>
              </tr>
            `;
          }
        })
        .catch(error => {
          console.error('Error loading assigned sections:', error);
          tbody.innerHTML = `
            <tr>
              <td colspan="7" class="px-4 py-8 text-center text-red-500">
                <i class="fas fa-exclamation-circle text-2xl mb-2"></i>
                <p>Error loading assigned sections</p>
              </td>
            </tr>
          `;
        });
    }
    
    // Helper function to get year level badge
    function getYearLevelBadge(year) {
      const yearMap = {
        '1st Year': 'bg-green-100 text-green-800',
        '2nd Year': 'bg-blue-100 text-blue-800',
        '3rd Year': 'bg-purple-100 text-purple-800',
        '4th Year': 'bg-orange-100 text-orange-800',
        '5th Year': 'bg-red-100 text-red-800'
      };
      const colorClass = yearMap[year] || 'bg-gray-100 text-gray-800';
      return `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${colorClass}">${escapeHtml(year || 'N/A')}</span>`;
    }
    
    // Assign section to subject
    function assignSectionToSubject() {
      const sectionId = document.getElementById('section-select').value;
      const facultyId = document.getElementById('faculty-select').value;
      const termId = document.getElementById('term-select').value;
      
      if (!sectionId) {
        Swal.fire({
          icon: 'warning',
          title: 'No Section Selected',
          text: 'Please select a section to assign',
          confirmButtonColor: '#3B82F6'
        });
        return;
      }
      
      if (!facultyId) {
        Swal.fire({
          icon: 'warning',
          title: 'No Faculty Selected',
          text: 'Please select a faculty member to assign to this section',
          confirmButtonColor: '#3B82F6'
        });
        return;
      }
      
      if (!termId) {
        Swal.fire({
          icon: 'warning',
          title: 'No Academic Term Selected',
          text: 'Please select an academic term for this assignment',
          confirmButtonColor: '#3B82F6'
        });
        return;
      }
      
      // Get section details from the select option
      const select = document.getElementById('section-select');
      const selectedOption = select.options[select.selectedIndex];
      const sectionName = selectedOption.textContent;
      
      // Create a class entry for this section and subject
      fetch('/api/classes', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          subject_id: currentSubjectId,
          section_ref_id: parseInt(sectionId),
          schedule: 'TBA', // You can add a field to collect this
          room: 'TBA', // You can add a field to collect this
          faculty_id: parseInt(facultyId),
          acad_term_id: parseInt(termId)
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          Swal.fire({
            icon: 'success',
            title: 'Section Assigned!',
            text: `Section has been assigned to this subject with faculty`,
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true
          });
          
          // Reload assigned sections
          loadAssignedSections(currentSubjectId);
          
          // Reload available sections
          loadAvailableSections();
          
          // Reload subjects to update student count
          loadSubjects();
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: data.error || 'Failed to assign section',
            confirmButtonColor: '#3B82F6'
          });
        }
      })
      .catch(error => {
        console.error('Error assigning section:', error);
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Failed to assign section. Please try again.',
          confirmButtonColor: '#3B82F6'
        });
      });
    }
    
    // Unassign section from subject
    function unassignSection(sectionId, subjectId) {
      Swal.fire({
        title: 'Unassign Section?',
        text: 'Are you sure you want to unassign this section from the subject?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#EF4444',
        cancelButtonColor: '#6B7280',
        confirmButtonText: 'Yes, unassign',
        cancelButtonText: 'Cancel'
      }).then((result) => {
        if (result.isConfirmed) {
          // Find and delete the class entry
          fetch(`/api/subjects/${subjectId}/classes`)
            .then(response => response.json())
            .then(data => {
              if (data.success && data.classes) {
                // Find class with matching section_ref_id
                const classToDelete = data.classes.find(cls => cls.section_ref_id === sectionId);
                
                if (classToDelete) {
                  // Delete the class
                  fetch(`/api/classes/${classToDelete.section_id}`, {
                    method: 'DELETE'
                  })
                  .then(response => response.json())
                  .then(deleteData => {
                    if (deleteData.success) {
                      Swal.fire({
                        icon: 'success',
                        title: 'Section Unassigned!',
                        text: 'Section has been removed from this subject',
                        toast: true,
                        position: 'top-end',
                        showConfirmButton: false,
                        timer: 3000,
                        timerProgressBar: true
                      });
                      
                      // Reload assigned sections
                      loadAssignedSections(currentSubjectId);
                      
                      // Reload available sections
                      loadAvailableSections();
                      
                      // Reload subjects to update student count
                      loadSubjects();
                    } else {
                      Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: deleteData.error || 'Failed to unassign section',
                        confirmButtonColor: '#3B82F6'
                      });
                    }
                  });
                } else {
                  Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Could not find class to delete',
                    confirmButtonColor: '#3B82F6'
                  });
                }
              }
            })
            .catch(error => {
              console.error('Error unassigning section:', error);
              Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Failed to unassign section. Please try again.',
                confirmButtonColor: '#3B82F6'
              });
            });
        }
      });
    }
  </script>

  <!-- Include admin navigation script -->
  <script src="{{ url_for('static', filename='js/admin-navigation.js') }}"></script>
  
  <!-- Include loading animation script -->
  <script src="{{ url_for('static', filename='js/loading-animation.js') }}"></script>

  <!-- Prevent logout on browser back button -->
  <script src="{{ url_for('static', filename='js/prevent-back-logout.js') }}"></script>

  <!-- Session Timeout Monitor (Auto-logout after 1 hour) -->
  <script src="{{ url_for('static', filename='js/session-timeout.js') }}"></script>

</body>
</html>