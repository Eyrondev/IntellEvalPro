<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Admin Dashboard | IntellEvalPro</title>
  
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/nclogo.png') }}">
  <link rel="shortcut icon" type="image/png" href="{{ url_for('static', filename='images/nclogo.png') }}">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='images/nclogo.png') }}">

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  
  <!-- SweetAlert2 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.12/dist/sweetalert2.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.12/dist/sweetalert2.all.min.js"></script>
  
  <script>
    tailwind.config = {
      theme: {
        fontFamily: {
          'sans': ['Inter', 'system-ui', 'sans-serif'],
        },
        extend: {
          colors: {
            primary: {
              50: '#e6f0ff',
              100: '#b3d1ff',
              200: '#80b3ff',
              300: '#4d94ff', 
              400: '#1a75ff',
              500: '#0059cc', // Primary color
              600: '#004db3',
              700: '#004099',
              800: '#003380',
              900: '#002766',
            },
            secondary: {
              50: '#f5f7fa',
              100: '#e4e7eb',
              200: '#cbd2d9',
              300: '#9aa5b1',
              400: '#7b8794',
              500: '#616e7c',
              600: '#52606d',
              700: '#3e4c59',
              800: '#323f4b',
              900: '#1f2933',
            },
          },
        }
      }
    }
  </script>
  
  <style>
    /* Global styles */
    body {
      font-family: 'Inter', sans-serif;
      overflow-x: hidden;
    }
    
    /* Sidebar animation */
    @keyframes slideIn {
      from { transform: translateX(-100%); }
      to { transform: translateX(0); }
    }
    
    /* Dropdown animation */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }
    
    /* Card hover effect */
    .dashboard-card {
      transition: all 0.3s ease;
    }
    
    .dashboard-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    
    /* Active nav link */
    .nav-link.active {
      position: relative;
    }
    
    .nav-link.active::after {
      content: '';
      position: absolute;
      left: 0;
      width: 4px;
      height: 100%;
      background-color: #0059cc;
      border-radius: 0 2px 2px 0;
    }
    /* Mobile responsive styles */
    @media (max-width: 768px) {
      .dashboard-card {
        margin-bottom: 1rem;
      }
      
      .overflow-x-auto {
        -webkit-overflow-scrolling: touch;
      }
    }
    
    @media (max-width: 640px) {
      /* Ensure proper spacing on mobile */
      .dashboard-card .p-4, .dashboard-card .p-5 {
        padding: 0.875rem !important;
      }
      
      /* Responsive chart containers */
      .relative.h-80 {
        height: 16rem !important;
      }
    }
    
    /* Prevent horizontal scroll */
    body {
      overflow-x: hidden;
    }
    
    #main-content {
      max-width: 100vw;
      overflow-x: hidden;
    }
    
    /* Responsive table */
    @media (max-width: 640px) {
      table {
        font-size: 0.75rem;
      }
      
      th, td {
        padding: 0.5rem !important;
      }
    }
  </style>
</head>

<body class="bg-gray-50">

  <div class="flex h-screen bg-gray-50">
        <!-- Sidebar (will be loaded dynamically) -->
    <div id="admin-sidebar"></div>
    
    <!-- Main content -->
    <div class="lg:ml-64 flex flex-col flex-1 min-h-screen">
      <!-- Top Navigation (will be loaded dynamically) -->
      <div id="admin-header"></div>

      <!-- Main content area -->
      <main id="main-content" class="flex-1 overflow-auto p-3 sm:p-4 md:p-6 bg-gray-50">
        <!-- Page title and controls -->
        <div class="mb-4 sm:mb-6">
          <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
            <div class="flex-1 min-w-0">
              <h1 class="text-xl sm:text-2xl md:text-3xl font-bold leading-tight text-gray-900">
                Admin Dashboard
              </h1>
              <p class="mt-1 text-xs sm:text-sm text-gray-500">
                Overview of faculty evaluation system and key metrics
              </p>
            </div>
          </div>
        </div>
        
        <!-- Stats Overview -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 mb-4 sm:mb-6">
          <!-- Total Users -->
          <div class="bg-white overflow-hidden shadow rounded-lg dashboard-card">
            <div class="p-3 sm:p-4 md:p-5">
              <div class="flex items-center">
                <div class="flex-shrink-0 bg-primary-100 rounded-md p-2 sm:p-2.5 md:p-3">
                  <i class="fas fa-users text-primary-600 text-base sm:text-lg md:text-xl"></i>
                </div>
                <div class="ml-3 sm:ml-4 md:ml-5 w-0 flex-1">
                  <dl>
                    <dt class="text-xs sm:text-sm font-medium text-gray-500 truncate">
                      Total Users
                    </dt>
                    <dd>
                      <div id="total-users-value" class="text-base sm:text-lg md:text-xl font-bold text-gray-900">
                        --
                      </div>
                      <div class="inline-flex items-baseline px-1.5 sm:px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 mt-1">
                        <i class="fas fa-arrow-up mr-0.5 sm:mr-1 text-xs"></i>
                        <span>12.5%</span>
                      </div>
                    </dd>
                  </dl>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Faculty Members -->
          <div class="bg-white overflow-hidden shadow rounded-lg dashboard-card">
            <div class="p-3 sm:p-4 md:p-5">
              <div class="flex items-center">
                <div class="flex-shrink-0 bg-blue-100 rounded-md p-2 sm:p-2.5 md:p-3">
                  <i class="fas fa-chalkboard-user text-blue-600 text-base sm:text-lg md:text-xl"></i>
                </div>
                <div class="ml-3 sm:ml-4 md:ml-5 w-0 flex-1">
                  <dl>
                    <dt class="text-xs sm:text-sm font-medium text-gray-500 truncate">
                      Faculty Members
                    </dt>
                    <dd>
                      <div id="total-faculty-value" class="text-base sm:text-lg md:text-xl font-bold text-gray-900">
                        --
                      </div>
                      <div class="inline-flex items-baseline px-1.5 sm:px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 mt-1">
                        <i class="fas fa-arrow-up mr-0.5 sm:mr-1 text-xs"></i>
                        <span>4.2%</span>
                      </div>
                    </dd>
                  </dl>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Students -->
          <div class="bg-white overflow-hidden shadow rounded-lg dashboard-card">
            <div class="p-3 sm:p-4 md:p-5">
              <div class="flex items-center">
                <div class="flex-shrink-0 bg-indigo-100 rounded-md p-2 sm:p-2.5 md:p-3">
                  <i class="fas fa-user-graduate text-indigo-600 text-base sm:text-lg md:text-xl"></i>
                </div>
                <div class="ml-3 sm:ml-4 md:ml-5 w-0 flex-1">
                  <dl>
                    <dt class="text-xs sm:text-sm font-medium text-gray-500 truncate">
                      Enrolled Students
                    </dt>
                    <dd>
                      <div id="total-students-value" class="text-base sm:text-lg md:text-xl font-bold text-gray-900">
                        --
                      </div>
                      <div class="inline-flex items-baseline px-1.5 sm:px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 mt-1">
                        <i class="fas fa-arrow-up mr-0.5 sm:mr-1 text-xs"></i>
                        <span>8.3%</span>
                      </div>
                    </dd>
                  </dl>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Evaluations -->
          <div class="bg-white overflow-hidden shadow rounded-lg dashboard-card">
            <div class="p-3 sm:p-4 md:p-5">
              <div class="flex items-center">
                <div class="flex-shrink-0 bg-purple-100 rounded-md p-2 sm:p-2.5 md:p-3">
                  <i class="fas fa-clipboard-check text-purple-600 text-base sm:text-lg md:text-xl"></i>
                </div>
                <div class="ml-3 sm:ml-4 md:ml-5 w-0 flex-1">
                  <dl>
                    <dt class="text-xs sm:text-sm font-medium text-gray-500 truncate">
                      Evaluations Completed
                    </dt>
                    <dd>
                      <div id="total-evaluations-value" class="text-base sm:text-lg md:text-xl font-bold text-gray-900">
                        --
                      </div>
                      <div class="mt-1 flex items-baseline text-xs sm:text-sm">
                        <span id="completion-rate-value" class="font-semibold text-green-700">--</span>
                        <span class="ml-1 text-gray-500 hidden sm:inline">completion rate</span>
                        <span class="ml-1 text-gray-500 sm:hidden">rate</span>
                      </div>
                    </dd>
                  </dl>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Charts Row -->
        <div class="grid grid-cols-1 gap-4 sm:gap-5 md:gap-6 lg:grid-cols-2 mb-4 sm:mb-5 md:mb-6">
          <!-- Evaluation Progress Chart -->
          <div class="bg-white overflow-hidden shadow rounded-lg dashboard-card">
            <div class="p-3 sm:p-4 md:p-5 border-b border-gray-200">
              <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 sm:gap-3">
                <h3 class="text-base sm:text-lg leading-6 font-medium text-gray-900">
                  Evaluation Progress
                </h3>
                <div class="flex items-center">
                  <div class="inline-flex shadow-sm rounded-md" id="progressFilterButtons">
                    <button type="button" data-period="weekly" class="progress-filter-btn py-1 px-2 sm:px-3 text-xs font-medium rounded-l-md text-gray-700 bg-white hover:bg-gray-50 border border-gray-300 focus:z-10 focus:outline-none focus:ring-1 focus:ring-primary-500">
                      Weekly
                    </button>
                    <button type="button" data-period="monthly" class="progress-filter-btn py-1 px-2 sm:px-3 text-xs font-medium text-gray-700 bg-white hover:bg-gray-50 border-t border-b border-gray-300 focus:z-10 focus:outline-none focus:ring-1 focus:ring-primary-500">
                      Monthly
                    </button>
                    <button type="button" data-period="semester" class="progress-filter-btn py-1 px-2 sm:px-3 text-xs font-medium rounded-r-md text-white bg-primary-500 hover:bg-primary-600 border border-primary-500 focus:z-10 focus:outline-none focus:ring-1 focus:ring-primary-500 active">
                      Semester
                    </button>
                  </div>
                </div>
              </div>
            </div>
            <div class="p-3 sm:p-4 md:p-5">
              <div class="relative h-64 sm:h-72 md:h-80">
                <canvas id="evaluationProgressChart"></canvas>
              </div>
            </div>
          </div>
          
          <!-- Faculty Rating Distribution -->
          <div class="bg-white overflow-hidden shadow rounded-lg dashboard-card">
            <div class="p-3 sm:p-4 md:p-5 border-b border-gray-200">
              <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 sm:gap-3">
                <h3 class="text-base sm:text-lg leading-6 font-medium text-gray-900">
                  Faculty Rating Distribution
                </h3>
                <div>
                  <select id="departmentFilter" class="text-xs sm:text-sm rounded-md border-gray-300 py-1 pl-2 sm:pl-3 pr-7 sm:pr-8 text-gray-500 focus:outline-none focus:ring-primary-500 focus:border-primary-500">
                    <option value="all">All Departments</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="p-3 sm:p-4 md:p-5">
              <div class="relative h-64 sm:h-72 md:h-80">
                <canvas id="facultyRatingChart"></canvas>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Department Performance Summary -->
        <div class="bg-white shadow rounded-lg dashboard-card mb-4 sm:mb-5 md:mb-6">
          <div class="p-3 sm:p-4 md:p-5 border-b border-gray-200">
            <div class="flex items-center justify-between">
              <h3 class="text-base sm:text-lg leading-6 font-medium text-gray-900">
                Department Performance Summary
              </h3>
            </div>
          </div>
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th scope="col" class="px-3 sm:px-4 md:px-6 py-2 sm:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Department
                  </th>
                  <th scope="col" class="px-3 sm:px-4 md:px-6 py-2 sm:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Faculty
                  </th>
                  <th scope="col" class="hidden sm:table-cell px-3 sm:px-4 md:px-6 py-2 sm:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Evaluations
                  </th>
                  <th scope="col" class="hidden md:table-cell px-3 sm:px-4 md:px-6 py-2 sm:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Avg. Rating
                  </th>
                  <th scope="col" class="px-3 sm:px-4 md:px-6 py-2 sm:py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Progress
                  </th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                <!-- Data will be loaded dynamically from database -->
                <tr>
                  <td colspan="5" class="px-3 sm:px-4 md:px-6 py-6 sm:py-8 text-center text-gray-500">
                    <div class="flex flex-col items-center justify-center">
                      <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600 mb-3"></div>
                      <p class="text-xs sm:text-sm">Loading department data...</p>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </main>
      
    </div>
  </div>
  <script src="{{ url_for('static', filename='js/loading-animation.js') }}"></script>
  <script src="{{ url_for('static', filename='js/admin-navigation.js') }}"></script>

  <script>
    const loginUrl = "{{ url_for('auth.login') }}";
    
    // Dashboard data storage
    let dashboardData = {
      overview: {
        total_users: 0,
        total_faculty: 0,
        enrolled_students: 0,
        completed_evaluations: 0,
        completion_rate: 0
      },
      evaluationProgress: [],
      ratingDistribution: [],
      departmentPerformance: [],
      departments: []
    };
    
    // Chart instances
    let progressChart = null;
    let ratingChart = null;
    
    // Current selected department for filtering
    let selectedDepartment = 'all';
    
    // Current selected period for evaluation progress
    let selectedPeriod = 'semester';
    
    // Hide loader when page is ready
    window.addEventListener('load', function() {
      setTimeout(function() {
        const overlay = document.getElementById('loader-overlay');
        if (overlay) {
          overlay.style.opacity = '0';
          setTimeout(() => {
            overlay.style.display = 'none';
          }, 300);
        }
      }, 500);
    });
    
    // Initialize dashboard on DOM ready
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Dashboard initializing...');
      initializeDashboard();
    });
    
    // Main initialization function
    async function initializeDashboard() {
      try {
        await loadAllDashboardData();
      } catch (error) {
        console.error('Dashboard initialization error:', error);
        showError('Failed to initialize dashboard');
      }
    }
    
    // Load all dashboard data
    async function loadAllDashboardData() {
      try {
        console.log('Loading dashboard data...');
        
        // Load main dashboard stats
        const statsResponse = await fetch('/api/dashboard/stats');
        if (!statsResponse.ok) {
          throw new Error(`Stats API returned ${statsResponse.status}: ${statsResponse.statusText}`);
        }
        
        const statsResult = await statsResponse.json();
        console.log('Stats data:', statsResult);
        
        if (statsResult.success && statsResult.data) {
          dashboardData.overview = statsResult.data.overview || dashboardData.overview;
          dashboardData.evaluationProgress = statsResult.data.evaluation_progress || [];
          dashboardData.ratingDistribution = statsResult.data.rating_distribution || [];
          dashboardData.departmentPerformance = statsResult.data.department_performance || [];
          
          // Update all components
          updateOverviewCards();
          updateEvaluationProgressChart();
          updateFacultyRatingChart();
          updateDepartmentTable();
          
          // Initialize filter buttons
          initializeProgressFilter();
        } else {
          throw new Error(statsResult.error || 'Failed to load dashboard stats');
        }
        
        // Load departments for dropdown
        const deptResponse = await fetch('/api/dashboard/departments');
        if (deptResponse.ok) {
          const deptResult = await deptResponse.json();
          console.log('Departments data:', deptResult);
          
          if (deptResult.success && deptResult.data) {
            dashboardData.departments = deptResult.data;
            populateDepartmentDropdown();
          }
        } else {
          console.warn('Failed to load departments for filter');
        }
        
        console.log('Dashboard loaded successfully');
        
      } catch (error) {
        console.error('Error loading dashboard data:', error);
        showError('Error loading dashboard: ' + error.message);
      }
    }
    
    // Update overview cards with real data
    function updateOverviewCards() {
      console.log('Updating overview cards...', dashboardData.overview);
      
      const overview = dashboardData.overview;
      if (!overview) return;
      
      // Update Total Users
      const totalUsersEl = document.getElementById('total-users-value');
      if (totalUsersEl) {
        totalUsersEl.textContent = (overview.total_users || 0).toLocaleString();
      }
      
      // Update Faculty Members
      const totalFacultyEl = document.getElementById('total-faculty-value');
      if (totalFacultyEl) {
        totalFacultyEl.textContent = (overview.total_faculty || 0).toLocaleString();
      }
      
      // Update Enrolled Students
      const totalStudentsEl = document.getElementById('total-students-value');
      if (totalStudentsEl) {
        totalStudentsEl.textContent = (overview.enrolled_students || 0).toLocaleString();
      }
      
      // Update Evaluations Completed
      const totalEvalsEl = document.getElementById('total-evaluations-value');
      if (totalEvalsEl) {
        totalEvalsEl.textContent = (overview.completed_evaluations || 0).toLocaleString();
      }
      
      // Update completion rate
      const rateEl = document.getElementById('completion-rate-value');
      if (rateEl) {
        const rate = parseFloat(overview.completion_rate || 0);
        rateEl.textContent = rate.toFixed(1) + '%';
      }
      
      console.log('Overview cards updated');
    }
    
    // Initialize evaluation progress filter buttons
    function initializeProgressFilter() {
      const filterButtons = document.querySelectorAll('.progress-filter-btn');
      
      filterButtons.forEach(button => {
        button.addEventListener('click', function() {
          // Remove active state from all buttons
          filterButtons.forEach(btn => {
            btn.classList.remove('active', 'bg-primary-500', 'text-white', 'border-primary-500');
            btn.classList.add('bg-white', 'text-gray-700', 'border-gray-300');
          });
          
          // Add active state to clicked button
          this.classList.remove('bg-white', 'text-gray-700', 'border-gray-300');
          this.classList.add('active', 'bg-primary-500', 'text-white', 'border-primary-500');
          
          // Update selected period
          selectedPeriod = this.getAttribute('data-period');
          console.log('Period filter changed to:', selectedPeriod);
          
          // Re-render chart with filtered data
          updateEvaluationProgressChart();
        });
      });
      
      console.log('Progress filter initialized');
    }
    
    // Populate department dropdown
    function populateDepartmentDropdown() {
      const dropdown = document.getElementById('departmentFilter');
      if (!dropdown) {
        console.warn('Department filter dropdown not found');
        return;
      }
      
      console.log('Populating department dropdown with', dashboardData.departments.length, 'departments');
      
      // Clear and rebuild dropdown
      dropdown.innerHTML = '<option value="all">All Departments</option>';
      
      // Add department options
      dashboardData.departments.forEach(dept => {
        const option = document.createElement('option');
        option.value = dept.program_id;
        option.textContent = dept.department_name || dept.name;
        dropdown.appendChild(option);
      });
      
      // Remove existing event listeners by cloning
      const newDropdown = dropdown.cloneNode(true);
      dropdown.parentNode.replaceChild(newDropdown, dropdown);
      
      // Add change event listener
      newDropdown.addEventListener('change', async function() {
        selectedDepartment = this.value;
        console.log('Department filter changed to:', selectedDepartment);
        await loadRatingDistribution(selectedDepartment);
      });
      
      console.log('Department dropdown populated');
    }
    
    // Load rating distribution with optional filter
    async function loadRatingDistribution(programId = 'all') {
      try {
        const url = programId === 'all' 
          ? '/api/dashboard/rating-distribution'
          : `/api/dashboard/rating-distribution?program_id=${programId}`;
        
        console.log('Loading rating distribution:', url);
        
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error(`Rating distribution API returned ${response.status}`);
        }
        
        const result = await response.json();
        console.log('Rating distribution data:', result);
        
        if (result.success && result.data) {
          dashboardData.ratingDistribution = result.data;
          updateFacultyRatingChart();
        } else {
          throw new Error(result.error || 'Failed to load rating distribution');
        }
      } catch (error) {
        console.error('Error loading rating distribution:', error);
        showError('Failed to load rating distribution: ' + error.message);
      }
    }
    
    // Update Evaluation Progress Chart
    function updateEvaluationProgressChart() {
      const canvas = document.getElementById('evaluationProgressChart');
      if (!canvas) {
        console.warn('Evaluation progress chart canvas not found');
        return;
      }
      
      console.log('Updating evaluation progress chart with period:', selectedPeriod);
      
      const ctx = canvas.getContext('2d');
      const progressData = dashboardData.evaluationProgress || [];
      
      // Filter and prepare data based on selected period
      let labels, dataValues;
      
      if (selectedPeriod === 'weekly') {
        // Show last 6 weeks
        const filteredData = progressData.slice(-6);
        labels = filteredData.length > 0 
          ? filteredData.map(item => item.week_label || 'Week')
          : ['Week 1', 'Week 2', 'Week 3', 'Week 4', 'Week 5', 'Week 6'];
        dataValues = filteredData.length > 0
          ? filteredData.map(item => item.count || 0)
          : [0, 0, 0, 0, 0, 0];
      } else if (selectedPeriod === 'monthly') {
        // Group by month (last 6 months)
        const monthlyData = {};
        progressData.forEach(item => {
          if (item.week_label) {
            // Extract month from label (e.g., "Oct 05" -> "Oct")
            const month = item.week_label.split(' ')[0];
            if (!monthlyData[month]) {
              monthlyData[month] = 0;
            }
            monthlyData[month] += item.count || 0;
          }
        });
        
        const months = Object.keys(monthlyData);
        labels = months.length > 0 ? months : ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
        dataValues = months.length > 0 
          ? Object.values(monthlyData)
          : [0, 0, 0, 0, 0, 0];
      } else {
        // Semester view - show all data
        labels = progressData.length > 0 
          ? progressData.map(item => item.week_label || 'Week')
          : ['Week 1', 'Week 2', 'Week 3', 'Week 4', 'Week 5', 'Week 6'];
        dataValues = progressData.length > 0
          ? progressData.map(item => item.count || 0)
          : [0, 0, 0, 0, 0, 0];
      }
      
      // Calculate target line based on enrolled student count
      // Target = total enrolled students (each student should complete evaluations)
      const enrolledStudents = dashboardData.overview.enrolled_students || 0;
      const targetValue = enrolledStudents;
      const targetData = new Array(labels.length).fill(targetValue);
      
      // Destroy existing chart
      if (progressChart) {
        progressChart.destroy();
      }
      
      // Create new chart
      progressChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Completed Evaluations',
            data: dataValues,
            fill: true,
            backgroundColor: 'rgba(0, 89, 204, 0.1)',
            borderColor: 'rgba(0, 89, 204, 0.8)',
            tension: 0.4,
            pointBackgroundColor: 'rgba(0, 89, 204, 1)',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointRadius: 4,
            pointHoverRadius: 6
          }, {
            label: `Target (${enrolledStudents} Students)`,
            data: targetData,
            fill: false,
            borderColor: 'rgba(107, 114, 128, 0.4)',
            borderDash: [5, 5],
            tension: 0.4,
            pointRadius: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
              labels: {
                usePointStyle: true,
                boxWidth: 6,
                padding: 15
              }
            },
            tooltip: {
              mode: 'index',
              intersect: false,
              callbacks: {
                title: function(context) {
                  return selectedPeriod.charAt(0).toUpperCase() + selectedPeriod.slice(1) + ': ' + context[0].label;
                },
                afterLabel: function(context) {
                  if (context.datasetIndex === 0) {
                    const completed = context.parsed.y;
                    const target = enrolledStudents;
                    const percentage = target > 0 ? ((completed / target) * 100).toFixed(1) : 0;
                    return `Progress: ${percentage}% of target (${target} students)`;
                  }
                  return '';
                }
              }
            }
          },
          scales: {
            x: {
              grid: {
                display: false
              },
              ticks: {
                maxRotation: 45,
                minRotation: 0
              }
            },
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: Math.ceil(Math.max(...dataValues, targetValue) / 5)
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              }
            }
          }
        }
      });
      
      console.log('Evaluation progress chart updated with', labels.length, 'data points');
    }
    
    // Update Faculty Rating Distribution Chart
    function updateFacultyRatingChart() {
      const canvas = document.getElementById('facultyRatingChart');
      if (!canvas) {
        console.warn('Faculty rating chart canvas not found');
        return;
      }
      
      console.log('Updating faculty rating chart...');
      
      const ctx = canvas.getContext('2d');
      const ratingData = dashboardData.ratingDistribution || [];
      
      // Create a map for easy lookup
      const ratingMap = {};
      ratingData.forEach(item => {
        ratingMap[item.rating_category] = parseInt(item.faculty_count) || 0;
      });
      
      // Ensure all categories are present
      const labels = ['5 Stars', '4 Stars', '3 Stars', '2 Stars', '1 Star'];
      const dataValues = labels.map(label => ratingMap[label] || 0);
      
      console.log('Rating distribution:', { labels, dataValues });
      
      // Destroy existing chart
      if (ratingChart) {
        ratingChart.destroy();
      }
      
      // Create new chart
      ratingChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Faculty Count',
            data: dataValues,
            backgroundColor: [
              'rgba(34, 197, 94, 0.8)',   // Green for 5 stars
              'rgba(59, 130, 246, 0.8)',  // Blue for 4 stars
              'rgba(245, 158, 11, 0.8)',  // Yellow for 3 stars
              'rgba(249, 115, 22, 0.8)',  // Orange for 2 stars
              'rgba(239, 68, 68, 0.8)'    // Red for 1 star
            ],
            borderColor: [
              'rgba(34, 197, 94, 1)',
              'rgba(59, 130, 246, 1)',
              'rgba(245, 158, 11, 1)',
              'rgba(249, 115, 22, 1)',
              'rgba(239, 68, 68, 1)'
            ],
            borderWidth: 2,
            borderRadius: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return 'Faculty: ' + context.parsed.y;
                }
              }
            }
          },
          scales: {
            x: {
              grid: {
                display: false
              }
            },
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1,
                precision: 0
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              }
            }
          }
        }
      });
      
      console.log('Faculty rating chart updated');
    }
    
    // Update department performance table
    function updateDepartmentTable() {
      const tbody = document.querySelector('tbody.bg-white.divide-y');
      if (!tbody) {
        console.warn('Department table body not found');
        return;
      }
      
      console.log('Updating department table...');
      
      const departments = dashboardData.departmentPerformance || [];
      
      if (departments.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5" class="px-6 py-8 text-center text-gray-500">
              <i class="fas fa-info-circle text-3xl mb-2"></i>
              <p>No department data available</p>
            </td>
          </tr>
        `;
        console.log('No department data to display');
        return;
      }
      
      // Icon and color mappings
      const departmentIcons = {
        'Computer Science': 'fa-laptop-code',
        'Information Technology': 'fa-computer',
        'Business': 'fa-briefcase',
        'Business Administration': 'fa-briefcase',
        'Engineering': 'fa-tools',
        'Arts': 'fa-palette',
        'Arts & Sciences': 'fa-palette',
        'Science': 'fa-flask',
        'Education': 'fa-graduation-cap',
        'Nursing': 'fa-heartbeat',
        'default': 'fa-building'
      };
      
      const departmentColors = {
        'Computer Science': 'bg-primary-100 text-primary-600',
        'Information Technology': 'bg-primary-100 text-primary-600',
        'Business': 'bg-blue-100 text-blue-600',
        'Business Administration': 'bg-blue-100 text-blue-600',
        'Engineering': 'bg-yellow-100 text-yellow-600',
        'Arts': 'bg-red-100 text-red-600',
        'Arts & Sciences': 'bg-red-100 text-red-600',
        'Science': 'bg-green-100 text-green-600',
        'Education': 'bg-indigo-100 text-indigo-600',
        'Nursing': 'bg-pink-100 text-pink-600',
        'default': 'bg-gray-100 text-gray-600'
      };
      
      // Generate table rows
      tbody.innerHTML = departments.map(dept => {
        const deptName = dept.department || 'Unknown';
        const icon = departmentIcons[deptName] || departmentIcons['default'];
        const colorClass = departmentColors[deptName] || departmentColors['default'];
        
        const avgRating = parseFloat(dept.avg_rating || 0);
        const fullStars = Math.floor(avgRating);
        const hasHalfStar = (avgRating % 1) >= 0.5;
        
        const completion = parseInt(dept.completion_percentage || 0);
        
        // Determine progress bar color
        let progressColor = 'bg-green-600';
        if (completion < 50) progressColor = 'bg-red-600';
        else if (completion < 80) progressColor = 'bg-yellow-600';
        
        // Generate star rating HTML
        let starsHtml = '';
        for (let i = 0; i < 5; i++) {
          if (i < fullStars) {
            starsHtml += '<i class="fas fa-star text-yellow-400 text-xs"></i>';
          } else if (i === fullStars && hasHalfStar) {
            starsHtml += '<i class="fas fa-star-half-alt text-yellow-400 text-xs"></i>';
          } else {
            starsHtml += '<i class="far fa-star text-yellow-400 text-xs"></i>';
          }
        }
        
        const totalEvals = (parseInt(dept.completed_evals) || 0) + (parseInt(dept.pending_evals) || 0);
        
        return `
          <tr class="hover:bg-gray-50 transition-colors">
            <td class="px-3 sm:px-4 md:px-6 py-3 sm:py-4 whitespace-nowrap">
              <div class="flex items-center">
                <div class="flex-shrink-0 h-8 w-8 sm:h-9 sm:w-9 md:h-10 md:w-10 rounded-full ${colorClass} flex items-center justify-center">
                  <i class="fas ${icon} text-xs sm:text-sm"></i>
                </div>
                <div class="ml-2 sm:ml-3 md:ml-4">
                  <div class="text-xs sm:text-sm font-medium text-gray-900">${deptName}</div>
                  ${dept.program_code ? `<div class="text-xs text-gray-500">${dept.program_code}</div>` : ''}
                  <!-- Show evaluations and rating on mobile (below department name) -->
                  <div class="sm:hidden mt-1 space-y-0.5">
                    <div class="text-xs text-gray-600">${dept.completed_evals || 0} / ${totalEvals} evals</div>
                    ${avgRating > 0 ? `<div class="flex items-center"><span class="text-xs font-medium mr-1">${avgRating.toFixed(1)}</span>${starsHtml}</div>` : ''}
                  </div>
                </div>
              </div>
            </td>
            <td class="px-3 sm:px-4 md:px-6 py-3 sm:py-4 whitespace-nowrap">
              <div class="text-xs sm:text-sm text-gray-900 font-medium">${dept.faculty_count || 0}</div>
            </td>
            <td class="hidden sm:table-cell px-3 sm:px-4 md:px-6 py-3 sm:py-4 whitespace-nowrap">
              <div class="text-xs sm:text-sm text-gray-900">${dept.completed_evals || 0} / ${totalEvals}</div>
            </td>
            <td class="hidden md:table-cell px-3 sm:px-4 md:px-6 py-3 sm:py-4 whitespace-nowrap">
              <div class="flex items-center">
                <div class="text-xs sm:text-sm text-gray-900 font-medium mr-2">${avgRating > 0 ? avgRating.toFixed(1) : 'N/A'}</div>
                ${avgRating > 0 ? `<div class="flex">${starsHtml}</div>` : ''}
              </div>
            </td>
            <td class="px-3 sm:px-4 md:px-6 py-3 sm:py-4">
              <div class="w-full bg-gray-200 rounded-full h-2 sm:h-2.5 mb-1">
                <div class="${progressColor} h-2 sm:h-2.5 rounded-full transition-all" style="width: ${completion}%"></div>
              </div>
              <span class="text-xs text-gray-500">${completion}% complete</span>
            </td>
          </tr>
        `;
      }).join('');
      
      console.log('Department table updated with', departments.length, 'rows');
    }
    
    // Show error message
    function showError(message) {
      console.error('Dashboard Error:', message);
      
      // Show SweetAlert2 notification if available
      if (typeof Swal !== 'undefined') {
        Swal.fire({
          icon: 'error',
          title: 'Dashboard Error',
          text: message,
          confirmButtonColor: '#0059cc'
        });
      }
    }
  </script>
  
  <!-- Include admin navigation script -->
 
  
  <!-- Include loading animation script -->

  
  <!-- Prevent logout on browser back button -->
  <script src="{{ url_for('static', filename='js/prevent-back-logout.js') }}"></script>

  <!-- Session Timeout Monitor (Auto-logout after 1 hour) -->
  <script src="{{ url_for('static', filename='js/session-timeout.js') }}"></script>
</body>
</html>
