<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Guidance Counselor Dashboard | IntellEvalPro</title>
  
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/nclogo.png') }}">
  <link rel="shortcut icon" type="image/png" href="{{ url_for('static', filename='images/nclogo.png') }}">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='images/nclogo.png') }}">

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  
  <!-- SweetAlert2 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.12/dist/sweetalert2.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.12/dist/sweetalert2.all.min.js"></script>
  
  <!-- Load Guidance Navigation JS -->
  <script src="{{ url_for('static', filename='js/guidance-navigation.js') }}"></script>
  
  <script>
    tailwind.config = {
      theme: {
        fontFamily: {
          'sans': ['Inter', 'system-ui', 'sans-serif'],
        },
        extend: {
          colors: {
            primary: {
              50: '#e6f0ff',
              100: '#b3d1ff',
              200: '#80b3ff',
              300: '#4d94ff', 
              400: '#1a75ff',
              500: '#0059cc', // Primary color
              600: '#004db3',
              700: '#004099',
              800: '#003380',
              900: '#002766',
            },
            secondary: {
              50: '#f5f7fa',
              100: '#e4e7eb',
              200: '#cbd2d9',
              300: '#9aa5b1',
              400: '#7b8794',
              500: '#616e7c',
              600: '#52606d',
              700: '#3e4c59',
              800: '#323f4b',
              900: '#1f2933',
            },
          },
        }
      }
    }
  </script>
  
  <style>
    /* Global styles */
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Inter', sans-serif;
      overflow-x: hidden;
      width: 100%;
      margin: 0;
      padding: 0;
    }
    
    /* Ensure no content goes beyond viewport */
    html {
      overflow-x: hidden;
      width: 100%;
    }
    
    /* Active nav link */
    .active-nav {
      background-color: #e6f0ff;
      color: #0059cc;
      border-left: 4px solid #0059cc;
    }
    
    /* Sidebar animation */
    @keyframes slideIn {
      from { transform: translateX(-100%); }
      to { transform: translateX(0); }
    }
    
    /* Dropdown animation */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }
    
    /* Card hover effect */
    .dashboard-card {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .dashboard-card:hover {
      transform: translateY(-2px);
    }
    
    /* Active nav link */
    .nav-link.active {
      position: relative;
    }
    
    .nav-link.active::after {
      content: '';
      position: absolute;
      left: 0;
      width: 4px;
      height: 100%;
      background-color: #0059cc;
      border-radius: 0 2px 2px 0;
    }
    
    /* Heat Map Colors */
    .heat-map-level-1 { background-color: #edf8fb; }
    .heat-map-level-2 { background-color: #b2e2e2; }
    .heat-map-level-3 { background-color: #66c2a4; }
    .heat-map-level-4 { background-color: #2ca25f; }
    .heat-map-level-5 { background-color: #006d2c; }
    
    /* Progress Bar Widths and Animation */
    .progress-bar {
      width: 0%;
      transition: width 1s ease-in-out;
    }
    
    #completion-rate-bar,
    #average-rating-bar {
      width: 0%;
      transition: width 1.2s ease-out;
    }
    
    /* Mobile responsive styles - 390px minimum baseline */
    @media (max-width: 768px) {
      body {
        overflow-x: hidden;
        width: 100%;
      }
      
      /* Ensure main content doesn't go under sidebar on mobile */
      main {
        width: 100%;
        margin-left: 0 !important;
        padding-left: 0.75rem !important;
        padding-right: 0.75rem !important;
      }
      
      .dashboard-card {
        margin-bottom: 0.75rem;
      }
      
      /* Ensure single column on mobile */
      .grid-cols-1 {
        grid-template-columns: repeat(1, minmax(0, 1fr));
      }
      
      /* Reduce text sizes on mobile for better fit */
      .text-3xl {
        font-size: 1.5rem !important;
        line-height: 2rem !important;
      }
      
      .text-2xl {
        font-size: 1.25rem !important;
        line-height: 1.75rem !important;
      }
      
      .text-xl {
        font-size: 1.125rem !important;
        line-height: 1.75rem !important;
      }
      
      .text-lg {
        font-size: 1rem !important;
        line-height: 1.5rem !important;
      }
      
      /* Make tables scrollable on mobile */
      .overflow-x-auto {
        -webkit-overflow-scrolling: touch;
        scrollbar-width: thin;
        overflow-x: auto;
        max-width: 100%;
      }
      
      /* Adjust table cell padding on mobile */
      table td,
      table th {
        padding: 0.5rem 0.5rem;
        font-size: 0.75rem;
      }
    }
    
    /* Desktop and large screens - Enhanced readability */
    @media (min-width: 1024px) {
      /* Larger table text for better readability on desktop */
      table td,
      table th {
        font-size: 0.9375rem; /* 15px */
        line-height: 1.5;
      }
      
      /* Header text slightly larger */
      table thead th {
        font-size: 0.8125rem; /* 13px */
        font-weight: 600;
      }
      
      /* Faculty name and department text */
      table tbody td .text-sm {
        font-size: 0.9375rem !important; /* 15px */
      }
      
      table tbody td .text-xs {
        font-size: 0.8125rem !important; /* 13px */
      }
      
      /* Rating numbers */
      table tbody td .text-base,
      table tbody td .text-lg {
        font-size: 1.125rem !important; /* 18px */
      }
    }
    
    /* Extra large screens - Even better readability */
    @media (min-width: 1280px) {
      table td,
      table th {
        font-size: 1rem; /* 16px */
        line-height: 1.6;
      }
      
      table thead th {
        font-size: 0.875rem; /* 14px */
      }
      
      table tbody td .text-sm {
        font-size: 1rem !important; /* 16px */
      }
      
      table tbody td .text-xs {
        font-size: 0.875rem !important; /* 14px */
      }
      
      table tbody td .text-base,
      table tbody td .text-lg {
        font-size: 1.25rem !important; /* 20px */
      }
    }
    
    /* Ultra-wide screens - Maximum readability */
    @media (min-width: 1536px) {
      table td,
      table th {
        font-size: 1.0625rem; /* 17px */
        padding: 1rem 1.5rem;
      }
      
      table thead th {
        font-size: 0.9375rem; /* 15px */
      }
      
      table tbody td .text-sm {
        font-size: 1.0625rem !important; /* 17px */
      }
      
      table tbody td .text-xs {
        font-size: 0.9375rem !important; /* 15px */
      }
      
      table tbody td .text-base,
      table tbody td .text-lg {
        font-size: 1.375rem !important; /* 22px */
      }
    }
    
    /* Extra small mobile - 390px baseline */
    @media (max-width: 640px) {
      /* Optimize main padding and ensure full width */
      main {
        padding: 0.625rem !important;
        width: 100% !important;
        max-width: 100vw !important;
        box-sizing: border-box !important;
      }
      
      /* Ensure all containers stay within viewport */
      .bg-gradient-to-r,
      .grid,
      .bg-white {
        max-width: 100%;
        box-sizing: border-box;
      }
      
      /* Reduce padding on cards */
      .p-4,
      .p-5,
      .p-6 {
        padding: 0.875rem !important;
      }
      
      .px-4,
      .px-5,
      .px-6 {
        padding-left: 0.875rem !important;
        padding-right: 0.875rem !important;
      }
      
      .py-4,
      .py-5,
      .py-6 {
        padding-top: 0.875rem !important;
        padding-bottom: 0.875rem !important;
      }
      
      /* Reduce gaps */
      .gap-6 {
        gap: 0.75rem !important;
      }
      
      .gap-4 {
        gap: 0.625rem !important;
      }
      
      .gap-3 {
        gap: 0.5rem !important;
      }
      
      .mb-6 {
        margin-bottom: 0.75rem !important;
      }
      
      .mb-4 {
        margin-bottom: 0.625rem !important;
      }
      
      /* Optimize avatar sizes */
      .h-11,
      .w-11 {
        height: 2rem !important;
        width: 2rem !important;
      }
      
      .h-12,
      .w-12 {
        height: 2.25rem !important;
        width: 2.25rem !important;
      }
      
      /* Ensure chart containers are responsive */
      canvas {
        max-width: 100%;
        height: auto !important;
      }
      
      /* Smaller font sizes for very small screens */
      .text-base {
        font-size: 0.875rem !important;
      }
      
      .text-sm {
        font-size: 0.8125rem !important;
      }
      
      .text-xs {
        font-size: 0.75rem !important;
      }
      
      /* Optimize icon sizes */
      .fa-lg {
        font-size: 1rem !important;
      }
      
      /* Reduce border radius on small screens */
      .rounded-xl {
        border-radius: 0.5rem !important;
      }
      
      .rounded-lg {
        border-radius: 0.375rem !important;
      }
    }
    
    /* Very small mobile - 390px specific optimizations */
    @media (max-width: 480px) {
      /* Further optimize spacing */
      main {
        padding: 0.625rem !important;
      }
      
      .p-4,
      .p-5,
      .p-6 {
        padding: 0.75rem !important;
      }
      
      /* Compact stat cards */
      .text-3xl {
        font-size: 1.375rem !important;
        line-height: 1.875rem !important;
      }
      
      .text-2xl {
        font-size: 1.125rem !important;
        line-height: 1.625rem !important;
      }
      
      /* Smaller buttons */
      .px-4 {
        padding-left: 0.75rem !important;
        padding-right: 0.75rem !important;
      }
      
      .py-2 {
        padding-top: 0.5rem !important;
        padding-bottom: 0.5rem !important;
      }
      
      /* Compact table cells */
      table td,
      table th {
        padding: 0.375rem 0.5rem;
        font-size: 0.7rem;
        white-space: nowrap;
      }
      
      /* Smaller icon containers */
      .w-10,
      .h-10 {
        width: 2rem !important;
        height: 2rem !important;
      }
    }
    
    /* Tablet responsive styles */
    @media (min-width: 641px) and (max-width: 1023px) {
      /* Two columns for cards on tablet */
      .sm\:grid-cols-2 {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
      
      /* Adjust chart heights for tablet */
      .h-72 {
        height: 20rem;
      }
    }
    
    /* Touch-friendly interactions */
    @media (hover: none) and (pointer: coarse) {
      /* Ensure 44x44px minimum touch targets */
      button,
      a,
      select,
      input {
        min-height: 44px;
        padding: 0.625rem 0.75rem;
      }
      
      /* Remove hover effects on touch devices */
      .dashboard-card:hover {
        transform: none;
      }
      
      /* Touch-friendly dropdowns */
      select {
        font-size: 16px; /* Prevent zoom on iOS */
        min-height: 44px;
      }
      
      /* Larger tap targets for links */
      a {
        padding: 0.5rem;
      }
    }
  </style>
</head>

<body class="bg-gray-50">
  <!-- Loading overlay -->
  <div id="loader-overlay" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-white bg-opacity-90 backdrop-blur-sm transition-opacity duration-300">
    <img src="{{ url_for('static', filename='images/nclogo.png') }}" alt="Logo" class="w-32 h-auto mb-6 animate-bounce">
    <div class="flex items-center space-x-2">
      <div class="w-3 h-3 rounded-full bg-primary-500 animate-pulse"></div>
      <div class="w-3 h-3 rounded-full bg-primary-500 animate-pulse" style="animation-delay: 0.2s"></div>
      <div class="w-3 h-3 rounded-full bg-primary-500 animate-pulse" style="animation-delay: 0.4s"></div>
    </div>
  </div>

  <div class="flex h-screen bg-gray-50">
    <!-- Sidebar (will be loaded dynamically) -->
    <div id="sidebar-container"></div>
    
    <!-- Main content -->
    <div class="w-full lg:ml-64 flex flex-col flex-1 min-h-screen">
      <!-- Top Navigation (will be loaded dynamically) -->
      <div id="header-container"></div>

      <!-- Main content area -->
      <main class="flex-1 overflow-auto p-3 sm:p-4 md:p-6 bg-gray-50 w-full">
        <!-- Welcome Banner -->
        <div class="bg-gradient-to-r from-primary-600 to-primary-800 rounded-lg shadow-md mb-3 sm:mb-4 md:mb-6 w-full">
          <div class="p-3 sm:p-4 md:p-6">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-2 sm:gap-3 md:gap-4">
              <div class="flex-1 min-w-0">
                <h2 class="text-sm sm:text-base md:text-lg lg:text-xl xl:text-2xl font-bold text-white leading-tight">Faculty Performance Dashboard</h2>
                <p class="mt-1 sm:mt-2 text-xs sm:text-sm text-primary-100 leading-tight">
                  <span class="block sm:inline">Academic Year: <span class="font-medium text-white">{{ dashboard_data.current_term.display_term if dashboard_data and dashboard_data.current_term else '2025-2026 - 1st Sem' }}</span></span>
                  <span class="hidden sm:inline"> | </span>
                  <span class="block sm:inline mt-0.5 sm:mt-0">Real-time monitoring</span>
                </p>
              </div>
              <div class="flex flex-row gap-1.5 sm:gap-2 w-full md:w-auto">
                <a href="{{ url_for('guidance.evaluation_results') }}" class="flex-1 md:flex-none inline-flex items-center justify-center px-2 sm:px-2.5 md:px-3 lg:px-4 py-2 bg-white text-primary-700 text-xs sm:text-sm font-medium rounded-md hover:bg-primary-50 transition-colors duration-200 whitespace-nowrap min-h-[44px]">
                  <i class="fas fa-chart-line mr-1 sm:mr-1.5 text-xs"></i>
                  <span class="text-xs sm:text-sm">Analytics</span>
                </a>
                <a href="{{ url_for('guidance.rankings') }}" class="flex-1 md:flex-none inline-flex items-center justify-center px-2 sm:px-2.5 md:px-3 lg:px-4 py-2 bg-primary-500 text-white text-xs sm:text-sm font-medium rounded-md hover:bg-primary-400 transition-colors duration-200 whitespace-nowrap min-h-[44px]">
                  <i class="fas fa-trophy mr-1 sm:mr-1.5 text-xs"></i>
                  <span class="text-xs sm:text-sm">Rankings</span>
                </a>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Overview Cards -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 md:gap-6 mb-4 md:mb-6">
          <!-- Total Faculty -->
          <div class="bg-white rounded-lg sm:rounded-xl shadow-sm border border-gray-100 dashboard-card overflow-hidden hover:shadow-md transition-shadow duration-300">
            <div class="p-3 sm:p-4 md:p-5 lg:p-6">
              <div class="flex items-start justify-between gap-2 sm:gap-3">
                <div class="flex-1 min-w-0">
                  <p class="text-xs sm:text-sm font-medium text-gray-600 mb-1.5 sm:mb-2 md:mb-3">Total Faculty</p>
                  <div class="flex items-baseline gap-1 sm:gap-1.5 md:gap-2 flex-wrap">
                    <h3 class="text-xl sm:text-2xl md:text-3xl font-bold text-gray-900">{{ dashboard_data.total_faculty if dashboard_data else 0 }}</h3>
                    {% if dashboard_data and dashboard_data.total_faculty > 0 %}
                    <span class="inline-flex items-center px-1.5 sm:px-2 py-0.5 rounded-md text-xs font-medium bg-green-50 text-green-700 whitespace-nowrap">
                      <i class="fas fa-arrow-up text-xs mr-1"></i>
                      {{ (dashboard_data.total_faculty - 44) if dashboard_data.total_faculty > 44 else 0 }}
                    </span>
                    {% endif %}
                  </div>
                  <p class="text-xs text-gray-500 mt-1 sm:mt-1.5 md:mt-2 truncate">
                    {{ dashboard_data.total_departments if dashboard_data else 0 }} departments
                  </p>
                </div>
                <div class="flex-shrink-0">
                  <div class="w-9 h-9 sm:w-10 sm:h-10 md:w-12 md:h-12 rounded-lg bg-gradient-to-br from-primary-500 to-primary-600 flex items-center justify-center shadow-lg">
                    <i class="fas fa-users text-white text-sm sm:text-base md:text-lg"></i>
                  </div>
                </div>
              </div>
            </div>
            <div class="h-1 bg-gradient-to-r from-primary-500 to-primary-600"></div>
          </div>
          
          <!-- Departments -->
          <div class="bg-white rounded-lg sm:rounded-xl shadow-sm border border-gray-100 dashboard-card overflow-hidden hover:shadow-md transition-shadow duration-300">
            <div class="p-3 sm:p-4 md:p-5 lg:p-6">
              <div class="flex items-start justify-between gap-2 sm:gap-3">
                <div class="flex-1 min-w-0">
                  <p class="text-xs sm:text-sm font-medium text-gray-600 mb-1.5 sm:mb-2 md:mb-3">Departments</p>
                  <div class="flex items-baseline gap-1 sm:gap-1.5 md:gap-2">
                    <h3 class="text-xl sm:text-2xl md:text-3xl font-bold text-gray-900">{{ dashboard_data.total_departments if dashboard_data else 0 }}</h3>
                  </div>
                  <p class="text-xs text-gray-500 mt-1 sm:mt-1.5 md:mt-2 truncate">
                    Active programs
                  </p>
                  <div class="w-full bg-gray-100 rounded-full h-1.5 mt-1.5 sm:mt-2 md:mt-3">
                    <div class="bg-gradient-to-r from-blue-500 to-blue-600 h-1.5 rounded-full transition-all duration-1000" style="width: 100%"></div>
                  </div>
                </div>
                <div class="flex-shrink-0">
                  <div class="w-9 h-9 sm:w-10 sm:h-10 md:w-12 md:h-12 rounded-lg bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center shadow-lg">
                    <i class="fas fa-building text-white text-sm sm:text-base md:text-lg"></i>
                  </div>
                </div>
              </div>
            </div>
            <div class="h-1 bg-gradient-to-r from-blue-500 to-blue-600"></div>
          </div>
          
          <!-- Evaluation Progress -->
          <div class="bg-white rounded-lg sm:rounded-xl shadow-sm border border-gray-100 dashboard-card overflow-hidden hover:shadow-md transition-shadow duration-300">
            <div class="p-3 sm:p-4 md:p-5 lg:p-6">
              <div class="flex items-start justify-between gap-2 sm:gap-3">
                <div class="flex-1 min-w-0">
                  <p class="text-xs sm:text-sm font-medium text-gray-600 mb-1.5 sm:mb-2 md:mb-3">Progress</p>
                  <div class="flex items-baseline gap-1 sm:gap-1.5 md:gap-2 flex-wrap">
                    <h3 class="text-xl sm:text-2xl md:text-3xl font-bold text-gray-900">{{ dashboard_data.completion_rate if dashboard_data else 0 }}%</h3>
                    {% if dashboard_data and dashboard_data.completion_rate > 0 %}
                    <span class="inline-flex items-center px-1.5 sm:px-2 py-0.5 rounded-md text-xs font-medium bg-green-50 text-green-700 whitespace-nowrap">
                      <i class="fas fa-arrow-up text-xs mr-1"></i>
                      {{ ((dashboard_data.completion_rate - 75)|round(1)) if dashboard_data.completion_rate > 75 else 0 }}%
                    </span>
                    {% endif %}
                  </div>
                  <p class="text-xs text-gray-500 mt-1 sm:mt-1.5 md:mt-2 truncate">
                    {{ dashboard_data.evaluated_faculty if dashboard_data else 0 }}/{{ dashboard_data.total_faculty if dashboard_data else 0 }} evaluated
                  </p>
                  <div class="w-full bg-gray-100 rounded-full h-1.5 mt-1.5 sm:mt-2 md:mt-3">
                    <div class="bg-gradient-to-r from-green-500 to-green-600 h-1.5 rounded-full transition-all duration-1000" id="completion-rate-bar"></div>
                  </div>
                </div>
                <div class="flex-shrink-0">
                  <div class="w-9 h-9 sm:w-10 sm:h-10 md:w-12 md:h-12 rounded-lg bg-gradient-to-br from-green-500 to-green-600 flex items-center justify-center shadow-lg">
                    <i class="fas fa-chart-line text-white text-sm sm:text-base md:text-lg"></i>
                  </div>
                </div>
              </div>
            </div>
            <div class="h-1 bg-gradient-to-r from-green-500 to-green-600"></div>
          </div>
          
          <!-- Average Rating -->
          <div class="bg-white rounded-lg sm:rounded-xl shadow-sm border border-gray-100 dashboard-card overflow-hidden hover:shadow-md transition-shadow duration-300">
            <div class="p-3 sm:p-4 md:p-5 lg:p-6">
              <div class="flex items-start justify-between gap-2 sm:gap-3">
                <div class="flex-1 min-w-0">
                  <p class="text-xs sm:text-sm font-medium text-gray-600 mb-1.5 sm:mb-2 md:mb-3">Avg Rating</p>
                  <div class="flex items-baseline gap-1 sm:gap-1.5 md:gap-2 flex-wrap">
                    <h3 class="text-xl sm:text-2xl md:text-3xl font-bold text-gray-900">{{ dashboard_data.average_rating if dashboard_data else 0.0 }}</h3>
                    <span class="text-xs sm:text-sm text-gray-500 font-medium">/5.0</span>
                    {% if dashboard_data and dashboard_data.average_rating > 0 %}
                    <span class="inline-flex items-center px-1.5 sm:px-2 py-0.5 rounded-md text-xs font-medium bg-yellow-50 text-yellow-700 whitespace-nowrap">
                      <i class="fas fa-arrow-up text-xs mr-1"></i>
                      {{ ((dashboard_data.average_rating - 4.1)|round(1)) if dashboard_data.average_rating > 4.1 else 0.0 }}
                    </span>
                    {% endif %}
                  </div>
                  <div class="flex items-center mt-1 sm:mt-1.5 md:mt-2 gap-0.5">
                    {% if dashboard_data and dashboard_data.average_rating > 0 %}
                    {% set full_stars = (dashboard_data.average_rating|round(0))|int %}
                    {% set has_half = (dashboard_data.average_rating - full_stars) >= 0.5 %}
                    {% for i in range(full_stars) %}
                    <i class="fas fa-star text-yellow-400 text-xs"></i>
                    {% endfor %}
                    {% if has_half %}
                    <i class="fas fa-star-half-alt text-yellow-400 text-xs"></i>
                    {% endif %}
                    {% for i in range(5 - full_stars - (1 if has_half else 0)) %}
                    <i class="far fa-star text-yellow-400 text-xs"></i>
                    {% endfor %}
                    {% else %}
                    <i class="far fa-star text-gray-300 text-xs"></i>
                    <i class="far fa-star text-gray-300 text-xs"></i>
                    <i class="far fa-star text-gray-300 text-xs"></i>
                    <i class="far fa-star text-gray-300 text-xs"></i>
                    <i class="far fa-star text-gray-300 text-xs"></i>
                    {% endif %}
                  </div>
                  <div class="w-full bg-gray-100 rounded-full h-1.5 mt-1.5 sm:mt-2 md:mt-3">
                    <div class="bg-gradient-to-r from-yellow-400 to-yellow-500 h-1.5 rounded-full transition-all duration-1000" id="average-rating-bar"></div>
                  </div>
                </div>
                <div class="flex-shrink-0">
                  <div class="w-9 h-9 sm:w-10 sm:h-10 md:w-12 md:h-12 rounded-lg bg-gradient-to-br from-yellow-400 to-yellow-500 flex items-center justify-center shadow-lg">
                    <i class="fas fa-star text-white text-sm sm:text-base md:text-lg"></i>
                  </div>
                </div>
              </div>
            </div>
            <div class="h-1 bg-gradient-to-r from-yellow-400 to-yellow-500"></div>
          </div>
        </div>
        
        <!-- Analytics Charts -->
        <div class="grid grid-cols-1 gap-3 sm:gap-4 md:gap-6 mb-4 md:mb-6">
          <!-- Performance Trends -->
          <div class="bg-white rounded-lg sm:rounded-xl shadow-sm border border-gray-100 dashboard-card hover:shadow-md transition-shadow duration-300">
            <div class="p-3 sm:p-4 md:p-5 lg:p-6 border-b border-gray-100">
              <div class="flex flex-col gap-3 sm:gap-4">
                <div class="flex-1 min-w-0">
                  <h3 class="text-sm sm:text-base md:text-lg font-semibold text-gray-900">Performance Trends</h3>
                  <p class="text-xs sm:text-sm text-gray-500 mt-0.5 sm:mt-1">Average ratings over evaluation periods</p>
                </div>
                <div class="flex flex-col gap-2 w-full">
                  <select id="trendTypeFilter" class="w-full px-3 py-2.5 text-xs sm:text-sm font-medium text-gray-700 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all min-h-[44px]">
                    <option value="department">By Department</option>
                    <option value="faculty">By Faculty</option>
                  </select>
                  <select id="periodFilter" class="w-full px-3 py-2.5 text-xs sm:text-sm font-medium text-gray-700 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all min-h-[44px]">
                    <option value="all">All Periods</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="p-3 sm:p-4 md:p-5 lg:p-6">
              <div class="w-full h-56 sm:h-64 md:h-72 lg:h-80">
                <canvas id="performanceTrendsChart"></canvas>
              </div>
            </div>
          </div>
          
          <!-- Faculty Rating Distribution -->
          <div class="bg-white rounded-lg sm:rounded-xl shadow-sm border border-gray-100 dashboard-card hover:shadow-md transition-shadow duration-300">
            <div class="p-3 sm:p-4 md:p-5 lg:p-6 border-b border-gray-100">
              <div class="flex flex-col gap-3 sm:gap-4">
                <div class="flex-1 min-w-0">
                  <h3 class="text-sm sm:text-base md:text-lg font-semibold text-gray-900">Faculty Rating Distribution</h3>
                  <p class="text-xs sm:text-sm text-gray-500 mt-0.5 sm:mt-1">Performance breakdown by rating ranges</p>
                </div>
                <div class="w-full">
                  <select id="departmentFilter" class="w-full px-3 py-2.5 text-xs sm:text-sm font-medium text-gray-700 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all min-h-[44px]">
                    <option value="all">All Departments</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="p-3 sm:p-4 md:p-5 lg:p-6">
              <div class="w-full h-56 sm:h-64 md:h-72 lg:h-80">
                <canvas id="ratingDistributionChart"></canvas>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Top Faculty Rankings -->
        <div class="bg-white rounded-lg sm:rounded-xl shadow-sm border border-gray-100 mb-4 md:mb-6 dashboard-card hover:shadow-md transition-shadow duration-300">
          <div class="p-3 sm:p-4 md:p-5 lg:p-6 border-b border-gray-100">
            <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-2 sm:gap-3">
              <div class="flex-1 min-w-0">
                <h3 class="text-sm sm:text-base md:text-lg font-semibold text-gray-900">Top Faculty Rankings</h3>
                <p class="text-xs sm:text-sm text-gray-500 mt-0.5 sm:mt-1">Highest performing faculty this period</p>
              </div>
              <a href="{{ url_for('guidance.rankings') }}" class="inline-flex items-center justify-center px-3 sm:px-4 py-2 text-xs sm:text-sm font-medium text-primary-600 bg-primary-50 rounded-lg hover:bg-primary-100 transition-colors duration-200 whitespace-nowrap min-h-[44px]">
                <span>View All</span>
                <i class="fas fa-arrow-right ml-1.5 sm:ml-2 text-xs"></i>
              </a>
            </div>
          </div>
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th scope="col" class="px-2 sm:px-3 md:px-4 lg:px-6 py-2 sm:py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                    Rank
                  </th>
                  <th scope="col" class="px-2 sm:px-3 md:px-4 lg:px-6 py-2 sm:py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                    Faculty
                  </th>
                  <th scope="col" class="hidden sm:table-cell px-2 sm:px-3 md:px-4 lg:px-6 py-2 sm:py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                    Department
                  </th>
                  <th scope="col" class="px-2 sm:px-3 md:px-4 lg:px-6 py-2 sm:py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                    Rating
                  </th>
                  <th scope="col" class="hidden md:table-cell px-2 sm:px-3 md:px-4 lg:px-6 py-2 sm:py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                    Trend
                  </th>
                  <th scope="col" class="hidden lg:table-cell px-2 sm:px-3 md:px-4 lg:px-6 py-2 sm:py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                    Evaluations
                  </th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-100">
                {% if dashboard_data and dashboard_data.faculty_rankings %}
                  {% for faculty in dashboard_data.faculty_rankings[:3] %}
                    {% set rank = loop.index %}
                    {% set bg_color = 'bg-gradient-to-r from-yellow-50 to-orange-50' if rank == 1 else ('bg-gradient-to-r from-gray-50 to-slate-50' if rank == 2 else 'bg-gradient-to-r from-orange-50 to-amber-50') %}
                    {% set medal_color = 'text-yellow-500' if rank == 1 else ('text-gray-400' if rank == 2 else 'text-orange-400') %}
                    {% set medal_icon = 'fa-trophy' if rank == 1 else 'fa-medal' %}
                    {% set initials = faculty.name.split()[0][0] + (faculty.name.split()[1][0] if faculty.name.split()|length > 1 else faculty.name.split()[0][1]) %}
                    <tr class="{{ bg_color }} hover:shadow-sm transition-all duration-200">
                      <td class="px-2 sm:px-3 md:px-4 lg:px-6 py-2.5 sm:py-3 md:py-4 whitespace-nowrap">
                        <div class="flex items-center gap-1">
                          <i class="fas {{ medal_icon }} {{ medal_color }} text-base sm:text-lg md:text-xl"></i>
                          <span class="text-xs sm:text-sm font-bold text-gray-900">{{ rank }}</span>
                        </div>
                      </td>
                      <td class="px-2 sm:px-3 md:px-4 lg:px-6 py-2.5 sm:py-3 md:py-4">
                        <div class="flex items-center gap-1.5 sm:gap-2 md:gap-3 min-w-0">
                          <div class="flex-shrink-0">
                            <div class="h-8 w-8 sm:h-9 sm:w-9 md:h-10 md:w-10 lg:h-11 lg:w-11 rounded-lg {% if rank == 1 %}bg-gradient-to-br from-yellow-400 to-orange-500{% elif rank == 2 %}bg-gradient-to-br from-gray-300 to-gray-400{% else %}bg-gradient-to-br from-orange-400 to-amber-500{% endif %} flex items-center justify-center shadow-md">
                              <span class="text-white font-bold text-xs sm:text-sm">{{ initials.upper() }}</span>
                            </div>
                          </div>
                          <div class="min-w-0 flex-1">
                            <div class="text-xs sm:text-sm font-semibold text-gray-900 truncate">{{ faculty.name }}</div>
                            <div class="text-xs text-gray-500 truncate sm:hidden">{{ faculty.department }}</div>
                          </div>
                        </div>
                      </td>
                      <td class="hidden sm:table-cell px-2 sm:px-3 md:px-4 lg:px-6 py-2.5 sm:py-3 md:py-4">
                        <div class="text-xs sm:text-sm font-medium text-gray-900 truncate max-w-[120px] sm:max-w-[150px] md:max-w-xs">{{ faculty.department }}</div>
                      </td>
                      <td class="px-2 sm:px-3 md:px-4 lg:px-6 py-2.5 sm:py-3 md:py-4 whitespace-nowrap">
                        <div class="flex flex-col gap-0.5 sm:gap-1">
                          <span class="text-sm sm:text-base md:text-lg font-bold text-green-600">{{ faculty.avg_rating|round(1) }}</span>
                          <div class="flex gap-0.5">
                            {% set full_stars = (faculty.avg_rating|round(0))|int %}
                            {% set has_half = (faculty.avg_rating - full_stars) >= 0.5 %}
                            {% for i in range(full_stars) %}
                              <i class="fas fa-star text-yellow-400 text-xs"></i>
                            {% endfor %}
                            {% if has_half %}
                              <i class="fas fa-star-half-alt text-yellow-400 text-xs"></i>
                            {% endif %}
                            {% for i in range(5 - full_stars - (1 if has_half else 0)) %}
                              <i class="far fa-star text-yellow-400 text-xs"></i>
                            {% endfor %}
                          </div>
                        </div>
                      </td>
                      <td class="hidden md:table-cell px-2 sm:px-3 md:px-4 lg:px-6 py-2.5 sm:py-3 md:py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2 sm:px-2.5 md:px-3 py-1 rounded-lg text-xs font-semibold bg-green-50 text-green-700 border border-green-200">
                          <i class="fas fa-arrow-up mr-1"></i>
                          +{{ ((faculty.avg_rating - 4.0)|round(1)) if faculty.avg_rating > 4.0 else 0.0 }}
                        </span>
                      </td>
                      <td class="hidden lg:table-cell px-2 sm:px-3 md:px-4 lg:px-6 py-2.5 sm:py-3 md:py-4 whitespace-nowrap">
                        <div class="text-xs sm:text-sm text-gray-600">
                          <span class="font-semibold text-gray-900">{{ faculty.evaluation_count }}</span> evals
                        </div>
                      </td>
                    </tr>
                  {% endfor %}
                {% else %}
                  <tr>
                    <td colspan="6" class="px-3 sm:px-4 md:px-6 py-8 sm:py-10 md:py-12 text-center">
                      <div class="flex flex-col items-center justify-center">
                        <div class="w-12 h-12 sm:w-14 sm:h-14 md:w-16 md:h-16 rounded-full bg-gray-100 flex items-center justify-center mb-2 sm:mb-3">
                          <i class="fas fa-chart-line text-gray-400 text-lg sm:text-xl md:text-2xl"></i>
                        </div>
                        <p class="text-xs sm:text-sm md:text-base text-gray-500 font-medium">No faculty rankings available yet</p>
                        <p class="text-xs sm:text-sm text-gray-400 mt-1">Evaluations are needed to generate rankings</p>
                      </div>
                    </td>
                  </tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>
      </main>
    
    </div>
  </div>

  <!-- Template data for JavaScript -->
  <script type="application/json" id="dashboard-data">
{
  "completionRate": {{ dashboard_data.completion_rate|tojson if dashboard_data else "0" }},
  "averageRating": {{ dashboard_data.average_rating|tojson if dashboard_data else "0" }},
  "chartLabels": {{ dashboard_data.chart_labels|tojson if dashboard_data and dashboard_data.chart_labels else '["Jan", "Feb", "Mar", "Apr", "May", "Jun"]'|safe }},
  "departmentStats": {{ dashboard_data.department_stats|tojson if dashboard_data and dashboard_data.department_stats else "[]" }},
  "ratingDistribution": {
    "labels": {{ dashboard_data.rating_distribution.labels|tojson if dashboard_data and dashboard_data.rating_distribution and dashboard_data.rating_distribution.labels else '["5.0", "4.5-4.9", "4.0-4.4", "3.5-3.9", "3.0-3.4", "Below 3.0"]'|safe }},
    "data": {{ dashboard_data.rating_distribution.data|tojson if dashboard_data and dashboard_data.rating_distribution and dashboard_data.rating_distribution.data else "[0, 0, 0, 0, 0, 0]" }}
  }
}
  </script>

  <script>
    // Hide loader when page is ready
    window.addEventListener('load', function() {
      setTimeout(function() {
        const overlay = document.getElementById('loader-overlay');
        overlay.style.opacity = '0';
        setTimeout(() => {
          overlay.style.display = 'none';
        }, 300);
      }, 500);
    });
  </script>

  <script>
    // Global variable to store rating distribution chart
    let ratingDistributionChart = null;
    let performanceTrendsChart = null;
    
    // Get dashboard data from JSON script tag
    function getDashboardData() {
      try {
        const dataElement = document.getElementById('dashboard-data');
        if (!dataElement) {
          console.warn('Dashboard data element not found');
          return null;
        }
        return JSON.parse(dataElement.textContent);
      } catch (error) {
        console.error('Error parsing dashboard data:', error);
        return null;
      }
    }
    
    // Initialize progress bars
    function initializeProgressBars() {
      const dashboardData = getDashboardData();
      if (!dashboardData) return;
      
      // Set completion rate bar width
      const completionRate = dashboardData.completionRate || 0;
      const completionRateBar = document.getElementById('completion-rate-bar');
      if (completionRateBar) {
        completionRateBar.style.width = completionRate + '%';
      }
      
      // Set average rating bar width (convert 5.0 scale to percentage)
      const avgRating = dashboardData.averageRating || 0;
      const avgRatingBar = document.getElementById('average-rating-bar');
      if (avgRatingBar) {
        avgRatingBar.style.width = ((avgRating / 5.0) * 100) + '%';
      }
      
      // Set department progress bars
      const progressBars = document.querySelectorAll('.progress-bar');
      progressBars.forEach(bar => {
        const width = bar.getAttribute('data-width');
        if (width) {
          setTimeout(() => {
            bar.style.width = width + '%';
          }, 100);
        }
      });
    }
    
    // Initialize charts
    function initializeCharts() {
      const dashboardData = getDashboardData();
      if (!dashboardData) return;
      
      // Initialize Performance Trends Chart (empty initially)
      const perfTrendsCtx = document.getElementById('performanceTrendsChart');
      if (perfTrendsCtx) {
        performanceTrendsChart = new Chart(perfTrendsCtx, {
          type: 'line',
          data: {
            labels: [],
            datasets: []
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom',
                labels: {
                  usePointStyle: true,
                  padding: window.innerWidth < 640 ? 8 : 15,
                  font: {
                    size: window.innerWidth < 640 ? 10 : 12
                  },
                  // Truncate long labels for mobile responsiveness
                  generateLabels: function(chart) {
                    const original = Chart.defaults.plugins.legend.labels.generateLabels;
                    const labels = original.call(this, chart);
                    
                    labels.forEach(label => {
                      if (label.text && label.text.length > 0) {
                        // Store original text for tooltip
                        label.fullText = label.text;
                        
                        // Get first two words only on mobile
                        if (window.innerWidth < 768) {
                          const words = label.text.split(' ');
                          if (words.length > 2) {
                            label.text = words.slice(0, 2).join(' ') + '...';
                          }
                          // On very small screens, limit to 18 characters
                          if (window.innerWidth < 480 && label.text.length > 18) {
                            label.text = label.text.substring(0, 15) + '...';
                          }
                        }
                      }
                    });
                    
                    return labels;
                  }
                }
              },
              tooltip: {
                mode: 'index',
                intersect: false,
                callbacks: {
                  label: function(context) {
                    return context.dataset.label + ': ' + context.parsed.y.toFixed(1) + '/5.0';
                  }
                }
              }
            },
            scales: {
              y: {
                beginAtZero: false,
                min: 0,
                max: 5.0,
                ticks: {
                  callback: function(value) {
                    return value.toFixed(1);
                  },
                  stepSize: 0.5,
                  font: {
                    size: window.innerWidth < 640 ? 9 : 11
                  }
                },
                grid: {
                  color: 'rgba(0, 0, 0, 0.05)'
                }
              },
              x: {
                grid: {
                  display: false
                },
                ticks: {
                  font: {
                    size: window.innerWidth < 640 ? 9 : 11
                  },
                  maxRotation: window.innerWidth < 640 ? 45 : 0,
                  minRotation: window.innerWidth < 640 ? 45 : 0,
                  // Truncate long period labels for mobile
                  callback: function(value, index, ticks) {
                    const label = this.getLabelForValue(value);
                    if (label && window.innerWidth < 768) {
                      const words = label.split(' ');
                      if (words.length > 2) {
                        return words.slice(0, 2).join(' ') + '...';
                      }
                      // On very small screens, limit to 20 characters
                      if (window.innerWidth < 480 && label.length > 20) {
                        return label.substring(0, 17) + '...';
                      }
                    }
                    return label;
                  }
                }
              }
            },
            interaction: {
              mode: 'nearest',
              axis: 'x',
              intersect: false
            }
          }
        });
        
        // Load initial data (by department, all periods)
        loadPerformanceTrends('department', 'all');
      }
      
      // Faculty Rating Distribution Chart
      const ratingDistCtx = document.getElementById('ratingDistributionChart');
      if (ratingDistCtx) {
        // Get rating distribution data from dashboard data
        const ratingLabels = dashboardData.ratingDistribution?.labels || ['5.0', '4.5-4.9', '4.0-4.4', '3.5-3.9', '3.0-3.4', 'Below 3.0'];
        const ratingData = dashboardData.ratingDistribution?.data || [0, 0, 0, 0, 0, 0];
        
        // Dynamic color generation based on rating ranges
        const generateColors = (labels) => {
          return labels.map(label => {
            if (label === '5.0') return 'rgba(34, 197, 94, 0.9)';
            if (label === '4.5-4.9') return 'rgba(74, 222, 128, 0.8)';
            if (label === '4.0-4.4') return 'rgba(59, 130, 246, 0.8)';
            if (label === '3.5-3.9') return 'rgba(251, 191, 36, 0.8)';
            if (label === '3.0-3.4') return 'rgba(249, 115, 22, 0.8)';
            if (label === 'Below 3.0') return 'rgba(239, 68, 68, 0.8)';
            return 'rgba(156, 163, 175, 0.8)';
          });
        };
        
        const generateBorderColors = (labels) => {
          return labels.map(label => {
            if (label === '5.0') return 'rgb(34, 197, 94)';
            if (label === '4.5-4.9') return 'rgb(74, 222, 128)';
            if (label === '4.0-4.4') return 'rgb(59, 130, 246)';
            if (label === '3.5-3.9') return 'rgb(251, 191, 36)';
            if (label === '3.0-3.4') return 'rgb(249, 115, 22)';
            if (label === 'Below 3.0') return 'rgb(239, 68, 68)';
            return 'rgb(156, 163, 175)';
          });
        };
        
        // Store chart in global variable for later updates
        ratingDistributionChart = new Chart(ratingDistCtx, {
          type: 'bar',
          data: {
            labels: ratingLabels,
            datasets: [{
              label: 'Number of Faculty',
              data: ratingData,
              backgroundColor: generateColors(ratingLabels),
              borderColor: generateBorderColors(ratingLabels),
              borderWidth: 2,
              borderRadius: 6,
              borderSkipped: false
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                callbacks: {
                  title: function(context) {
                    return 'Rating Range: ' + context[0].label;
                  },
                  label: function(context) {
                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                    const percentage = total > 0 ? ((context.parsed.y / total) * 100).toFixed(1) : 0;
                    return [
                      'Faculty Count: ' + context.parsed.y,
                      'Percentage: ' + percentage + '%'
                    ];
                  }
                },
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                padding: 12,
                titleFont: {
                  size: 14,
                  weight: 'bold'
                },
                bodyFont: {
                  size: 13
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 1,
                  callback: function(value) {
                    return Math.floor(value);
                  }
                },
                grid: {
                  color: 'rgba(0, 0, 0, 0.05)'
                },
                title: {
                  display: true,
                  text: 'Number of Faculty',
                  font: {
                    size: 12,
                    weight: 'bold'
                  }
                }
              },
              x: {
                grid: {
                  display: false
                },
                title: {
                  display: true,
                  text: 'Average Rating Range',
                  font: {
                    size: 12,
                    weight: 'bold'
                  }
                }
              }
            }
          }
        });
      }
    }
    
    // Load navigation
    $(document).ready(function() {
      loadGuidanceNavigation('guidance-dashboard');
      
      // Load departments for filter
      loadDepartments();
      
      // Load evaluation periods for filter
      loadEvaluationPeriods();
      
      // Initialize progress bars and charts after a short delay to ensure DOM is ready
      setTimeout(() => {
        initializeProgressBars();
        initializeCharts();
      }, 300);
      
      // Event listeners for trend chart filters
      $('#trendTypeFilter').on('change', function() {
        const trendType = $(this).val();
        const periodId = $('#periodFilter').val();
        loadPerformanceTrends(trendType, periodId);
      });
      
      $('#periodFilter').on('change', function() {
        const periodId = $(this).val();
        const trendType = $('#trendTypeFilter').val();
        loadPerformanceTrends(trendType, periodId);
      });
      
      // Handle window resize to update chart legend on orientation change
      let resizeTimer;
      $(window).on('resize', function() {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(function() {
          if (performanceTrendsChart) {
            // Update chart options for responsive font sizes and label formatting
            performanceTrendsChart.options.plugins.legend.labels.padding = window.innerWidth < 640 ? 8 : 15;
            performanceTrendsChart.options.plugins.legend.labels.font.size = window.innerWidth < 640 ? 10 : 12;
            performanceTrendsChart.options.scales.y.ticks.font.size = window.innerWidth < 640 ? 9 : 11;
            performanceTrendsChart.options.scales.x.ticks.font.size = window.innerWidth < 640 ? 9 : 11;
            performanceTrendsChart.options.scales.x.ticks.maxRotation = window.innerWidth < 640 ? 45 : 0;
            performanceTrendsChart.options.scales.x.ticks.minRotation = window.innerWidth < 640 ? 45 : 0;
            performanceTrendsChart.update();
          }
        }, 250);
      });
    });
    
    // Load evaluation periods for period filter
    function loadEvaluationPeriods() {
      $.ajax({
        url: '/api/guidance/evaluation-periods',
        method: 'GET',
        success: function(response) {
          if (response.success && response.periods) {
            const select = $('#periodFilter');
            response.periods.forEach(period => {
              const displayText = period.period_name || period.academic_year || 'Unknown Period';
              select.append(`<option value="${period.period_id}">${displayText}</option>`);
            });
          }
        },
        error: function(xhr, status, error) {
          console.error('Error loading evaluation periods:', error);
        }
      });
    }
    
    // Load performance trends data
    function loadPerformanceTrends(trendType, periodId) {
      if (!performanceTrendsChart) return;
      
      $.ajax({
        url: '/api/guidance/performance-trends',
        method: 'GET',
        data: {
          trend_type: trendType,
          period_id: periodId
        },
        success: function(response) {
          if (response.success) {
            // Update chart data
            performanceTrendsChart.data.labels = response.labels || [];
            performanceTrendsChart.data.datasets = response.datasets || [];
            
            // Update y-axis scale based on data
            if (response.datasets && response.datasets.length > 0) {
              const allValues = response.datasets.flatMap(ds => ds.data.filter(v => v !== null));
              if (allValues.length > 0) {
                const minVal = Math.min(...allValues);
                const maxVal = Math.max(...allValues);
                performanceTrendsChart.options.scales.y.min = Math.max(0, Math.floor(minVal - 0.5));
                performanceTrendsChart.options.scales.y.max = Math.min(5, Math.ceil(maxVal + 0.5));
              }
            }
            
            performanceTrendsChart.update();
          } else {
            console.error('Error loading performance trends:', response.message);
          }
        },
        error: function(xhr, status, error) {
          console.error('AJAX Error loading performance trends:', error);
        }
      });
    }
    
    // Load departments into filter dropdown
    function loadDepartments() {
      $.ajax({
        url: '/api/guidance/departments-list',
        method: 'GET',
        success: function(response) {
          if (response.success && response.departments) {
            const select = $('#departmentFilter');
            response.departments.forEach(dept => {
              select.append(`<option value="${dept}">${dept}</option>`);
            });
            
            // Add change event listener
            select.on('change', function() {
              const department = $(this).val();
              updateRatingDistribution(department);
            });
          }
        },
        error: function(xhr, status, error) {
          console.error('Error loading departments:', error);
        }
      });
    }
    
    // Update rating distribution chart with filtered data
    function updateRatingDistribution(department) {
      $.ajax({
        url: '/api/guidance/rating-distribution',
        method: 'GET',
        data: { department: department },
        success: function(response) {
          if (response.success && ratingDistributionChart) {
            // Update chart data
            ratingDistributionChart.data.labels = response.labels;
            ratingDistributionChart.data.datasets[0].data = response.data;
            
            // Update colors based on new labels
            const generateColors = (labels) => {
              return labels.map(label => {
                if (label === '5.0') return 'rgba(34, 197, 94, 0.9)';
                if (label === '4.5-4.9') return 'rgba(74, 222, 128, 0.8)';
                if (label === '4.0-4.4') return 'rgba(59, 130, 246, 0.8)';
                if (label === '3.5-3.9') return 'rgba(251, 191, 36, 0.8)';
                if (label === '3.0-3.4') return 'rgba(249, 115, 22, 0.8)';
                if (label === 'Below 3.0') return 'rgba(239, 68, 68, 0.8)';
                return 'rgba(156, 163, 175, 0.8)';
              });
            };
            
            const generateBorderColors = (labels) => {
              return labels.map(label => {
                if (label === '5.0') return 'rgb(34, 197, 94)';
                if (label === '4.5-4.9') return 'rgb(74, 222, 128)';
                if (label === '4.0-4.4') return 'rgb(59, 130, 246)';
                if (label === '3.5-3.9') return 'rgb(251, 191, 36)';
                if (label === '3.0-3.4') return 'rgb(249, 115, 22)';
                if (label === 'Below 3.0') return 'rgb(239, 68, 68)';
                return 'rgb(156, 163, 175)';
              });
            };
            
            ratingDistributionChart.data.datasets[0].backgroundColor = generateColors(response.labels);
            ratingDistributionChart.data.datasets[0].borderColor = generateBorderColors(response.labels);
            
            // Update chart
            ratingDistributionChart.update();
            
            // Show success message
            console.log(`Updated chart for ${response.department} (${response.total_faculty} faculty)`);
          }
        },
        error: function(xhr, status, error) {
          console.error('Error updating rating distribution:', error);
        }
      });
    }
  </script>
  
  <!-- Prevent logout on browser back button -->
  <script src="{{ url_for('static', filename='js/prevent-back-logout.js') }}"></script>

  <!-- Session Timeout Monitor (Auto-logout after 1 hour) -->
  <script src="{{ url_for('static', filename='js/session-timeout.js') }}"></script>
</body>
</html>
