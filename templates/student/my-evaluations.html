<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>My Evaluations | IntellEvalPro</title>
  
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/nclogo.png') }}">
  <link rel="shortcut icon" type="image/png" href="{{ url_for('static', filename='images/nclogo.png') }}">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='images/nclogo.png') }}">

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  
  <!-- SweetAlert2 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.12/dist/sweetalert2.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.12/dist/sweetalert2.all.min.js"></script>
  
  <script>
    tailwind.config = {
      theme: {
        fontFamily: {
          'sans': ['Inter', 'system-ui', 'sans-serif'],
        },
        extend: {
          colors: {
            primary: {
              50: '#e6f0ff',
              100: '#b3d1ff',
              200: '#80b3ff',
              300: '#4d94ff', 
              400: '#1a75ff',
              500: '#0059cc',
              600: '#004db3',
              700: '#004099',
              800: '#003380',
              900: '#002966'
            }
          }
        }
      }
    }
  </script>
  
  <style>
    /* Mobile responsive styles */
    @media (max-width: 768px) {
      .stat-card {
        transition: all 0.3s ease;
      }
      
      .stat-card:active {
        transform: scale(0.98);
      }
    }
    
    /* Mobile table card layout */
    .mobile-eval-card {
      transition: all 0.2s ease;
    }
    
    .mobile-eval-card:active {
      background-color: #f9fafb;
    }
    
    /* Responsive scrollbar */
    @media (max-width: 768px) {
      ::-webkit-scrollbar {
        width: 4px;
        height: 4px;
      }
    }
    
    /* Ensure proper text wrapping on mobile */
    @media (max-width: 640px) {
      .mobile-eval-card {
        font-size: 0.875rem;
      }
      
      .mobile-eval-card h4 {
        font-size: 0.875rem;
        line-height: 1.25rem;
      }
      
      /* Better touch targets for mobile */
      select, input, button {
        min-height: 44px;
      }
      
      /* Prevent text overflow */
      .truncate {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
    }
    
    /* Tablet optimization */
    @media (min-width: 641px) and (max-width: 1023px) {
      .stat-card {
        padding: 1.25rem;
      }
    }
    
    /* Line clamp utility for multi-line truncation */
    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
  </style>
</head>
<body class="bg-gray-50">
  <div class="min-h-screen flex">
    <!-- Sidebar Navigation -->
    <div id="sidebar-container"></div>
    
    <!-- Main content -->
    <div class="flex-1 lg:ml-64">
      <!-- Header -->
      <div id="header-container"></div>
      
      <!-- Page Content -->
      <main class="p-3 sm:p-4 md:p-6">
        <!-- Page Title -->
        <div class="mb-4 sm:mb-6">
          <h1 class="text-xl sm:text-2xl md:text-3xl font-bold text-gray-900 mb-2">My Evaluations</h1>
          <p class="text-xs sm:text-sm md:text-base text-gray-600">View your evaluation history and track your feedback submissions</p>
        </div>

        <!-- Evaluation Statistics Cards -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4 md:gap-6 mb-4 sm:mb-6">
          <!-- Total Evaluations -->
          <div class="bg-white rounded-lg sm:rounded-xl shadow-sm border border-gray-200 p-4 sm:p-5 md:p-6 stat-card hover:shadow-md transition-shadow">
            <div class="flex items-center">
              <div class="p-2 sm:p-3 rounded-lg bg-blue-100 flex-shrink-0">
                <i class="fas fa-clipboard-list text-blue-600 text-base sm:text-lg md:text-xl"></i>
              </div>
              <div class="ml-3 sm:ml-4 min-w-0 flex-1">
                <p class="text-xs sm:text-sm text-gray-600 mb-0.5 sm:mb-1 truncate">Total Evaluations</p>
                <p class="text-xl sm:text-2xl md:text-3xl font-bold text-gray-900" id="total-evaluations">0</p>
              </div>
            </div>
          </div>

          <!-- Completed Evaluations -->
          <div class="bg-white rounded-lg sm:rounded-xl shadow-sm border border-gray-200 p-4 sm:p-5 md:p-6 stat-card hover:shadow-md transition-shadow">
            <div class="flex items-center">
              <div class="p-2 sm:p-3 rounded-lg bg-green-100 flex-shrink-0">
                <i class="fas fa-check-circle text-green-600 text-base sm:text-lg md:text-xl"></i>
              </div>
              <div class="ml-3 sm:ml-4 min-w-0 flex-1">
                <p class="text-xs sm:text-sm text-gray-600 mb-0.5 sm:mb-1 truncate">Completed</p>
                <p class="text-xl sm:text-2xl md:text-3xl font-bold text-gray-900" id="completed-evaluations">0</p>
              </div>
            </div>
          </div>

          <!-- Pending Evaluations -->
          <div class="bg-white rounded-lg sm:rounded-xl shadow-sm border border-gray-200 p-4 sm:p-5 md:p-6 stat-card hover:shadow-md transition-shadow">
            <div class="flex items-center">
              <div class="p-2 sm:p-3 rounded-lg bg-orange-100 flex-shrink-0">
                <i class="fas fa-clock text-orange-600 text-base sm:text-lg md:text-xl"></i>
              </div>
              <div class="ml-3 sm:ml-4 min-w-0 flex-1">
                <p class="text-xs sm:text-sm text-gray-600 mb-0.5 sm:mb-1 truncate">Pending</p>
                <p class="text-xl sm:text-2xl md:text-3xl font-bold text-gray-900" id="pending-evaluations">0</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Filters -->
        <div class="bg-white rounded-lg sm:rounded-xl shadow-sm border border-gray-200 p-4 sm:p-5 md:p-6 mb-4 sm:mb-6">
          <h3 class="text-base sm:text-lg font-semibold text-gray-900 mb-3 sm:mb-4">Filter Evaluations</h3>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4">
            <!-- Academic Year Filter -->
            <div>
              <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1.5 sm:mb-2">Academic Year</label>
              <select id="academic-year-filter" class="w-full px-3 py-2.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 bg-white">
                <option value="">All Academic Years</option>
              </select>
            </div>

            <!-- Status Filter -->
            <div>
              <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1.5 sm:mb-2">Status</label>
              <select id="status-filter" class="w-full px-3 py-2.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 bg-white">
                <option value="">All Status</option>
                <option value="Completed">Completed</option>
                <option value="Pending">Pending</option>
                <option value="In Progress">In Progress</option>
              </select>
            </div>

            <!-- Search -->
            <div>
              <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1.5 sm:mb-2">Search</label>
              <input type="text" id="search-input" placeholder="Search faculty or course..." class="w-full px-3 py-2.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
            </div>
          </div>
        </div>

        <!-- Evaluations List -->
        <div class="bg-white rounded-lg sm:rounded-xl shadow-sm border border-gray-200 overflow-hidden">
          <div class="p-4 sm:p-5 md:p-6 border-b border-gray-200">
            <h3 class="text-base sm:text-lg font-semibold text-gray-900">Evaluation History</h3>
          </div>
          
          <!-- Loading State -->
          <div id="loading-state" class="p-8 sm:p-12 text-center">
            <div class="inline-block animate-spin rounded-full h-10 w-10 sm:h-12 sm:w-12 border-b-2 border-primary-600"></div>
            <p class="mt-3 sm:mt-4 text-sm sm:text-base text-gray-600">Loading evaluations...</p>
          </div>

          <!-- Empty State -->
          <div id="empty-state" class="hidden p-8 sm:p-12 text-center">
            <i class="fas fa-clipboard-list text-gray-300 text-4xl sm:text-5xl md:text-6xl mb-4"></i>
            <h3 class="text-base sm:text-lg md:text-xl font-medium text-gray-900 mb-2">No Evaluations Found</h3>
            <p class="text-sm sm:text-base text-gray-600 max-w-md mx-auto">No evaluations match your current filters. Try adjusting your search criteria.</p>
          </div>

          <!-- Desktop Table View (hidden on mobile) -->
          <div id="evaluations-table-desktop" class="hidden">
            <div class="hidden md:block overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-4 lg:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Course & Faculty</th>
                    <th class="px-4 lg:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Evaluation Period</th>
                    <th class="px-4 lg:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                    <th class="px-4 lg:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Completion Date</th>
                  </tr>
                </thead>
                <tbody id="evaluations-tbody" class="bg-white divide-y divide-gray-200">
                  <!-- Dynamic content will be inserted here -->
                </tbody>
              </table>
            </div>
            
            <!-- Mobile Card View (visible on mobile only) -->
            <div class="md:hidden">
              <div id="evaluations-mobile-container" class="divide-y divide-gray-200">
                <!-- Dynamic mobile cards will be inserted here -->
              </div>
            </div>
          </div>

          <!-- Results Summary -->
          <div id="results-summary" class="hidden px-4 sm:px-5 md:px-6 py-3 sm:py-4 border-t border-gray-200 bg-gray-50">
            <p class="text-xs sm:text-sm text-gray-600 text-center">
              Showing <span class="font-semibold text-gray-900" id="results-count">0</span> of <span class="font-semibold text-gray-900" id="total-count">0</span> completed evaluations
            </p>
          </div>
        </div>
      </main>
      
      <!-- Footer -->
      <div id="footer-container"></div>
    </div>
  </div>

  <!-- Overlay for mobile sidebar -->
  <div id="sidebar-overlay" class="fixed inset-0 z-30 bg-black bg-opacity-50 hidden lg:hidden"></div>

  <!-- Include loading animation and unified navigation scripts -->
  <script src="{{ url_for('static', filename='js/loading-animation.js') }}"></script>
  <script src="{{ url_for('static', filename='js/student-navigation-unified.js') }}"></script>
  
  <!-- Prevent logout on browser back button -->
  <script src="{{ url_for('static', filename='js/prevent-back-logout.js') }}"></script>

  <!-- Session Timeout Monitor (Auto-logout after 1 hour) -->
  <script src="{{ url_for('static', filename='js/session-timeout.js') }}"></script>
  
  <script>
    // Initialize navigation for my evaluations page
    loadStudentNavigation('my-evaluations');
    
    // Page-specific functionality
    $(document).ready(function() {
      // Load filter options first (will trigger data load with current year)
      loadFilterOptions();

      // Automatic filtering on change events
      $('#status-filter, #academic-year-filter').on('change', function() {
        loadEvaluationsData();
      });

      // Real-time search with debounce
      let searchTimeout;
      $('#search-input').on('keyup', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(function() {
          loadEvaluationsData();
        }, 500); // 500ms debounce delay
      });
    });

    function updateBreadcrumb(pageName) {
      $('#current-page').text(pageName);
    }

    function initializeMobileMenu() {
      const menuToggle = $('#menu-toggle');
      const sidebar = $('#sidebar');
      const overlay = $('#sidebar-overlay');

      menuToggle.click(function() {
        sidebar.toggleClass('-translate-x-full');
        overlay.toggle();
      });

      overlay.click(function() {
        sidebar.addClass('-translate-x-full');
        overlay.hide();
      });
    }

    function loadFilterOptions() {
      // Load academic years for filter
      $.get('/api/academic-years', function(data) {
        if (data.success && data.data) {
          const academicYearFilter = $('#academic-year-filter');
          let currentYearId = null;
          
          data.data.forEach(year => {
            academicYearFilter.append(`<option value="${year.acad_year_id}">${year.year_name}</option>`);
            
            // Find the current academic year
            if (year.is_current === 1 || year.is_current === true) {
              currentYearId = year.acad_year_id;
            }
          });
          
          // Set current year as selected
          if (currentYearId) {
            academicYearFilter.val(currentYearId);
            // Trigger change to load data with current year filter
            loadEvaluationsData();
          }
        }
      }).fail(function(xhr, status, error) {
        console.error('Failed to load academic years:', error);
      });
    }

    function loadEvaluationsData() {
      $('#loading-state').show();
      $('#empty-state').hide();
      $('#evaluations-table-desktop').hide();

      const filters = {
        status: $('#status-filter').val(),
        academic_year: $('#academic-year-filter').val(),
        search: $('#search-input').val()
      };

      $.get('/api/student/my-evaluations', filters, function(data) {
        $('#loading-state').hide();
        
        if (data.success) {
          updateStatistics(data.stats);
          
          if (data.evaluations && data.evaluations.length > 0) {
            renderEvaluationsTable(data.evaluations);
            renderEvaluationsMobile(data.evaluations);
            $('#evaluations-table-desktop').show();
            
            // Update results summary
            $('#results-count').text(data.evaluations.length);
            $('#total-count').text(data.stats.total || 0);
            $('#results-summary').show();
          } else {
            $('#empty-state').show();
            $('#results-summary').hide();
          }
        } else {
          $('#empty-state').show();
          $('#results-summary').hide();
          console.error('Error loading evaluations:', data.message);
        }
      }).fail(function() {
        $('#loading-state').hide();
        $('#empty-state').show();
        $('#results-summary').hide();
        console.error('Failed to load evaluations');
      });
    }

    function updateStatistics(stats) {
      $('#total-evaluations').text(stats.total || 0);
      $('#completed-evaluations').text(stats.completed || 0);
      $('#pending-evaluations').text(stats.pending || 0);
    }

    function renderEvaluationsTable(evaluations) {
      const tbody = $('#evaluations-tbody');
      tbody.empty();

      evaluations.forEach(evaluation => {
        const statusBadge = getStatusBadge(evaluation.status);
        const completionDate = evaluation.completion_time ? 
          new Date(evaluation.completion_time).toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'short', 
            day: 'numeric' 
          }) : '-';
        
        const row = `
          <tr class="hover:bg-gray-50 transition-colors">
            <td class="px-4 lg:px-6 py-4">
              <div>
                <div class="text-sm font-medium text-gray-900 mb-1">${evaluation.course_code} - ${evaluation.course_title}</div>
                <div class="text-sm text-gray-600 mb-0.5">
                  <i class="fas fa-user text-gray-400 mr-1"></i>${evaluation.faculty_name}
                </div>
                <div class="text-xs text-gray-500">
                  <i class="fas fa-door-open text-gray-400 mr-1"></i>${evaluation.section_name} | ${evaluation.room}
                </div>
              </div>
            </td>
            <td class="px-4 lg:px-6 py-4">
              <div class="text-sm text-gray-900 font-medium mb-1">${evaluation.period_title}</div>
              <div class="text-xs text-gray-500">
                <i class="far fa-calendar-alt text-gray-400 mr-1"></i>${formatDateRange(evaluation.period_start, evaluation.period_end)}
              </div>
            </td>
            <td class="px-4 lg:px-6 py-4">${statusBadge}</td>
            <td class="px-4 lg:px-6 py-4">
              <div class="text-sm text-gray-900">${completionDate}</div>
            </td>
          </tr>
        `;
        tbody.append(row);
      });
    }

    function renderEvaluationsMobile(evaluations) {
      const container = $('#evaluations-mobile-container');
      container.empty();

      evaluations.forEach(evaluation => {
        const statusBadge = getStatusBadge(evaluation.status);
        const completionDate = evaluation.completion_time ? 
          new Date(evaluation.completion_time).toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'short', 
            day: 'numeric' 
          }) : 'Not completed';
        
        const card = `
          <div class="p-4 mobile-eval-card">
            <div class="flex items-start justify-between mb-3">
              <div class="flex-1 min-w-0 pr-3">
                <h4 class="text-sm font-semibold text-gray-900 mb-1.5 line-clamp-2">
                  ${evaluation.course_code}
                </h4>
                <p class="text-xs text-gray-700 mb-1 truncate">
                  ${evaluation.course_title}
                </p>
                <p class="text-xs text-gray-600 mb-1 flex items-center">
                  <i class="fas fa-user text-gray-400 mr-1.5 flex-shrink-0"></i>
                  <span class="truncate">${evaluation.faculty_name}</span>
                </p>
                <p class="text-xs text-gray-500 flex items-center">
                  <i class="fas fa-door-open text-gray-400 mr-1.5 flex-shrink-0"></i>
                  <span class="truncate">${evaluation.section_name} | ${evaluation.room}</span>
                </p>
              </div>
              <div class="flex-shrink-0">
                ${statusBadge}
              </div>
            </div>
            <div class="space-y-2 text-xs pt-3 border-t border-gray-100">
              <div class="flex items-center justify-between gap-2">
                <span class="text-gray-500 flex items-center flex-shrink-0">
                  <i class="fas fa-calendar text-gray-400 mr-1.5"></i>Period:
                </span>
                <span class="text-gray-900 font-medium text-right truncate">${evaluation.period_title}</span>
              </div>
              <div class="flex items-center justify-between gap-2">
                <span class="text-gray-500 flex items-center flex-shrink-0">
                  <i class="far fa-calendar-alt text-gray-400 mr-1.5"></i>Duration:
                </span>
                <span class="text-gray-700 text-right text-xs truncate">${formatDateRange(evaluation.period_start, evaluation.period_end)}</span>
              </div>
              <div class="flex items-center justify-between gap-2">
                <span class="text-gray-500 flex items-center flex-shrink-0">
                  <i class="fas fa-check-circle text-gray-400 mr-1.5"></i>Completed:
                </span>
                <span class="text-gray-900 text-right truncate">${completionDate}</span>
              </div>
            </div>
          </div>
        `;
        container.append(card);
      });
    }

    function getStatusBadge(status) {
      const badges = {
        'Completed': '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800 whitespace-nowrap"><i class="fas fa-check-circle mr-1"></i>Completed</span>',
        'Pending': '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-orange-100 text-orange-800 whitespace-nowrap"><i class="fas fa-clock mr-1"></i>Pending</span>',
        'In Progress': '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800 whitespace-nowrap"><i class="fas fa-spinner mr-1"></i>In Progress</span>'
      };
      return badges[status] || `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800 whitespace-nowrap">${status}</span>`;
    }

    function formatDateRange(startDate, endDate) {
      const options = { month: 'short', day: 'numeric', year: 'numeric' };
      const start = new Date(startDate).toLocaleDateString('en-US', options);
      const end = new Date(endDate).toLocaleDateString('en-US', options);
      return `${start} - ${end}`;
    }
  </script>
</body>
</html>